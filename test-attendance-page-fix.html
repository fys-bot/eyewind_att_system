<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒå‹¤é¡µé¢ä¿®å¤éªŒè¯</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f8fafc;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .log { 
            background: #f1f5f9; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #059669; }
        .info { color: #0284c7; }
        .warning { color: #d97706; }
        .error { color: #dc2626; }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
        button:hover {
            background: #f9fafb;
        }
        .fix-highlight {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è€ƒå‹¤é¡µé¢åŠ è½½é—®é¢˜ä¿®å¤éªŒè¯</h1>
        
        <div class="fix-highlight">
            <h3>ğŸ”§ ä¿®å¤å†…å®¹</h3>
            <ul>
                <li><strong>é—®é¢˜1:</strong> loadDataå‡½æ•°ç¼ºå°‘globalMonthä¾èµ–é¡¹ï¼Œå¯¼è‡´é—­åŒ…é—®é¢˜</li>
                <li><strong>ä¿®å¤1:</strong> åœ¨loadDataçš„useCallbackä¾èµ–é¡¹ä¸­æ·»åŠ globalMonth</li>
                <li><strong>é—®é¢˜2:</strong> globalMonthå˜åŒ–æ—¶çš„useEffectåŒ…å«loadDataä¾èµ–ï¼Œå¯¼è‡´æ— é™å¾ªç¯</li>
                <li><strong>ä¿®å¤2:</strong> ç§»é™¤loadDataä¾èµ–ï¼Œé¿å…æ— é™å¾ªç¯</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h3>APIè°ƒç”¨åºåˆ—æµ‹è¯•</h3>
            <p>æµ‹è¯•å®Œæ•´çš„APIè°ƒç”¨åºåˆ—ï¼šToken â†’ Employee â†’ Load</p>
            <button onclick="testFullApiSequence()">æµ‹è¯•å®Œæ•´APIåºåˆ—</button>
            <button onclick="testWithDifferentMonths()">æµ‹è¯•ä¸åŒæœˆä»½</button>
            <button onclick="testErrorHandling()">æµ‹è¯•é”™è¯¯å¤„ç†</button>
        </div>
        
        <div class="test-section">
            <h3>å‰ç«¯é€»è¾‘éªŒè¯</h3>
            <button onclick="simulatePageLoad()">æ¨¡æ‹Ÿé¡µé¢åŠ è½½</button>
            <button onclick="simulateMonthChange()">æ¨¡æ‹Ÿæœˆä»½åˆ‡æ¢</button>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div id="logs"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testFullApiSequence() {
            log('ğŸš€ å¼€å§‹æµ‹è¯•å®Œæ•´APIè°ƒç”¨åºåˆ—...', 'info');
            
            try {
                // 1. æµ‹è¯•Token API
                log('1ï¸âƒ£ æµ‹è¯•Token API...', 'info');
                const tokenResponse = await fetch('/api/v1/auth/token');
                if (tokenResponse.ok) {
                    log('âœ… Token APIè°ƒç”¨æˆåŠŸ', 'success');
                } else {
                    log(`âŒ Token APIè°ƒç”¨å¤±è´¥: ${tokenResponse.status}`, 'error');
                    return;
                }
                
                // 2. æµ‹è¯•Employee API
                log('2ï¸âƒ£ æµ‹è¯•Employee API...', 'info');
                const employeeResponse = await fetch('/api/v1/employees');
                if (employeeResponse.ok) {
                    const employees = await employeeResponse.json();
                    log(`âœ… Employee APIè°ƒç”¨æˆåŠŸï¼Œè·å–åˆ° ${employees.length || 0} ä¸ªå‘˜å·¥`, 'success');
                } else {
                    log(`âŒ Employee APIè°ƒç”¨å¤±è´¥: ${employeeResponse.status}`, 'error');
                    return;
                }
                
                // 3. æµ‹è¯•Load API (å½“å‰æœˆä»½)
                log('3ï¸âƒ£ æµ‹è¯•Load API (å½“å‰æœˆä»½)...', 'info');
                const currentMonth = '2026-01';
                const loadUrl = `/api/v1/attendance/status/load/${currentMonth}`;
                log(`è¯·æ±‚URL: ${loadUrl}`, 'info');
                
                const loadResponse = await fetch(loadUrl, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                log(`Load APIå“åº”çŠ¶æ€: ${loadResponse.status}`, 'info');
                
                if (loadResponse.ok) {
                    const loadData = await loadResponse.json();
                    log('âœ… Load APIè°ƒç”¨æˆåŠŸ', 'success');
                    if (loadData.data) {
                        log(`âœ… è¿”å›æ•°æ®åŒ…å« ${Object.keys(loadData.data).length} ä¸ªæœˆä»½`, 'success');
                    }
                } else if (loadResponse.status === 404) {
                    const errorData = await loadResponse.json();
                    log('â„¹ï¸ Load APIè¿”å›404 - å½“å‰æœˆä»½æ— æ•°æ®ï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µ', 'warning');
                    log(`404å“åº”: ${errorData.message}`, 'info');
                } else {
                    log(`âŒ Load APIè°ƒç”¨å¤±è´¥: ${loadResponse.status}`, 'error');
                }
                
                log('ğŸ‰ APIè°ƒç”¨åºåˆ—æµ‹è¯•å®Œæˆï¼', 'success');
                
            } catch (error) {
                log(`âŒ APIè°ƒç”¨åºåˆ—æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function testWithDifferentMonths() {
            log('ğŸ—“ï¸ å¼€å§‹æµ‹è¯•ä¸åŒæœˆä»½çš„Load API...', 'info');
            
            const months = ['2026-01', '2025-12', '2025-11', '2024-01'];
            
            for (const month of months) {
                try {
                    log(`æµ‹è¯•æœˆä»½: ${month}`, 'info');
                    const url = `/api/v1/attendance/status/load/${month}`;
                    const response = await fetch(url);
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(`âœ… ${month}: æˆåŠŸ (${response.status})`, 'success');
                        if (data.data) {
                            log(`   æ•°æ®æœˆä»½: ${Object.keys(data.data).join(', ')}`, 'info');
                        }
                    } else if (response.status === 404) {
                        log(`â„¹ï¸ ${month}: æ— æ•°æ® (404)`, 'warning');
                    } else {
                        log(`âŒ ${month}: å¤±è´¥ (${response.status})`, 'error');
                    }
                } catch (error) {
                    log(`âŒ ${month}: å¼‚å¸¸ - ${error.message}`, 'error');
                }
            }
        }

        async function testErrorHandling() {
            log('ğŸ›¡ï¸ å¼€å§‹æµ‹è¯•é”™è¯¯å¤„ç†...', 'info');
            
            // æµ‹è¯•æ— æ•ˆæœˆä»½æ ¼å¼
            const invalidMonths = ['invalid-month', '2026-13', '2026-00', 'abc'];
            
            for (const month of invalidMonths) {
                try {
                    log(`æµ‹è¯•æ— æ•ˆæœˆä»½: ${month}`, 'info');
                    const url = `/api/v1/attendance/status/load/${month}`;
                    const response = await fetch(url);
                    
                    log(`${month}: çŠ¶æ€ç  ${response.status}`, response.ok ? 'warning' : 'info');
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        log(`   é”™è¯¯ä¿¡æ¯: ${errorData.message || 'æ— é”™è¯¯ä¿¡æ¯'}`, 'info');
                    }
                } catch (error) {
                    log(`${month}: ç½‘ç»œå¼‚å¸¸ - ${error.message}`, 'error');
                }
            }
        }

        function simulatePageLoad() {
            log('ğŸ“± æ¨¡æ‹Ÿè€ƒå‹¤é¡µé¢åŠ è½½è¿‡ç¨‹...', 'info');
            
            // æ¨¡æ‹Ÿç»„ä»¶çŠ¶æ€
            let hasInitialized = false;
            let globalMonth = '2026-01';
            let isLoading = true;
            
            log('1. ç»„ä»¶æŒ‚è½½ï¼ŒuseEffectæ‰§è¡Œ', 'info');
            log(`   hasInitialized: ${hasInitialized}`, 'info');
            log(`   globalMonth: ${globalMonth}`, 'info');
            
            if (!hasInitialized) {
                hasInitialized = true;
                log('2. é¦–æ¬¡åŠ è½½ï¼Œå¼€å§‹æ‰§è¡ŒloadData', 'info');
                log(`   ç”ŸæˆURL: /api/v1/attendance/status/load/${globalMonth}`, 'info');
                
                // æ¨¡æ‹ŸAPIè°ƒç”¨
                setTimeout(() => {
                    isLoading = false;
                    log('3. APIè°ƒç”¨å®Œæˆï¼Œè®¾ç½®loadingä¸ºfalse', 'success');
                    log('âœ… é¡µé¢åŠ è½½æµç¨‹æ­£å¸¸', 'success');
                }, 1000);
            }
        }

        function simulateMonthChange() {
            log('ğŸ”„ æ¨¡æ‹Ÿæœˆä»½åˆ‡æ¢è¿‡ç¨‹...', 'info');
            
            let hasInitialized = true;
            let oldMonth = '2026-01';
            let newMonth = '2025-12';
            
            log(`1. æœˆä»½å˜åŒ–: ${oldMonth} -> ${newMonth}`, 'info');
            log('2. globalMonth useEffectè§¦å‘', 'info');
            log(`   hasInitialized: ${hasInitialized}`, 'info');
            log(`   æ–°æœˆä»½: ${newMonth}`, 'info');
            
            if (hasInitialized && newMonth) {
                log('3. æ»¡è¶³é‡æ–°åŠ è½½æ¡ä»¶', 'info');
                log('4. æ¸…é™¤ç¼“å­˜', 'info');
                log('5. é‡ç½®hasInitializedä¸ºfalse', 'info');
                log('6. è°ƒç”¨loadData', 'info');
                log(`   ç”Ÿæˆæ–°URL: /api/v1/attendance/status/load/${newMonth}`, 'info');
                
                setTimeout(() => {
                    log('7. æ–°æ•°æ®åŠ è½½å®Œæˆ', 'success');
                    log('âœ… æœˆä»½åˆ‡æ¢æµç¨‹æ­£å¸¸', 'success');
                }, 1000);
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('è€ƒå‹¤é¡µé¢ä¿®å¤éªŒè¯å·¥å…·åŠ è½½å®Œæˆ', 'success');
            log('', 'info');
            log('ğŸ”§ æœ¬æ¬¡ä¿®å¤çš„å…³é”®é—®é¢˜:', 'info');
            log('1. loadDataå‡½æ•°çš„useCallbackä¾èµ–é¡¹ç¼ºå°‘globalMonth', 'warning');
            log('2. è¿™å¯¼è‡´loadDataå‡½æ•°å†…éƒ¨ä½¿ç”¨çš„æ˜¯æ—§çš„globalMonthå€¼', 'warning');
            log('3. å³ä½¿globalMonthå˜åŒ–ï¼ŒloadDataä»ç„¶ä½¿ç”¨åˆå§‹å€¼', 'warning');
            log('', 'info');
            log('âœ… ä¿®å¤æ–¹æ¡ˆ:', 'info');
            log('1. åœ¨loadDataçš„ä¾èµ–é¡¹ä¸­æ·»åŠ globalMonth', 'success');
            log('2. ç§»é™¤globalMonth useEffectä¸­çš„loadDataä¾èµ–ï¼Œé¿å…æ— é™å¾ªç¯', 'success');
            log('', 'info');
            log('ç°åœ¨å¯ä»¥å¼€å§‹æµ‹è¯•ä¿®å¤æ•ˆæœ...', 'info');
        };
    </script>
</body>
</html>