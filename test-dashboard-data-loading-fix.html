<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒå‹¤ä»ªè¡¨ç›˜æ•°æ®åŠ è½½ä¿®å¤éªŒè¯</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f8fafc;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .problem-found {
            background: #fef2f2;
            border: 1px solid #f87171;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .fix-applied {
            background: #dcfce7;
            border: 1px solid #16a34a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .result { 
            margin-top: 10px; 
            padding: 15px; 
            background: #f1f5f9; 
            border-radius: 6px; 
            white-space: pre-wrap; 
            font-family: monospace; 
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { border-left: 4px solid #059669; }
        .error { border-left: 4px solid #dc2626; }
        .info { border-left: 4px solid #0284c7; }
        .warning { border-left: 4px solid #d97706; }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
        button:hover {
            background: #f9fafb;
        }
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .flow-diagram {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ è€ƒå‹¤ä»ªè¡¨ç›˜æ•°æ®åŠ è½½ä¿®å¤éªŒè¯</h1>
        
        <div class="problem-found">
            <h3>âŒ å‘ç°çš„é—®é¢˜</h3>
            <p><strong>ç°è±¡ï¼š</strong>ç‚¹å‡»è¿›å…¥è€ƒå‹¤ä»ªè¡¨ç›˜åï¼Œåªè°ƒç”¨äº†è€ƒå‹¤è§„åˆ™APIï¼Œæ²¡æœ‰ç»§ç»­è°ƒç”¨punchæ¥å£</p>
            
            <h4>ğŸ” æ ¹æœ¬åŸå› ï¼š</h4>
            <ol>
                <li><strong>useEffectæ¡ä»¶è¿‡äºä¸¥æ ¼</strong>ï¼šæ·»åŠ äº†`!isLoading`æ¡ä»¶ï¼Œå¯¼è‡´è§„åˆ™é…ç½®åŠ è½½å®Œæˆæ—¶æ•°æ®åŠ è½½å‡½æ•°ä¸è¢«è°ƒç”¨</li>
                <li><strong>å¾ªç¯ä¾èµ–é—®é¢˜</strong>ï¼šuseEffectä¾èµ–loadAllDataå‡½æ•°ï¼Œä½†loadAllDataçš„ä¾èµ–é¡¹å˜åŒ–ä¼šé‡æ–°åˆ›å»ºå‡½æ•°</li>
                <li><strong>çŠ¶æ€æ—¶åºé—®é¢˜</strong>ï¼šè§„åˆ™é…ç½®åŠ è½½å®Œæˆæ—¶ï¼ŒisLoadingçŠ¶æ€å¯èƒ½ä»ä¸ºtrue</li>
            </ol>
        </div>
        
        <div class="fix-applied">
            <h3>âœ… ä¿®å¤æ–¹æ¡ˆ</h3>
            <p><strong>ä½¿ç”¨useRefé¿å…å¾ªç¯ä¾èµ–ï¼š</strong>é€šè¿‡refå¼•ç”¨è§£å†³useEffectä¾èµ–é—®é¢˜</p>
            
            <h4>ğŸ”§ ä¿®å¤å†…å®¹ï¼š</h4>
            <ol>
                <li><strong>æ·»åŠ useRefå¼•ç”¨</strong>ï¼šä½¿ç”¨loadAllDataRef.currenté¿å…ç›´æ¥ä¾èµ–loadAllDataå‡½æ•°</li>
                <li><strong>ç§»é™¤ä¸¥æ ¼æ¡ä»¶</strong>ï¼šå»æ‰`!isLoading`æ¡ä»¶ï¼Œå…è®¸è§„åˆ™é…ç½®åŠ è½½å®Œæˆåç«‹å³è§¦å‘æ•°æ®åŠ è½½</li>
                <li><strong>æ›´æ–°refå¼•ç”¨</strong>ï¼šç¡®ä¿refå§‹ç»ˆæŒ‡å‘æœ€æ–°çš„loadAllDataå‡½æ•°</li>
                <li><strong>ä¿æŒé˜²é‡å¤æœºåˆ¶</strong>ï¼šåœ¨loadAllDataå†…éƒ¨ä¿æŒé˜²é‡å¤è°ƒç”¨é€»è¾‘</li>
            </ol>
        </div>
        
        <div class="flow-diagram">
            <h4>ğŸ“Š ä¿®å¤åçš„æ•°æ®åŠ è½½æµç¨‹</h4>
            <div class="result info">
1. é¡µé¢åˆå§‹åŒ–
   â†“
2. åˆå§‹åŒ–è§„åˆ™é…ç½® (initRuleConfigCache)
   â†“
3. è®¾ç½® ruleConfigLoaded = true
   â†“
4. è§¦å‘ useEffect (ruleConfigLoaded å˜åŒ–)
   â†“
5. è°ƒç”¨ loadAllDataRef.current() 
   â†“
6. æ‰§è¡Œ loadAllData() å‡½æ•°
   â†“
7. è°ƒç”¨ fetchCompanyData() (punchæ¥å£)
   â†“
8. åŠ è½½ç”¨æˆ·æ•°æ®å’Œè€ƒå‹¤æ•°æ®
   â†“
9. åˆå§‹åŒ–è€ƒå‹¤åœ°å›¾
   â†“
10. è®¡ç®—ç»Ÿè®¡æ•°æ®
   â†“
11. æ˜¾ç¤ºä»ªè¡¨ç›˜å†…å®¹
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ§ª ä¿®å¤æ•ˆæœéªŒè¯</h3>
            <button onclick="checkApiCallSequence()">æ£€æŸ¥APIè°ƒç”¨åºåˆ—</button>
            <button onclick="simulateLoadingFlow()">æ¨¡æ‹ŸåŠ è½½æµç¨‹</button>
            <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ ä¿®å¤å‰åå¯¹æ¯”</h3>
            
            <h4>ä¿®å¤å‰çš„é—®é¢˜ä»£ç ï¼š</h4>
            <div class="code-block">
// âŒ é—®é¢˜ä»£ç ï¼šæ¡ä»¶è¿‡äºä¸¥æ ¼ï¼Œå¯¼è‡´æ•°æ®åŠ è½½ä¸è¢«è§¦å‘
useEffect(() => { 
  if (ruleConfigLoaded && !isLoading) { // é—®é¢˜ï¼š!isLoadingæ¡ä»¶
    console.log('è§„åˆ™é…ç½®å·²åŠ è½½ï¼Œå¼€å§‹åŠ è½½æ•°æ®');
    loadAllData(); // å¯èƒ½ä¸ä¼šè¢«è°ƒç”¨
  }
}, [ruleConfigLoaded]); // ç¼ºå°‘loadAllDataä¾èµ–ä¼šå¯¼è‡´é—­åŒ…é—®é¢˜
            </div>
            
            <h4>ä¿®å¤åçš„ä»£ç ï¼š</h4>
            <div class="code-block">
// âœ… ä¿®å¤ä»£ç ï¼šä½¿ç”¨useRefé¿å…å¾ªç¯ä¾èµ–
const loadAllDataRef = useRef&lt;(() =&gt; Promise&lt;void&gt;) | null&gt;(null);

// æ›´æ–°refå¼•ç”¨
useEffect(() =&gt; {
  loadAllDataRef.current = loadAllData;
}, [loadAllData]);

// è§„åˆ™é…ç½®åŠ è½½å®Œæˆåè§¦å‘æ•°æ®åŠ è½½
useEffect(() =&gt; { 
  if (ruleConfigLoaded && loadAllDataRef.current) {
    console.log('è§„åˆ™é…ç½®å·²åŠ è½½ï¼Œå¼€å§‹åŠ è½½æ•°æ®');
    loadAllDataRef.current(); // é€šè¿‡refè°ƒç”¨ï¼Œé¿å…ä¾èµ–é—®é¢˜
  }
}, [ruleConfigLoaded]); // åªä¾èµ–ruleConfigLoaded
            </div>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function checkApiCallSequence() {
            log('ğŸ” æ£€æŸ¥APIè°ƒç”¨åºåˆ—...', 'info');
            log('', 'info');
            log('è¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„ç½‘ç»œé¢æ¿ï¼Œæ£€æŸ¥ä»¥ä¸‹APIè°ƒç”¨é¡ºåº:', 'info');
            log('', 'info');
            log('âœ… é¢„æœŸçš„APIè°ƒç”¨åºåˆ—:', 'success');
            log('1. /api/v1/rules (è€ƒå‹¤è§„åˆ™é…ç½®)', 'success');
            log('2. /api/v1/auth/token (è®¤è¯ä»¤ç‰Œ)', 'success');
            log('3. /api/v1/employees (å‘˜å·¥åˆ—è¡¨)', 'success');
            log('4. /api/v1/attendance/punch (è€ƒå‹¤æ‰“å¡æ•°æ®)', 'success');
            log('5. /api/v1/process/detail (æµç¨‹è¯¦æƒ…ï¼Œå¦‚æœæœ‰)', 'success');
            log('', 'info');
            log('âŒ ä¿®å¤å‰çš„é—®é¢˜:', 'error');
            log('â€¢ åªæœ‰ç¬¬1æ­¥è°ƒç”¨æˆåŠŸ', 'error');
            log('â€¢ ç¬¬2-5æ­¥ä¸ä¼šè¢«è§¦å‘', 'error');
            log('â€¢ é¡µé¢ä¸€ç›´æ˜¾ç¤ºåŠ è½½ä¸­', 'error');
            log('', 'info');
            log('âœ… ä¿®å¤åçš„é¢„æœŸ:', 'success');
            log('â€¢ æ‰€æœ‰æ­¥éª¤æŒ‰é¡ºåºæ‰§è¡Œ', 'success');
            log('â€¢ æ•°æ®åŠ è½½å®Œæˆåæ˜¾ç¤ºä»ªè¡¨ç›˜', 'success');
        }

        function simulateLoadingFlow() {
            log('ğŸ”„ æ¨¡æ‹Ÿä¿®å¤åçš„åŠ è½½æµç¨‹...', 'info');
            
            const steps = [
                { name: 'é¡µé¢åˆå§‹åŒ–', time: 100 },
                { name: 'åˆå§‹åŒ–è§„åˆ™é…ç½®', time: 500 },
                { name: 'è®¾ç½® ruleConfigLoaded = true', time: 100 },
                { name: 'è§¦å‘ useEffect (ruleConfigLoaded)', time: 50 },
                { name: 'è°ƒç”¨ loadAllDataRef.current()', time: 50 },
                { name: 'æ‰§è¡Œ loadAllData() å‡½æ•°', time: 100 },
                { name: 'è°ƒç”¨è®¤è¯API', time: 300 },
                { name: 'è°ƒç”¨å‘˜å·¥API', time: 800 },
                { name: 'è°ƒç”¨è€ƒå‹¤punch API', time: 1200 },
                { name: 'å¤„ç†è€ƒå‹¤æ•°æ®', time: 400 },
                { name: 'åˆå§‹åŒ–è€ƒå‹¤åœ°å›¾', time: 300 },
                { name: 'è®¡ç®—ç»Ÿè®¡æ•°æ®', time: 600 },
                { name: 'æ˜¾ç¤ºä»ªè¡¨ç›˜å†…å®¹', time: 200 }
            ];
            
            let currentStep = 0;
            
            function executeStep() {
                if (currentStep < steps.length) {
                    const step = steps[currentStep];
                    log(`æ­¥éª¤ ${currentStep + 1}: ${step.name}...`, 'info');
                    
                    setTimeout(() => {
                        if (currentStep === 6) {
                            log('ğŸ¯ å…³é”®ä¿®å¤ç‚¹ï¼šè¿™é‡Œå¼€å§‹è°ƒç”¨punchæ¥å£ï¼', 'success');
                        }
                        currentStep++;
                        executeStep();
                    }, step.time);
                } else {
                    log('', 'info');
                    log('ğŸ‰ åŠ è½½æµç¨‹å®Œæˆï¼ä»ªè¡¨ç›˜åº”è¯¥æ­£å¸¸æ˜¾ç¤ºäº†ã€‚', 'success');
                    log('', 'info');
                    log('ğŸ” éªŒè¯è¦ç‚¹:', 'info');
                    log('â€¢ ç½‘ç»œé¢æ¿åº”è¯¥çœ‹åˆ°æ‰€æœ‰APIè°ƒç”¨', 'info');
                    log('â€¢ æ§åˆ¶å°åº”è¯¥æœ‰å®Œæ•´çš„åŠ è½½æ—¥å¿—', 'info');
                    log('â€¢ é¡µé¢åº”è¯¥æ˜¾ç¤ºä»ªè¡¨ç›˜å†…å®¹è€Œä¸æ˜¯åŠ è½½ä¸­', 'info');
                }
            }
            
            executeStep();
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('è€ƒå‹¤ä»ªè¡¨ç›˜æ•°æ®åŠ è½½ä¿®å¤éªŒè¯å·¥å…·å·²åŠ è½½', 'success');
            log('', 'info');
            log('ğŸ¯ ä¿®å¤çš„æ ¸å¿ƒé—®é¢˜:', 'info');
            log('â€¢ è§„åˆ™é…ç½®åŠ è½½å®Œæˆåæ•°æ®åŠ è½½å‡½æ•°ä¸è¢«è§¦å‘', 'warning');
            log('â€¢ useEffectçš„æ¡ä»¶åˆ¤æ–­è¿‡äºä¸¥æ ¼', 'warning');
            log('â€¢ å¾ªç¯ä¾èµ–å¯¼è‡´çš„é—­åŒ…é—®é¢˜', 'warning');
            log('', 'info');
            log('âœ… ä¿®å¤æ–¹æ¡ˆ:', 'info');
            log('â€¢ ä½¿ç”¨useRefé¿å…å¾ªç¯ä¾èµ–', 'success');
            log('â€¢ ç§»é™¤è¿‡äºä¸¥æ ¼çš„æ¡ä»¶åˆ¤æ–­', 'success');
            log('â€¢ ä¿æŒé˜²é‡å¤è°ƒç”¨æœºåˆ¶', 'success');
            log('', 'info');
            log('ğŸ” ä¿®å¤åçš„é¢„æœŸæ•ˆæœ:', 'info');
            log('â€¢ è§„åˆ™é…ç½®åŠ è½½å®Œæˆåç«‹å³è§¦å‘æ•°æ®åŠ è½½', 'success');
            log('â€¢ æŒ‰é¡ºåºè°ƒç”¨æ‰€æœ‰å¿…è¦çš„API', 'success');
            log('â€¢ é¡µé¢æ­£å¸¸æ˜¾ç¤ºä»ªè¡¨ç›˜å†…å®¹', 'success');
            log('', 'info');
            log('ç°åœ¨å¯ä»¥å¼€å§‹éªŒè¯ä¿®å¤æ•ˆæœ...', 'info');
        };
    </script>
</body>
</html>