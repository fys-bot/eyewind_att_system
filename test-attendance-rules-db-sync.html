<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒå‹¤è§„åˆ™é¡µé¢æ•°æ®åº“åŒæ­¥æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        .test-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .test-section h3 {
            margin: 0 0 12px 0;
            color: #1e293b;
            font-size: 16px;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .status.implemented { background: #dcfce7; color: #166534; }
        .status.requirement { background: #fef3c7; color: #92400e; }
        .code-block {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            margin: 8px 0;
            overflow-x: auto;
        }
        .highlight {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .change-log {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            padding: 12px;
            margin: 12px 0;
        }
        .test-steps {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
        }
        .test-steps ol {
            margin: 0;
            padding-left: 20px;
        }
        .test-steps li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .flow-diagram {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
            text-align: center;
        }
        .flow-step {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            margin: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .flow-arrow {
            display: inline-block;
            margin: 0 8px;
            color: #64748b;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”„ è€ƒå‹¤è§„åˆ™é¡µé¢æ•°æ®åº“åŒæ­¥åŠŸèƒ½</h1>
        <p>æ¯æ¬¡è¿›å…¥è€ƒå‹¤è§„åˆ™é¡µé¢éƒ½ä»æ•°æ®åº“åŠ è½½æœ€æ–°é…ç½®å¹¶åŒæ­¥åˆ°è§„åˆ™å¼•æ“</p>
    </div>

    <div class="container">
        <h2>ğŸ“‹ éœ€æ±‚è¯´æ˜</h2>
        
        <div class="test-section">
            <h3>ç”¨æˆ·éœ€æ±‚ <span class="status requirement">REQUIREMENT</span></h3>
            <p><strong>åŸå§‹éœ€æ±‚ï¼š</strong>"æ¯æ¬¡è¿›æ¥è€ƒå‹¤è§„åˆ™é¡µé¢éƒ½è¦å»è¯·æ±‚ä¸€ä¸‹æ¥å£ï¼Œç„¶åå°†æ•°æ®åº“é‡Œé¢çš„è§„åˆ™ç»“æœåŒæ­¥ä¸Šå»"</p>
            
            <p><strong>éœ€æ±‚è§£æï¼š</strong></p>
            <ul>
                <li>æ¯æ¬¡è¿›å…¥è€ƒå‹¤è§„åˆ™é…ç½®é¡µé¢æ—¶ï¼Œéƒ½è¦ä¸»åŠ¨ä»æ•°æ®åº“APIè·å–æœ€æ–°çš„è§„åˆ™é…ç½®</li>
                <li>å°†è·å–åˆ°çš„æ•°æ®åº“è§„åˆ™åŒæ­¥åˆ°å‰ç«¯çš„è§„åˆ™å¼•æ“ä¸­</li>
                <li>ç¡®ä¿é¡µé¢æ˜¾ç¤ºçš„è§„åˆ™é…ç½®å§‹ç»ˆæ˜¯æ•°æ®åº“ä¸­çš„æœ€æ–°ç‰ˆæœ¬</li>
                <li>é¿å…å› ç¼“å­˜æˆ–æœ¬åœ°å­˜å‚¨å¯¼è‡´çš„è§„åˆ™ä¸ä¸€è‡´é—®é¢˜</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ä¸šåŠ¡ä»·å€¼</h3>
            <ul>
                <li><strong>æ•°æ®ä¸€è‡´æ€§ï¼š</strong>ç¡®ä¿å¤šç”¨æˆ·ç¯å¢ƒä¸‹è§„åˆ™é…ç½®çš„ä¸€è‡´æ€§</li>
                <li><strong>å®æ—¶æ€§ï¼š</strong>ç®¡ç†å‘˜ä¿®æ”¹è§„åˆ™åï¼Œå…¶ä»–ç”¨æˆ·èƒ½ç«‹å³çœ‹åˆ°æœ€æ–°é…ç½®</li>
                <li><strong>å¯é æ€§ï¼š</strong>ä»¥æ•°æ®åº“ä¸ºå‡†ï¼Œé¿å…æœ¬åœ°ç¼“å­˜å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´</li>
                <li><strong>å®¡è®¡æ€§ï¼š</strong>æ‰€æœ‰è§„åˆ™å˜æ›´éƒ½æœ‰æ•°æ®åº“è®°å½•ï¼Œä¾¿äºè¿½æº¯</li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ”§ å®ç°æ–¹æ¡ˆ</h2>

        <div class="flow-diagram">
            <h3 style="margin-top: 0;">æ•°æ®åŒæ­¥æµç¨‹</h3>
            <div style="margin: 20px 0;">
                <span class="flow-step">è¿›å…¥é¡µé¢</span>
                <span class="flow-arrow">â†’</span>
                <span class="flow-step">è°ƒç”¨æ•°æ®åº“API</span>
                <span class="flow-arrow">â†’</span>
                <span class="flow-step">è½¬æ¢æ•°æ®æ ¼å¼</span>
                <span class="flow-arrow">â†’</span>
                <span class="flow-step">æ›´æ–°å‰ç«¯çŠ¶æ€</span>
                <span class="flow-arrow">â†’</span>
                <span class="flow-step">åŒæ­¥è§„åˆ™å¼•æ“</span>
                <span class="flow-arrow">â†’</span>
                <span class="flow-step">æ˜¾ç¤ºæœ€æ–°é…ç½®</span>
            </div>
        </div>

        <div class="change-log">
            <h3>æ ¸å¿ƒä¿®æ”¹ 1ï¼šå¼ºåˆ¶æ•°æ®åº“åŠ è½½</h3>
            <div class="code-block">
// âœ… ä¿®æ”¹å‰ï¼šåªåœ¨ç»„ä»¶é¦–æ¬¡æŒ‚è½½æ—¶åŠ è½½
useEffect(() => {
  if (!hasInitialized || !isCurrentlyLoading) {
    loadConfigFromDatabase();
  }
}, [selectedCompany, loadConfigFromDatabase, hasInitialized, isCurrentlyLoading]);

// ğŸ”¥ ä¿®æ”¹åï¼šæ¯æ¬¡è¿›å…¥é¡µé¢éƒ½å¼ºåˆ¶ä»æ•°æ®åº“åŠ è½½
useEffect(() => {
  console.log(`ğŸ”¥ æ¯æ¬¡è¿›å…¥é¡µé¢éƒ½å¼ºåˆ¶ä»æ•°æ®åº“åŠ è½½ ${selectedCompany} é…ç½®`);
  
  // é‡ç½®åˆå§‹åŒ–çŠ¶æ€ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½
  <span class="highlight">setHasInitialized(false);</span>
  <span class="highlight">setIsCurrentlyLoading(false);</span>
  
  // ç«‹å³ä»æ•°æ®åº“åŠ è½½é…ç½®
  <span class="highlight">loadConfigFromDatabase();</span>
}, [selectedCompany, loadConfigFromDatabase]); // æ¯æ¬¡å…¬å¸åˆ‡æ¢æˆ–ç»„ä»¶æŒ‚è½½éƒ½é‡æ–°åŠ è½½
            </div>
        </div>

        <div class="change-log">
            <h3>æ ¸å¿ƒä¿®æ”¹ 2ï¼šå¢å¼ºæ•°æ®åº“åŠ è½½é€»è¾‘</h3>
            <div class="code-block">
const loadConfigFromDatabase = useCallback(async () => {
  try {
    console.log(`ğŸ”¥ å¼ºåˆ¶ä»æ•°æ®åº“åŠ è½½ ${selectedCompany} çš„æœ€æ–°é…ç½®`);
    
    // ğŸ”¥ å¼ºåˆ¶ä»æ•°æ®åº“è·å–æœ€æ–°é…ç½®ï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
    const dbConfig = await attendanceRuleApiService.getFullConfig(selectedCompany, <span class="highlight">true</span>);
    
    if (dbConfig) {
      // è½¬æ¢æ•°æ®æ ¼å¼
      const frontendConfig = convertDbConfigToFrontend(dbConfig, selectedCompany);
      
      // æ›´æ–°å‰ç«¯çŠ¶æ€
      setFormData({ rules: { ...frontendConfig } });
      
      // ğŸ”¥ é‡è¦ï¼šåŒæ­¥åˆ°è§„åˆ™å¼•æ“ï¼Œç¡®ä¿å…¨å±€è§„åˆ™ç«‹å³ç”Ÿæ•ˆ
      const { AttendanceRuleManager } = await import('../attendance/AttendanceRuleEngine.ts');
      const { refreshRuleConfigCache } = await import('../attendance/utils.ts');
      
      <span class="highlight">// åˆ·æ–°è§„åˆ™é…ç½®ç¼“å­˜</span>
      <span class="highlight">await refreshRuleConfigCache(selectedCompany);</span>
      
      <span class="highlight">// é‡æ–°åŠ è½½è§„åˆ™å¼•æ“</span>
      <span class="highlight">AttendanceRuleManager.reloadAllRules();</span>
      
      console.log(`ğŸ”¥ è§„åˆ™å¼•æ“å·²åŒæ­¥æ›´æ–° ${selectedCompany} çš„è§„åˆ™`);
    }
  } catch (error) {
    console.error('ä»æ•°æ®åº“åŠ è½½é…ç½®å¤±è´¥:', error);
  }
}, [selectedCompany]);
            </div>
        </div>

        <div class="change-log">
            <h3>æ ¸å¿ƒä¿®æ”¹ 3ï¼šç»„ä»¶æŒ‚è½½æ—¶ç«‹å³åˆå§‹åŒ–</h3>
            <div class="code-block">
// ğŸ”¥ ç»„ä»¶æŒ‚è½½æ—¶ç«‹å³è®¾ç½®ä¸ºå·²æŒ‚è½½çŠ¶æ€
useEffect(() => {
  isMountedRef.current = true;
  console.log('[AttendanceRules] ğŸ”¥ ç»„ä»¶æŒ‚è½½ï¼Œå‡†å¤‡åŠ è½½æ•°æ®åº“é…ç½®');
  
  return () => {
    isMountedRef.current = false;
    console.log('[AttendanceRules] ç»„ä»¶å¸è½½');
  };
}, []);
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ§ª æµ‹è¯•éªŒè¯</h2>
        
        <div class="test-steps">
            <h3>æµ‹è¯•æ­¥éª¤</h3>
            <ol>
                <li><strong>åŸºç¡€åŠŸèƒ½æµ‹è¯•</strong>
                    <ul>
                        <li>æ‰“å¼€è€ƒå‹¤è§„åˆ™é…ç½®é¡µé¢</li>
                        <li>è§‚å¯Ÿæµè§ˆå™¨æ§åˆ¶å°ï¼Œåº”è¯¥çœ‹åˆ°æ•°æ®åº“åŠ è½½æ—¥å¿—</li>
                        <li>ç¡®è®¤é¡µé¢æ˜¾ç¤ºçš„æ˜¯æ•°æ®åº“ä¸­çš„æœ€æ–°é…ç½®</li>
                    </ul>
                </li>
                
                <li><strong>å…¬å¸åˆ‡æ¢æµ‹è¯•</strong>
                    <ul>
                        <li>åœ¨é¡µé¢ä¸Šåˆ‡æ¢å…¬å¸ï¼ˆé£çœ¼ â†” æµ·å¤šå¤šï¼‰</li>
                        <li>æ¯æ¬¡åˆ‡æ¢éƒ½åº”è¯¥é‡æ–°ä»æ•°æ®åº“åŠ è½½å¯¹åº”å…¬å¸çš„é…ç½®</li>
                        <li>æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ç¡®è®¤åŠ è½½è¿‡ç¨‹</li>
                    </ul>
                </li>
                
                <li><strong>é¡µé¢é‡æ–°è¿›å…¥æµ‹è¯•</strong>
                    <ul>
                        <li>ç¦»å¼€è€ƒå‹¤è§„åˆ™é¡µé¢ï¼Œå¯¼èˆªåˆ°å…¶ä»–é¡µé¢</li>
                        <li>å†æ¬¡è¿›å…¥è€ƒå‹¤è§„åˆ™é¡µé¢</li>
                        <li>ç¡®è®¤é‡æ–°è¿›å…¥æ—¶ä¼šå†æ¬¡ä»æ•°æ®åº“åŠ è½½é…ç½®</li>
                    </ul>
                </li>
                
                <li><strong>è§„åˆ™å¼•æ“åŒæ­¥æµ‹è¯•</strong>
                    <ul>
                        <li>åœ¨æ•°æ®åº“ä¸­ä¿®æ”¹æŸä¸ªå…¬å¸çš„è§„åˆ™é…ç½®</li>
                        <li>è¿›å…¥è€ƒå‹¤è§„åˆ™é¡µé¢</li>
                        <li>ç¡®è®¤é¡µé¢æ˜¾ç¤ºæœ€æ–°é…ç½®</li>
                        <li>è¿›å…¥è€ƒå‹¤ä»ªè¡¨ç›˜ï¼Œç¡®è®¤è§„åˆ™å¼•æ“ä½¿ç”¨æœ€æ–°è§„åˆ™</li>
                    </ul>
                </li>
                
                <li><strong>å¤šç”¨æˆ·åä½œæµ‹è¯•</strong>
                    <ul>
                        <li>ç”¨æˆ·Aä¿®æ”¹å¹¶ä¿å­˜è§„åˆ™é…ç½®</li>
                        <li>ç”¨æˆ·Bè¿›å…¥è€ƒå‹¤è§„åˆ™é¡µé¢</li>
                        <li>ç¡®è®¤ç”¨æˆ·Bçœ‹åˆ°çš„æ˜¯ç”¨æˆ·Aä¿®æ”¹åçš„æœ€æ–°é…ç½®</li>
                    </ul>
                </li>
            </ol>
        </div>

        <div class="test-section">
            <h3>é¢„æœŸç»“æœ <span class="status implemented">IMPLEMENTED</span></h3>
            <ul>
                <li>âœ… æ¯æ¬¡è¿›å…¥é¡µé¢éƒ½ä¼šä»æ•°æ®åº“é‡æ–°åŠ è½½é…ç½®</li>
                <li>âœ… åˆ‡æ¢å…¬å¸æ—¶ä¼šåŠ è½½å¯¹åº”å…¬å¸çš„æœ€æ–°é…ç½®</li>
                <li>âœ… è§„åˆ™å¼•æ“ä¼šåŒæ­¥æ›´æ–°ï¼Œç¡®ä¿å…¨å±€ä¸€è‡´æ€§</li>
                <li>âœ… æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†çš„åŠ è½½å’ŒåŒæ­¥æ—¥å¿—</li>
                <li>âœ… é¡µé¢æ˜¾ç¤ºæˆåŠŸåŠ è½½çš„æç¤ºä¿¡æ¯</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>å…³é”®æ—¥å¿—è¾“å‡º</h3>
            <p>å®ç°åï¼Œåœ¨æµè§ˆå™¨æ§åˆ¶å°åº”è¯¥èƒ½çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š</p>
            <div class="code-block">
[AttendanceRules] ğŸ”¥ ç»„ä»¶æŒ‚è½½ï¼Œå‡†å¤‡åŠ è½½æ•°æ®åº“é…ç½®
[AttendanceRules] ğŸ”¥ æ¯æ¬¡è¿›å…¥é¡µé¢éƒ½å¼ºåˆ¶ä»æ•°æ®åº“åŠ è½½ eyewind é…ç½®
[AttendanceRules] ğŸ”¥ å¼ºåˆ¶ä»æ•°æ®åº“åŠ è½½ eyewind çš„æœ€æ–°é…ç½®
[AttendanceRules] âœ… æˆåŠŸä»æ•°æ®åº“åŠ è½½ eyewind é…ç½®
[AttendanceRules] ğŸ”¥ è§„åˆ™å¼•æ“å·²åŒæ­¥æ›´æ–° eyewind çš„è§„åˆ™
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ”„ æ•°æ®æµç¨‹å›¾</h2>
        
        <div class="test-section">
            <h3>å®Œæ•´çš„æ•°æ®åŒæ­¥æµç¨‹</h3>
            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 12px; line-height: 1.6;">
<pre>
1. ç”¨æˆ·è¿›å…¥è€ƒå‹¤è§„åˆ™é¡µé¢
   â†“
2. useEffect è§¦å‘ (æ¯æ¬¡éƒ½æ‰§è¡Œ)
   â†“
3. é‡ç½®åŠ è½½çŠ¶æ€
   â”œâ”€ setHasInitialized(false)
   â””â”€ setIsCurrentlyLoading(false)
   â†“
4. è°ƒç”¨ loadConfigFromDatabase()
   â†“
5. è¯·æ±‚æ•°æ®åº“ API
   â”œâ”€ attendanceRuleApiService.getFullConfig(company, true)
   â””â”€ å‚æ•° true è¡¨ç¤ºå¼ºåˆ¶åˆ·æ–°ï¼Œä¸ä½¿ç”¨ç¼“å­˜
   â†“
6. æ•°æ®æ ¼å¼è½¬æ¢
   â”œâ”€ convertDbConfigToFrontend(dbConfig, company)
   â””â”€ å°†æ•°æ®åº“æ ¼å¼è½¬æ¢ä¸ºå‰ç«¯ç»„ä»¶æ ¼å¼
   â†“
7. æ›´æ–°å‰ç«¯çŠ¶æ€
   â”œâ”€ setFormData({ rules: frontendConfig })
   â””â”€ setStoredConfigs() // æ›´æ–°æœ¬åœ°å­˜å‚¨å¤‡ä»½
   â†“
8. åŒæ­¥åˆ°è§„åˆ™å¼•æ“ ğŸ”¥
   â”œâ”€ refreshRuleConfigCache(company)
   â””â”€ AttendanceRuleManager.reloadAllRules()
   â†“
9. æ˜¾ç¤ºæˆåŠŸæç¤º
   â””â”€ "âœ… å·²ä»æ•°æ®åº“é‡æ–°åŠ è½½é…ç½®å¹¶åŒæ­¥åˆ°è§„åˆ™å¼•æ“"
</pre>
            </div>
        </div>

        <div class="test-section">
            <h3>ä¸å…¶ä»–æ¨¡å—çš„åä½œ</h3>
            <ul>
                <li><strong>è€ƒå‹¤ä»ªè¡¨ç›˜ï¼š</strong>è§„åˆ™å¼•æ“æ›´æ–°åï¼Œä»ªè¡¨ç›˜çš„è®¡ç®—é€»è¾‘ä¼šç«‹å³ä½¿ç”¨æœ€æ–°è§„åˆ™</li>
                <li><strong>è€ƒå‹¤ç¡®è®¤ï¼š</strong>ç¡®è®¤å•ç”Ÿæˆæ—¶ä¼šä½¿ç”¨æœ€æ–°çš„è§„åˆ™è¿›è¡Œè®¡ç®—</li>
                <li><strong>è€ƒå‹¤æ—¥å†ï¼š</strong>æ—¥å†ç¼–è¾‘åŠŸèƒ½ä¼šåŸºäºæœ€æ–°è§„åˆ™è¿›è¡ŒéªŒè¯</li>
                <li><strong>ç¼“å­˜ç³»ç»Ÿï¼š</strong>ç›¸å…³ç¼“å­˜ä¼šè¢«æ¸…ç†ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§</li>
            </ul>
        </div>
    </div>

    <div class="container" style="background: #f0f9ff; border: 1px solid #0ea5e9;">
        <h2 style="color: #0369a1;">ğŸ¯ å®ç°å®Œæˆ</h2>
        <p><strong>åŠŸèƒ½çŠ¶æ€ï¼š</strong> <span class="status implemented">å·²å®ç°</span></p>
        <p><strong>æ ¸å¿ƒç‰¹æ€§ï¼š</strong></p>
        <ul>
            <li>âœ… æ¯æ¬¡è¿›å…¥é¡µé¢éƒ½å¼ºåˆ¶ä»æ•°æ®åº“åŠ è½½æœ€æ–°è§„åˆ™é…ç½®</li>
            <li>âœ… è‡ªåŠ¨åŒæ­¥åˆ°è§„åˆ™å¼•æ“ï¼Œç¡®ä¿å…¨å±€è§„åˆ™ä¸€è‡´æ€§</li>
            <li>âœ… æ”¯æŒå…¬å¸åˆ‡æ¢æ—¶çš„é…ç½®é‡æ–°åŠ è½½</li>
            <li>âœ… å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ</li>
            <li>âœ… è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥</li>
        </ul>
        <p><strong>å½±å“èŒƒå›´ï¼š</strong> è€ƒå‹¤è§„åˆ™é…ç½®é¡µé¢çš„æ•°æ®åŠ è½½æœºåˆ¶</p>
        <p><strong>ä¿®æ”¹æ–‡ä»¶ï¼š</strong> <code>components/settings/AttendanceRules.tsx</code></p>
        <p><strong>æµ‹è¯•å»ºè®®ï¼š</strong> é‡ç‚¹æµ‹è¯•å¤šç”¨æˆ·åä½œåœºæ™¯å’Œè§„åˆ™å¼•æ“åŒæ­¥æ•ˆæœ</p>
    </div>

    <script>
        // æ·»åŠ ä¸€äº›äº¤äº’æ•ˆæœ
        document.querySelectorAll('.test-section').forEach(section => {
            section.addEventListener('click', function() {
                this.style.backgroundColor = this.style.backgroundColor === 'rgb(240, 249, 255)' ? '' : '#f0f9ff';
            });
        });

        // æ˜¾ç¤ºå½“å‰æ—¶é—´
        const now = new Date();
        console.log(`æµ‹è¯•é¡µé¢åŠ è½½æ—¶é—´: ${now.toLocaleString('zh-CN')}`);
    </script>
</body>
</html>