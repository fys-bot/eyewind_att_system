<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢å¼ºç¼“å­˜ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .loading { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; max-height: 300px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0; }
        .stat-item { background: #f8f9fa; padding: 10px; border-radius: 3px; text-align: center; }
        .log-container { max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; font-size: 12px; }
        .cache-item { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        .cache-key { font-weight: bold; color: #007bff; }
        .cache-size { color: #6c757d; font-size: 12px; }
        .cache-type { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 11px; color: white; }
        .cache-type.holiday { background: #28a745; }
        .cache-type.dashboard { background: #17a2b8; }
        .cache-type.other { background: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>å¢å¼ºç¼“å­˜ç³»ç»Ÿæµ‹è¯•</h1>
        
        <div class="test-section info">
            <h3>ğŸš€ ç¼“å­˜ç³»ç»Ÿè¯´æ˜</h3>
            <p><strong>èŠ‚å‡æ—¥ç¼“å­˜ (HolidayCache):</strong></p>
            <ul>
                <li>æŒ‰å¹´ä»½ç¼“å­˜èŠ‚å‡æ—¥æ•°æ®</li>
                <li>é•¿æœŸæœ‰æ•ˆï¼Œä¸ä¼šè‡ªåŠ¨è¿‡æœŸ</li>
                <li>åˆ‡æ¢å¹´ä»½æ—¶è‡ªåŠ¨è·å–æ–°æ•°æ®</li>
            </ul>
            <p><strong>ä»ªè¡¨ç›˜ç¼“å­˜ (DashboardCache):</strong></p>
            <ul>
                <li>æŒ‰å…¬å¸+æœˆä»½ç¼“å­˜å®Œæ•´ä»ªè¡¨ç›˜æ•°æ®</li>
                <li>åŒ…å«å‘˜å·¥ã€æ‰“å¡ã€æµç¨‹æ•°æ®</li>
                <li>åˆ‡æ¢å…¬å¸æˆ–æœˆä»½æ—¶è‡ªåŠ¨æ¸…ç†</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>1. èŠ‚å‡æ—¥ç¼“å­˜æµ‹è¯•</h3>
            <button onclick="testHolidayCache()">æµ‹è¯•èŠ‚å‡æ—¥ç¼“å­˜</button>
            <button onclick="clearHolidayCache()">æ¸…é™¤èŠ‚å‡æ—¥ç¼“å­˜</button>
            <div id="holiday-result"></div>
        </div>

        <div class="test-section">
            <h3>2. ä»ªè¡¨ç›˜ç¼“å­˜æµ‹è¯•</h3>
            <button onclick="testDashboardCache()">æµ‹è¯•ä»ªè¡¨ç›˜ç¼“å­˜</button>
            <button onclick="clearDashboardCache()">æ¸…é™¤ä»ªè¡¨ç›˜ç¼“å­˜</button>
            <div id="dashboard-result"></div>
        </div>

        <div class="test-section">
            <h3>3. ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯</h3>
            <button onclick="getCacheStats()">è·å–ç¼“å­˜ç»Ÿè®¡</button>
            <div id="cache-stats"></div>
        </div>

        <div class="test-section">
            <h3>4. ç¼“å­˜å†…å®¹æŸ¥çœ‹</h3>
            <button onclick="viewCacheContents()">æŸ¥çœ‹æ‰€æœ‰ç¼“å­˜</button>
            <div id="cache-contents"></div>
        </div>

        <div class="test-section">
            <h3>5. æ€§èƒ½æµ‹è¯•</h3>
            <button onclick="runPerformanceTest()">è¿è¡Œæ€§èƒ½æµ‹è¯•</button>
            <div id="performance-result"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿç¼“å­˜ç³»ç»Ÿï¼ˆå®é™…åº”ç”¨ä¸­è¿™äº›ä¼šåœ¨Reactç»„ä»¶ä¸­ä½¿ç”¨ï¼‰
        
        // IndexedDB é…ç½®
        const DB_NAME = 'LingoSyncDB';
        const STORE_NAME = 'smart_cache';
        const DB_VERSION = 1;
        const CACHE_PREFIX = 'LINGOSYNC_CACHE_';

        // æ‰“å¼€IndexedDB
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        // æ¨¡æ‹ŸèŠ‚å‡æ—¥ç¼“å­˜
        class HolidayCache {
            static async getHolidays(year) {
                const cacheKey = `HOLIDAY_CACHE_${year}`;
                
                try {
                    // 1. å°è¯•ä»ç¼“å­˜è¯»å–
                    const cached = await this.getCachedData(cacheKey);
                    if (cached) {
                        console.log(`[HolidayCache] ä½¿ç”¨ç¼“å­˜çš„èŠ‚å‡æ—¥æ•°æ®: ${year}`);
                        return cached;
                    }
                    
                    // 2. ä»APIè·å–
                    console.log(`[HolidayCache] ä»APIè·å–èŠ‚å‡æ—¥æ•°æ®: ${year}`);
                    const response = await fetch(`https://timor.tech/api/holiday/year/${year}`);
                    if (!response.ok) throw new Error('Failed to fetch holidays');
                    
                    const data = await response.json();
                    const holidayData = data.holiday || {};
                    
                    // 3. å­˜å‚¨åˆ°ç¼“å­˜
                    await this.setCachedData(cacheKey, holidayData, 'holiday', year);
                    
                    return holidayData;
                } catch (error) {
                    console.warn(`[HolidayCache] è·å–èŠ‚å‡æ—¥æ•°æ®å¤±è´¥: ${year}`, error);
                    return {};
                }
            }

            static async getCachedData(key) {
                try {
                    const db = await openDB();
                    return new Promise((resolve) => {
                        const transaction = db.transaction(STORE_NAME, 'readonly');
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.get(key);
                        
                        request.onsuccess = () => {
                            const item = request.result;
                            if (item && item.data) {
                                resolve(item.data);
                            } else {
                                resolve(null);
                            }
                        };
                        request.onerror = () => resolve(null);
                    });
                } catch (e) {
                    return null;
                }
            }

            static async setCachedData(key, data, type, year) {
                try {
                    const db = await openDB();
                    const item = {
                        data,
                        timestamp: Date.now(),
                        type: type,
                        year: year,
                        permanent: type === 'holiday'
                    };
                    
                    return new Promise((resolve) => {
                        const transaction = db.transaction(STORE_NAME, 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.put(item, key);
                        request.onsuccess = () => resolve();
                        request.onerror = () => resolve();
                    });
                } catch (e) {
                    console.error('ç¼“å­˜æ•°æ®å¤±è´¥', e);
                }
            }

            static async clearHolidays(year) {
                const cacheKey = `HOLIDAY_CACHE_${year}`;
                try {
                    const db = await openDB();
                    return new Promise((resolve) => {
                        const transaction = db.transaction(STORE_NAME, 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.delete(cacheKey);
                        request.onsuccess = () => resolve();
                        request.onerror = () => resolve();
                    });
                } catch (e) {
                    console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥', e);
                }
            }
        }

        // æ¨¡æ‹Ÿä»ªè¡¨ç›˜ç¼“å­˜
        class DashboardCache {
            static getCacheKey(company, yearMonth) {
                return `DASHBOARD_CACHE_${company}_${yearMonth}`;
            }

            static async getDashboardData(company, yearMonth) {
                const cacheKey = this.getCacheKey(company, yearMonth);
                return await HolidayCache.getCachedData(cacheKey);
            }

            static async setDashboardData(company, yearMonth, data) {
                const cacheKey = this.getCacheKey(company, yearMonth);
                const cacheData = {
                    ...data,
                    cachedAt: Date.now(),
                    company,
                    yearMonth,
                    type: 'dashboard'
                };
                
                await HolidayCache.setCachedData(cacheKey, cacheData, 'dashboard');
            }

            static async clearDashboardData(company, yearMonth) {
                const cacheKey = this.getCacheKey(company, yearMonth);
                try {
                    const db = await openDB();
                    return new Promise((resolve) => {
                        const transaction = db.transaction(STORE_NAME, 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.delete(cacheKey);
                        request.onsuccess = () => resolve();
                        request.onerror = () => resolve();
                    });
                } catch (e) {
                    console.error('æ¸…é™¤ä»ªè¡¨ç›˜ç¼“å­˜å¤±è´¥', e);
                }
            }
        }

        // æµ‹è¯•å‡½æ•°
        async function testHolidayCache() {
            const resultDiv = document.getElementById('holiday-result');
            resultDiv.innerHTML = '<div class="loading">æ­£åœ¨æµ‹è¯•èŠ‚å‡æ—¥ç¼“å­˜...</div>';
            
            try {
                const year = new Date().getFullYear();
                const startTime = Date.now();
                
                // ç¬¬ä¸€æ¬¡è·å–ï¼ˆä»APIï¼‰
                const holidays1 = await HolidayCache.getHolidays(year);
                const firstLoadTime = Date.now() - startTime;
                
                // ç¬¬äºŒæ¬¡è·å–ï¼ˆä»ç¼“å­˜ï¼‰
                const cacheStartTime = Date.now();
                const holidays2 = await HolidayCache.getHolidays(year);
                const cacheLoadTime = Date.now() - cacheStartTime;
                
                const holidayCount = Object.keys(holidays1).length;
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>âœ… èŠ‚å‡æ—¥ç¼“å­˜æµ‹è¯•æˆåŠŸ</h4>
                        <div class="stats">
                            <div class="stat-item">
                                <strong>æµ‹è¯•å¹´ä»½</strong><br>
                                ${year}
                            </div>
                            <div class="stat-item">
                                <strong>èŠ‚å‡æ—¥æ•°é‡</strong><br>
                                ${holidayCount}
                            </div>
                            <div class="stat-item">
                                <strong>é¦–æ¬¡åŠ è½½æ—¶é—´</strong><br>
                                ${firstLoadTime}ms
                            </div>
                            <div class="stat-item">
                                <strong>ç¼“å­˜åŠ è½½æ—¶é—´</strong><br>
                                ${cacheLoadTime}ms
                            </div>
                        </div>
                        <p><strong>æ€§èƒ½æå‡:</strong> ${Math.round((firstLoadTime - cacheLoadTime) / firstLoadTime * 100)}%</p>
                        <details>
                            <summary>æŸ¥çœ‹èŠ‚å‡æ—¥æ•°æ®</summary>
                            <pre>${JSON.stringify(holidays1, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ èŠ‚å‡æ—¥ç¼“å­˜æµ‹è¯•å¤±è´¥</h4>
                        <p>é”™è¯¯: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function testDashboardCache() {
            const resultDiv = document.getElementById('dashboard-result');
            resultDiv.innerHTML = '<div class="loading">æ­£åœ¨æµ‹è¯•ä»ªè¡¨ç›˜ç¼“å­˜...</div>';
            
            try {
                const company = 'eyewind';
                const yearMonth = '2024-12';
                
                // æ¨¡æ‹Ÿä»ªè¡¨ç›˜æ•°æ®
                const mockDashboardData = {
                    employees: [
                        { userid: '001', name: 'å¼ ä¸‰', department: 'æŠ€æœ¯éƒ¨' },
                        { userid: '002', name: 'æå››', department: 'äº§å“éƒ¨' }
                    ],
                    companyCounts: { eyewind: ['001', '002'] },
                    processDataMap: {},
                    attendanceMap: {}
                };
                
                // è®¾ç½®ç¼“å­˜
                const setStartTime = Date.now();
                await DashboardCache.setDashboardData(company, yearMonth, mockDashboardData);
                const setTime = Date.now() - setStartTime;
                
                // è·å–ç¼“å­˜
                const getStartTime = Date.now();
                const cachedData = await DashboardCache.getDashboardData(company, yearMonth);
                const getTime = Date.now() - getStartTime;
                
                const dataSize = JSON.stringify(mockDashboardData).length;
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>âœ… ä»ªè¡¨ç›˜ç¼“å­˜æµ‹è¯•æˆåŠŸ</h4>
                        <div class="stats">
                            <div class="stat-item">
                          