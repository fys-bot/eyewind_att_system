# è€ƒå‹¤è§„åˆ™å®æ—¶åŠ è½½åŠŸèƒ½

## ğŸ¯ åŠŸèƒ½éœ€æ±‚

æ¯æ¬¡è¿›å…¥è€ƒå‹¤ä»ªè¡¨ç›˜é¡µé¢éƒ½è¦åŠ è½½å½“å‰å…¬å¸ä¸»ä½“çš„è€ƒå‹¤è§„åˆ™æ¥å£ï¼Œå¹¶ä¸”æ•´ä¸ªç³»ç»Ÿçš„è€ƒå‹¤è§„åˆ™éƒ½è¦ä»¥æ¥å£è¿”å›çš„ä¸ºå‡†ã€‚

## âœ… å®ç°æ–¹æ¡ˆ

### 1. å¼ºåˆ¶åˆ·æ–°æœºåˆ¶

æ¯æ¬¡è¿›å…¥è€ƒå‹¤ä»ªè¡¨ç›˜é¡µé¢æ—¶ï¼Œéƒ½ä¼šå¼ºåˆ¶ä»æ•°æ®åº“APIè·å–å½“å‰å…¬å¸çš„æœ€æ–°è§„åˆ™é…ç½®ï¼Œä¸ä¾èµ–ç¼“å­˜æœ‰æ•ˆæœŸã€‚

```typescript
// AttendanceDashboardPage.tsx
useEffect(() => {
  const initRuleConfig = async () => {
    // ğŸ”¥ æ¯æ¬¡è¿›å…¥é¡µé¢éƒ½å¼ºåˆ¶åˆ·æ–°å½“å‰å…¬å¸çš„è§„åˆ™é…ç½®
    console.log(`[AttendanceDashboardPage] å¼ºåˆ¶åˆ·æ–° ${currentCompany} çš„è§„åˆ™é…ç½®`);
    await refreshRuleConfigCache(currentCompany);
    
    // ğŸ”¥ åˆ·æ–°å®Œæˆåï¼Œé‡æ–°åŠ è½½è§„åˆ™å¼•æ“
    AttendanceRuleManager.reloadAllRules();
    
    console.log('[AttendanceDashboardPage] è§„åˆ™é…ç½®ç¼“å­˜å·²åˆ·æ–°ï¼Œè§„åˆ™å¼•æ“å·²é‡æ–°åŠ è½½');
    setRuleConfigLoaded(true);
  };
  initRuleConfig();
}, [currentCompany]); // ğŸ”¥ ä¾èµ–currentCompanyï¼Œå…¬å¸å˜åŒ–æ—¶é‡æ–°åŠ è½½è§„åˆ™
```

### 2. è§„åˆ™å¼•æ“æ”¹è¿›

ä¿®æ”¹AttendanceRuleEngineï¼Œè®©å®ƒä½¿ç”¨æœ€æ–°çš„è§„åˆ™é…ç½®ç¼“å­˜ï¼š

```typescript
// AttendanceRuleEngine.ts
import { getRuleConfigSync } from '../../hooks/useAttendanceRuleConfig.ts';

private loadRules(): AttendanceRuleConfig {
  // ğŸ”¥ ä¼˜å…ˆä½¿ç”¨æœ€æ–°çš„è§„åˆ™é…ç½®ç¼“å­˜
  const config = getRuleConfigSync(this.companyKey);
  if (!config.rules) {
    throw new Error(`No attendance rules found for company: ${this.companyKey}`);
  }
  console.log(`[AttendanceRuleEngine] åŠ è½½ ${this.companyKey} è§„åˆ™é…ç½®`);
  return config.rules;
}
```

### 3. å…¨å±€ä¸€è‡´æ€§ä¿è¯

æ•´ä¸ªç³»ç»Ÿéƒ½é€šè¿‡AttendanceRuleManagerè·å–è§„åˆ™ï¼Œç¡®ä¿ä½¿ç”¨ç»Ÿä¸€çš„æœ€æ–°é…ç½®ï¼š

- **è€ƒå‹¤ç»Ÿè®¡è®¡ç®—**ï¼šuseAttendanceStats.ts ä½¿ç”¨ AttendanceRuleManager
- **è€ƒå‹¤ç¡®è®¤é¡µé¢**ï¼šDetailView.tsx ä½¿ç”¨ AttendanceRuleManager  
- **è€ƒå‹¤åˆ›å»ºå‘å¯¼**ï¼šCreateWizard.tsx ä½¿ç”¨ AttendanceRuleManager
- **ä»ªè¡¨ç›˜é¡µé¢**ï¼šAttendanceDashboardPage.tsx ä½¿ç”¨ AttendanceRuleManager

## ğŸ”„ è§„åˆ™åŠ è½½æµç¨‹

1. **é¡µé¢åˆå§‹åŒ–** â†’ ç”¨æˆ·è¿›å…¥è€ƒå‹¤ä»ªè¡¨ç›˜é¡µé¢
2. **å¼ºåˆ¶åˆ·æ–°è§„åˆ™é…ç½®** â†’ è°ƒç”¨ `refreshRuleConfigCache(currentCompany)`
3. **ä»æ•°æ®åº“åŠ è½½è§„åˆ™** â†’ GET `/api/v1/attendance/rules/:companyId`
4. **æ›´æ–°è§„åˆ™ç¼“å­˜** â†’ å°†æœ€æ–°è§„åˆ™å­˜å‚¨åˆ°å…¨å±€ç¼“å­˜ä¸­
5. **é‡æ–°åŠ è½½è§„åˆ™å¼•æ“** â†’ `AttendanceRuleManager.reloadAllRules()`
6. **è§„åˆ™å¼•æ“è·å–æœ€æ–°é…ç½®** â†’ ä½¿ç”¨ `getRuleConfigSync()` è·å–æœ€æ–°è§„åˆ™
7. **å¼€å§‹æ•°æ®åŠ è½½** â†’ ä½¿ç”¨æœ€æ–°è§„åˆ™è¿›è¡Œè€ƒå‹¤è®¡ç®—

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹

### 1. å¼ºåˆ¶åˆ·æ–°æœºåˆ¶
- æ¯æ¬¡è¿›å…¥é¡µé¢éƒ½ä»æ•°æ®åº“APIè·å–æœ€æ–°è§„åˆ™
- ä¸ä¾èµ–ç¼“å­˜æœ‰æ•ˆæœŸï¼Œç¡®ä¿è§„åˆ™çš„å®æ—¶æ€§

### 2. å…¬å¸çº§åˆ«éš”ç¦»
- æ”¯æŒæŒ‰å…¬å¸åˆ·æ–°è§„åˆ™ï¼š`refreshRuleConfigCache(currentCompany)`
- ä¸åŒå…¬å¸çš„è§„åˆ™äº’ä¸å½±å“

### 3. è§„åˆ™å¼•æ“åŒæ­¥
- è§„åˆ™é…ç½®æ›´æ–°åç«‹å³é‡æ–°åŠ è½½è§„åˆ™å¼•æ“
- ç¡®ä¿æ‰€æœ‰è®¡ç®—éƒ½ä½¿ç”¨æœ€æ–°è§„åˆ™

### 4. å…¨å±€ä¸€è‡´æ€§
- æ•´ä¸ªç³»ç»Ÿéƒ½é€šè¿‡AttendanceRuleManagerè·å–è§„åˆ™
- é¿å…ä¸åŒç»„ä»¶ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„è§„åˆ™

## ğŸ§ª æµ‹è¯•éªŒè¯

### é¢„æœŸè¡Œä¸ºï¼š
- âœ… æ¯æ¬¡è¿›å…¥è€ƒå‹¤ä»ªè¡¨ç›˜éƒ½ä¼šçœ‹åˆ°è§„åˆ™åŠ è½½æ—¥å¿—
- âœ… ä¿®æ”¹æ•°æ®åº“ä¸­çš„è§„åˆ™åï¼Œåˆ·æ–°é¡µé¢èƒ½ç«‹å³ç”Ÿæ•ˆ
- âœ… ä¸åŒå…¬å¸çš„è§„åˆ™é…ç½®ç›¸äº’ç‹¬ç«‹
- âœ… æ‰€æœ‰è€ƒå‹¤è®¡ç®—éƒ½ä½¿ç”¨æœ€æ–°çš„è§„åˆ™é…ç½®

### è°ƒè¯•ä¿¡æ¯ï¼š
åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­åº”è¯¥èƒ½çœ‹åˆ°ï¼š
```
[AttendanceDashboardPage] å¼ºåˆ¶åˆ·æ–° eyewind çš„è§„åˆ™é…ç½®
[refreshRuleConfigCache] å¼€å§‹åˆ·æ–°è§„åˆ™é…ç½®ç¼“å­˜: eyewind
[refreshRuleConfigCache] å·²ä»æ•°æ®åº“åŠ è½½ eyewind é…ç½®
[AttendanceRuleEngine] åŠ è½½ eyewind è§„åˆ™é…ç½®
[AttendanceDashboardPage] è§„åˆ™é…ç½®ç¼“å­˜å·²åˆ·æ–°ï¼Œè§„åˆ™å¼•æ“å·²é‡æ–°åŠ è½½
```

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### âœ… components/attendance/dashboard/AttendanceDashboardPage.tsx
- ä¿®æ”¹è§„åˆ™é…ç½®åˆå§‹åŒ–é€»è¾‘
- æ¯æ¬¡è¿›å…¥é¡µé¢å¼ºåˆ¶åˆ·æ–°å½“å‰å…¬å¸è§„åˆ™
- æ·»åŠ è§„åˆ™å¼•æ“é‡æ–°åŠ è½½
- ä¾èµ–currentCompanyï¼Œå…¬å¸å˜åŒ–æ—¶é‡æ–°åŠ è½½

### âœ… components/attendance/AttendanceRuleEngine.ts
- æ·»åŠ  `getRuleConfigSync` å¯¼å…¥
- ä¿®æ”¹ `loadRules` æ–¹æ³•ä½¿ç”¨æœ€æ–°è§„åˆ™ç¼“å­˜
- æ·»åŠ è§„åˆ™åŠ è½½æ—¥å¿—

### âœ… hooks/useAttendanceRuleConfig.ts
- `refreshRuleConfigCache` å·²æ”¯æŒæŒ‰å…¬å¸åˆ·æ–°
- æä¾› `getRuleConfigSync` è·å–æœ€æ–°è§„åˆ™

## ğŸ”„ è§„åˆ™æ›´æ–°å®Œæ•´æµç¨‹

1. **ç®¡ç†å‘˜ä¿®æ”¹è§„åˆ™** â†’ åœ¨è€ƒå‹¤è§„åˆ™è®¾ç½®é¡µé¢ä¿®æ”¹é…ç½®
2. **ä¿å­˜åˆ°æ•°æ®åº“** â†’ PUT `/api/v1/attendance/rules/:companyId`
3. **ç”¨æˆ·è¿›å…¥ä»ªè¡¨ç›˜** â†’ è§¦å‘è§„åˆ™å¼ºåˆ¶åˆ·æ–°
4. **è·å–æœ€æ–°è§„åˆ™** â†’ ä»æ•°æ®åº“åŠ è½½æœ€æ–°é…ç½®
5. **åº”ç”¨æ–°è§„åˆ™** â†’ æ‰€æœ‰è€ƒå‹¤è®¡ç®—ä½¿ç”¨æ–°è§„åˆ™

## ğŸ‰ åŠŸèƒ½å®Œæˆ

è€ƒå‹¤ä»ªè¡¨ç›˜ç°åœ¨æ¯æ¬¡è¿›å…¥éƒ½ä¼šåŠ è½½å½“å‰å…¬å¸çš„æœ€æ–°è€ƒå‹¤è§„åˆ™ï¼Œç¡®ä¿æ•´ä¸ªç³»ç»Ÿéƒ½ä½¿ç”¨æ•°æ®åº“ä¸­çš„æœ€æ–°é…ç½®è¿›è¡Œè®¡ç®—ã€‚è¿™ä¿è¯äº†ï¼š

- **å®æ—¶æ€§**ï¼šè§„åˆ™ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆ
- **ä¸€è‡´æ€§**ï¼šæ•´ä¸ªç³»ç»Ÿä½¿ç”¨ç»Ÿä¸€çš„è§„åˆ™é…ç½®
- **å‡†ç¡®æ€§**ï¼šæ‰€æœ‰è€ƒå‹¤è®¡ç®—éƒ½åŸºäºæœ€æ–°çš„è§„åˆ™
- **éš”ç¦»æ€§**ï¼šä¸åŒå…¬å¸çš„è§„åˆ™äº’ä¸å½±å“