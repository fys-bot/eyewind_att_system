<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒå‹¤é¡µé¢æœ€ç»ˆä¿®å¤éªŒè¯</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f8fafc;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .fix-summary {
            background: #dcfce7;
            border: 1px solid #16a34a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .log { 
            background: #f1f5f9; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #059669; }
        .info { color: #0284c7; }
        .warning { color: #d97706; }
        .error { color: #dc2626; }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
        button:hover {
            background: #f9fafb;
        }
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‰ è€ƒå‹¤é¡µé¢åŠ è½½é—®é¢˜æœ€ç»ˆä¿®å¤éªŒè¯</h1>
        
        <div class="fix-summary">
            <h3>âœ… ä¿®å¤æ€»ç»“</h3>
            <p><strong>é—®é¢˜ï¼š</strong>è€ƒå‹¤ç¡®è®¤é¡µé¢ä¸€ç›´æ˜¾ç¤º"æ­£åœ¨åŠ è½½è€ƒå‹¤æ•°æ®..."ï¼Œæ— æ³•å®ŒæˆåŠ è½½</p>
            
            <h4>ğŸ” æ ¹æœ¬åŸå› åˆ†æï¼š</h4>
            <ol>
                <li><strong>é—­åŒ…é—®é¢˜ï¼š</strong> loadDataå‡½æ•°çš„useCallbackä¾èµ–é¡¹ç¼ºå°‘globalMonthï¼Œå¯¼è‡´å‡½æ•°å†…éƒ¨ä½¿ç”¨çš„æ˜¯æ—§çš„globalMonthå€¼</li>
                <li><strong>404å¤„ç†é—®é¢˜ï¼š</strong> 404å“åº”åä»£ç ç»§ç»­æ‰§è¡Œï¼Œä½†æ²¡æœ‰æ­£ç¡®å¤„ç†æ•°æ®ç»“æ„ï¼Œå¯èƒ½å¯¼è‡´åç»­ä»£ç å‡ºé”™</li>
                <li><strong>æ— é™å¾ªç¯é£é™©ï¼š</strong> globalMonthå˜åŒ–æ—¶çš„useEffectåŒ…å«loadDataä¾èµ–ï¼Œå¯èƒ½å¯¼è‡´æ— é™å¾ªç¯</li>
            </ol>
            
            <h4>ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆï¼š</h4>
            <ol>
                <li>åœ¨loadDataçš„useCallbackä¾èµ–é¡¹ä¸­æ·»åŠ globalMonth</li>
                <li>ä¼˜åŒ–404å¤„ç†é€»è¾‘ï¼Œç¡®ä¿åœ¨404æƒ…å†µä¸‹ç›´æ¥è·³åˆ°finallyå—</li>
                <li>ç§»é™¤globalMonth useEffectä¸­çš„loadDataä¾èµ–ï¼Œé¿å…æ— é™å¾ªç¯</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h3>ğŸ§ª ä¿®å¤éªŒè¯æµ‹è¯•</h3>
            <button onclick="testCompleteFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
            <button onclick="test404Handling()">æµ‹è¯•404å¤„ç†</button>
            <button onclick="testMonthSwitching()">æµ‹è¯•æœˆä»½åˆ‡æ¢</button>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ ä¿®å¤å‰åå¯¹æ¯”</h3>
            
            <h4>ä¿®å¤å‰çš„é—®é¢˜ä»£ç ï¼š</h4>
            <div class="code-block">
// é—®é¢˜1: loadDataç¼ºå°‘globalMonthä¾èµ–
const loadData = useCallback(async () => {
    // ä½¿ç”¨globalMonthï¼Œä½†ä¾èµ–é¡¹ä¸­æ²¡æœ‰
    const loadUrl = globalMonth 
        ? `/api/v1/attendance/status/load/${globalMonth}`
        : "/api/v1/attendance/status/load";
}, [currentCompany, preloadedData]); // âŒ ç¼ºå°‘globalMonth

// é—®é¢˜2: 404å¤„ç†åç»§ç»­æ‰§è¡Œå¯èƒ½å‡ºé”™çš„ä»£ç 
if (response.status === 404) {
    // å¤„ç†404...
    // æ²¡æœ‰returnï¼Œç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç 
}
// åé¢çš„ä»£ç å¯èƒ½è®¿é—®ä¸å­˜åœ¨çš„apiResponse.data
            </div>
            
            <h4>ä¿®å¤åçš„ä»£ç ï¼š</h4>
            <div class="code-block">
// ä¿®å¤1: æ·»åŠ globalMonthä¾èµ–
const loadData = useCallback(async () => {
    const loadUrl = globalMonth 
        ? `/api/v1/attendance/status/load/${globalMonth}`
        : "/api/v1/attendance/status/load";
}, [currentCompany, preloadedData, globalMonth]); // âœ… æ·»åŠ globalMonth

// ä¿®å¤2: 404å¤„ç†ä¼˜åŒ–
if (response.status === 404) {
    // å¤„ç†404...
    // ç›´æ¥è·³åˆ°finallyå—ï¼Œä¸æ‰§è¡Œåç»­æ•°æ®å¤„ç†
} else if (!response.ok) {
    // å¤„ç†å…¶ä»–é”™è¯¯...
} else {
    // åªæœ‰æˆåŠŸæ—¶æ‰å¤„ç†æ•°æ®
}
            </div>
        </div>
        
        <div id="logs"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testCompleteFlow() {
            log('ğŸš€ å¼€å§‹æµ‹è¯•å®Œæ•´çš„è€ƒå‹¤é¡µé¢åŠ è½½æµç¨‹...', 'info');
            
            try {
                // æ¨¡æ‹Ÿé¡µé¢åŠ è½½è¿‡ç¨‹
                log('1. æ¨¡æ‹Ÿç»„ä»¶æŒ‚è½½ï¼ŒuseEffectè§¦å‘', 'info');
                log('2. hasInitializedä¸ºfalseï¼Œå¼€å§‹æ‰§è¡ŒloadData', 'info');
                
                // æµ‹è¯•å‘˜å·¥API
                log('3. è°ƒç”¨å‘˜å·¥API...', 'info');
                const employeeResponse = await fetch('/api/v1/employees');
                if (employeeResponse.ok) {
                    const employees = await employeeResponse.json();
                    log(`âœ… å‘˜å·¥APIæˆåŠŸï¼Œè·å–${employees.length || 0}ä¸ªå‘˜å·¥`, 'success');
                } else {
                    log(`âŒ å‘˜å·¥APIå¤±è´¥: ${employeeResponse.status}`, 'error');
                    return;
                }
                
                // æµ‹è¯•è€ƒå‹¤Load API
                log('4. è°ƒç”¨è€ƒå‹¤Load API...', 'info');
                const month = '2026-01';
                const loadUrl = `/api/v1/attendance/status/load/${month}`;
                log(`   è¯·æ±‚URL: ${loadUrl}`, 'info');
                
                const loadResponse = await fetch(loadUrl, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                log(`   å“åº”çŠ¶æ€: ${loadResponse.status}`, 'info');
                
                if (loadResponse.status === 404) {
                    const errorData = await loadResponse.json();
                    log('âœ… 404å¤„ç†æ­£å¸¸ - å½“å‰æœˆä»½æ— æ•°æ®', 'success');
                    log(`   é”™è¯¯ä¿¡æ¯: ${errorData.message}`, 'info');
                    log('5. æ‰§è¡Œfinallyå—ï¼Œè®¾ç½®loadingä¸ºfalse', 'info');
                    log('âœ… é¡µé¢åº”è¯¥æ˜¾ç¤º"å½“å‰æœˆä»½æ²¡æœ‰è€ƒå‹¤æ•°æ®"è€Œä¸æ˜¯ä¸€ç›´åŠ è½½', 'success');
                } else if (loadResponse.ok) {
                    const loadData = await loadResponse.json();
                    log('âœ… Load APIæˆåŠŸ', 'success');
                    log('5. å¤„ç†æ•°æ®ï¼Œè®¾ç½®sheetsçŠ¶æ€', 'info');
                    log('6. æ‰§è¡Œfinallyå—ï¼Œè®¾ç½®loadingä¸ºfalse', 'info');
                    log('âœ… é¡µé¢åº”è¯¥æ˜¾ç¤ºè€ƒå‹¤æ•°æ®åˆ—è¡¨', 'success');
                } else {
                    log(`âŒ Load APIå¤±è´¥: ${loadResponse.status}`, 'error');
                }
                
                log('ğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆï¼', 'success');
                
            } catch (error) {
                log(`âŒ æµç¨‹æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function test404Handling() {
            log('ğŸ›¡ï¸ å¼€å§‹æµ‹è¯•404å¤„ç†é€»è¾‘...', 'info');
            
            const testMonths = ['2026-01', '2025-01', '2024-01'];
            
            for (const month of testMonths) {
                try {
                    log(`æµ‹è¯•æœˆä»½: ${month}`, 'info');
                    const response = await fetch(`/api/v1/attendance/status/load/${month}`);
                    
                    if (response.status === 404) {
                        const errorData = await response.json();
                        log(`âœ… ${month}: 404å¤„ç†æ­£å¸¸`, 'success');
                        log(`   æ¶ˆæ¯: ${errorData.message}`, 'info');
                        log(`   âœ… å…³é”®ï¼šfinallyå—ä¼šæ‰§è¡Œï¼ŒloadingçŠ¶æ€ä¼šè¢«æ­£ç¡®è®¾ç½®ä¸ºfalse`, 'success');
                    } else if (response.ok) {
                        log(`âœ… ${month}: æœ‰æ•°æ® (${response.status})`, 'success');
                    } else {
                        log(`âš ï¸ ${month}: å…¶ä»–çŠ¶æ€ (${response.status})`, 'warning');
                    }
                } catch (error) {
                    log(`âŒ ${month}: å¼‚å¸¸ - ${error.message}`, 'error');
                }
            }
            
            log('âœ… 404å¤„ç†æµ‹è¯•å®Œæˆ', 'success');
        }

        async function testMonthSwitching() {
            log('ğŸ”„ å¼€å§‹æµ‹è¯•æœˆä»½åˆ‡æ¢é€»è¾‘...', 'info');
            
            // æ¨¡æ‹Ÿæœˆä»½åˆ‡æ¢åœºæ™¯
            const scenarios = [
                { from: null, to: '2026-01', desc: 'åˆå§‹åŠ è½½' },
                { from: '2026-01', to: '2025-12', desc: 'åˆ‡æ¢åˆ°ä¸Šä¸ªæœˆ' },
                { from: '2025-12', to: '2026-02', desc: 'åˆ‡æ¢åˆ°æœªæ¥æœˆä»½' }
            ];
            
            for (const { from, to, desc } of scenarios) {
                log(`ğŸ“… ${desc}: ${from || 'null'} -> ${to}`, 'info');
                
                // æ¨¡æ‹ŸloadDataå‡½æ•°çš„URLç”Ÿæˆï¼ˆä¿®å¤åï¼‰
                const loadUrl = to ? `/api/v1/attendance/status/load/${to}` : '/api/v1/attendance/status/load';
                log(`   ç”ŸæˆURL: ${loadUrl}`, 'info');
                
                // æµ‹è¯•å®é™…APIè°ƒç”¨
                try {
                    const response = await fetch(loadUrl);
                    if (response.status === 404) {
                        log(`   âœ… ${to}: æ— æ•°æ®ï¼Œä½†å¤„ç†æ­£å¸¸`, 'success');
                    } else if (response.ok) {
                        log(`   âœ… ${to}: æœ‰æ•°æ®`, 'success');
                    } else {
                        log(`   âš ï¸ ${to}: çŠ¶æ€ ${response.status}`, 'warning');
                    }
                } catch (error) {
                    log(`   âŒ ${to}: å¼‚å¸¸ - ${error.message}`, 'error');
                }
                
                // æ¨¡æ‹ŸuseEffectè§¦å‘æ¡ä»¶ï¼ˆä¿®å¤åï¼‰
                const hasInitialized = from !== null;
                const shouldTrigger = hasInitialized && to;
                
                if (shouldTrigger) {
                    log(`   âœ… globalMonth useEffectä¼šè§¦å‘é‡æ–°åŠ è½½`, 'success');
                } else {
                    log(`   â„¹ï¸ é¦–æ¬¡åŠ è½½ï¼Œç”±ä¸»useEffectå¤„ç†`, 'info');
                }
            }
            
            log('âœ… æœˆä»½åˆ‡æ¢æµ‹è¯•å®Œæˆ', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('è€ƒå‹¤é¡µé¢æœ€ç»ˆä¿®å¤éªŒè¯å·¥å…·åŠ è½½å®Œæˆ', 'success');
            log('', 'info');
            log('ğŸ¯ æœ¬æ¬¡ä¿®å¤è§£å†³çš„æ ¸å¿ƒé—®é¢˜:', 'info');
            log('1. loadDataå‡½æ•°é—­åŒ…é—®é¢˜ - globalMonthä¾èµ–ç¼ºå¤±', 'warning');
            log('2. 404å“åº”å¤„ç†ä¸å½“ - å¯èƒ½å¯¼è‡´åç»­ä»£ç å‡ºé”™', 'warning');
            log('3. useEffectä¾èµ–å¾ªç¯ - å¯èƒ½å¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“', 'warning');
            log('', 'info');
            log('âœ… ä¿®å¤åçš„é¢„æœŸæ•ˆæœ:', 'info');
            log('â€¢ é¡µé¢ä¸å†ä¸€ç›´æ˜¾ç¤º"æ­£åœ¨åŠ è½½è€ƒå‹¤æ•°æ®..."', 'success');
            log('â€¢ 404æƒ…å†µä¸‹æ˜¾ç¤º"å½“å‰æœˆä»½æ²¡æœ‰è€ƒå‹¤æ•°æ®"', 'success');
            log('â€¢ æœˆä»½åˆ‡æ¢æ—¶èƒ½æ­£ç¡®é‡æ–°åŠ è½½æ•°æ®', 'success');
            log('â€¢ æœ‰æ•°æ®æ—¶æ­£å¸¸æ˜¾ç¤ºè€ƒå‹¤åˆ—è¡¨', 'success');
            log('', 'info');
            log('ç°åœ¨å¯ä»¥å¼€å§‹éªŒè¯ä¿®å¤æ•ˆæœ...', 'info');
        };
    </script>
</body>
</html>