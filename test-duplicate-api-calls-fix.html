<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡å¤APIè°ƒç”¨é—®é¢˜ä¿®å¤éªŒè¯</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f8fafc;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .problem-analysis {
            background: #fef2f2;
            border: 1px solid #f87171;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .fix-summary {
            background: #dcfce7;
            border: 1px solid #16a34a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .log { 
            background: #f1f5f9; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #059669; }
        .info { color: #0284c7; }
        .warning { color: #d97706; }
        .error { color: #dc2626; }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
        button:hover {
            background: #f9fafb;
        }
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .api-counter {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ é‡å¤APIè°ƒç”¨é—®é¢˜ä¿®å¤éªŒè¯</h1>
        
        <div class="problem-analysis">
            <h3>âŒ é—®é¢˜åˆ†æ</h3>
            <p><strong>ç°è±¡ï¼š</strong>è¿›å…¥è€ƒå‹¤é¡µé¢æ—¶ï¼Œç³»ç»Ÿé‡å¤è°ƒç”¨APIæ¥å£ï¼ˆgettokenã€employeesã€punchç­‰ï¼‰</p>
            
            <h4>ğŸ” æ ¹æœ¬åŸå› ï¼š</h4>
            <ol>
                <li><strong>useEffectä¾èµ–å¾ªç¯ï¼š</strong> loadDataå‡½æ•°åŒ…å«globalMonthä¾èµ–ï¼Œå½“globalMonthå˜åŒ–æ—¶loadDataé‡æ–°åˆ›å»º</li>
                <li><strong>åˆå§‹åŒ–çŠ¶æ€é‡ç½®ï¼š</strong> globalMonth useEffectä¸­é‡ç½®hasInitializedRefï¼Œå¯¼è‡´ç¬¬ä¸€ä¸ªuseEffecté‡æ–°æ‰§è¡Œ</li>
                <li><strong>ç¼ºå°‘å˜åŒ–æ£€æµ‹ï¼š</strong> æ²¡æœ‰æ£€æµ‹globalMonthæ˜¯å¦çœŸæ­£å˜åŒ–ï¼Œå¯¼è‡´ç›¸åŒå€¼ä¹Ÿè§¦å‘é‡æ–°åŠ è½½</li>
            </ol>
        </div>
        
        <div class="fix-summary">
            <h3>âœ… ä¿®å¤æ–¹æ¡ˆ</h3>
            <ol>
                <li><strong>æ·»åŠ å˜åŒ–æ£€æµ‹ï¼š</strong> ä½¿ç”¨prevGlobalMonthRefè·Ÿè¸ªä¸Šä¸€æ¬¡çš„globalMonthå€¼</li>
                <li><strong>é¿å…çŠ¶æ€é‡ç½®ï¼š</strong> ä¸å†é‡ç½®hasInitializedRefï¼Œç›´æ¥è°ƒç”¨loadData</li>
                <li><strong>ç²¾ç¡®æ§åˆ¶è§¦å‘æ¡ä»¶ï¼š</strong> åªæœ‰åœ¨globalMonthçœŸæ­£å˜åŒ–æ—¶æ‰é‡æ–°åŠ è½½</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h3>ğŸ§ª APIè°ƒç”¨è®¡æ•°æµ‹è¯•</h3>
            <p>æµ‹è¯•åœ¨ä¸åŒåœºæ™¯ä¸‹APIçš„è°ƒç”¨æ¬¡æ•°ï¼ŒéªŒè¯æ˜¯å¦è¿˜æœ‰é‡å¤è°ƒç”¨</p>
            
            <div class="api-counter" id="apiCounter">
                <div>Token API è°ƒç”¨æ¬¡æ•°: <span id="tokenCount">0</span></div>
                <div>Employee API è°ƒç”¨æ¬¡æ•°: <span id="employeeCount">0</span></div>
                <div>Load API è°ƒç”¨æ¬¡æ•°: <span id="loadCount">0</span></div>
            </div>
            
            <button onclick="testInitialLoad()">æµ‹è¯•åˆå§‹åŠ è½½</button>
            <button onclick="testMonthSwitch()">æµ‹è¯•æœˆä»½åˆ‡æ¢</button>
            <button onclick="testSameMonthSwitch()">æµ‹è¯•ç›¸åŒæœˆä»½åˆ‡æ¢</button>
            <button onclick="resetCounters()">é‡ç½®è®¡æ•°å™¨</button>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ ä¿®å¤å‰åå¯¹æ¯”</h3>
            
            <h4>ä¿®å¤å‰çš„é—®é¢˜ä»£ç ï¼š</h4>
            <div class="code-block">
// é—®é¢˜1: globalMonth useEffecté‡ç½®åˆå§‹åŒ–çŠ¶æ€
useEffect(() => {
    if (hasInitializedRef.current && globalMonth) {
        hasInitializedRef.current = false; // âŒ é‡ç½®çŠ¶æ€ï¼Œå¯¼è‡´ç¬¬ä¸€ä¸ªuseEffecté‡æ–°æ‰§è¡Œ
        loadData();
    }
}, [globalMonth]);

// é—®é¢˜2: æ²¡æœ‰æ£€æµ‹globalMonthæ˜¯å¦çœŸæ­£å˜åŒ–
// å³ä½¿globalMonthå€¼ç›¸åŒï¼Œä¹Ÿä¼šè§¦å‘é‡æ–°åŠ è½½
            </div>
            
            <h4>ä¿®å¤åçš„ä»£ç ï¼š</h4>
            <div class="code-block">
// ä¿®å¤1: æ·»åŠ å˜åŒ–æ£€æµ‹
const prevGlobalMonthRef = useRef(globalMonth);

useEffect(() => {
    const hasGlobalMonthChanged = prevGlobalMonthRef.current !== globalMonth;
    
    if (hasInitializedRef.current && globalMonth && hasGlobalMonthChanged) {
        // âœ… åªæœ‰çœŸæ­£å˜åŒ–æ—¶æ‰é‡æ–°åŠ è½½
        loadData();
    }
    
    prevGlobalMonthRef.current = globalMonth; // âœ… æ›´æ–°ä¸Šä¸€æ¬¡çš„å€¼
}, [globalMonth, loadData]);
            </div>
        </div>
        
        <div id="logs"></div>
    </div>

    <script>
        let tokenCount = 0;
        let employeeCount = 0;
        let loadCount = 0;

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function updateCounter(api) {
            switch(api) {
                case 'token':
                    tokenCount++;
                    document.getElementById('tokenCount').textContent = tokenCount;
                    break;
                case 'employee':
                    employeeCount++;
                    document.getElementById('employeeCount').textContent = employeeCount;
                    break;
                case 'load':
                    loadCount++;
                    document.getElementById('loadCount').textContent = loadCount;
                    break;
            }
        }

        function resetCounters() {
            tokenCount = 0;
            employeeCount = 0;
            loadCount = 0;
            document.getElementById('tokenCount').textContent = '0';
            document.getElementById('employeeCount').textContent = '0';
            document.getElementById('loadCount').textContent = '0';
            log('è®¡æ•°å™¨å·²é‡ç½®', 'info');
        }

        async function testInitialLoad() {
            log('ğŸš€ å¼€å§‹æµ‹è¯•åˆå§‹åŠ è½½åœºæ™¯...', 'info');
            log('æ¨¡æ‹Ÿï¼šç»„ä»¶é¦–æ¬¡æŒ‚è½½ï¼ŒhasInitialized=false', 'info');
            
            try {
                // æ¨¡æ‹Ÿåˆå§‹åŠ è½½çš„APIè°ƒç”¨åºåˆ—
                log('1. è°ƒç”¨Token API...', 'info');
                const tokenResponse = await fetch('/api/v1/auth/token');
                updateCounter('token');
                if (tokenResponse.ok) {
                    log('âœ… Token APIæˆåŠŸ', 'success');
                } else {
                    log(`âŒ Token APIå¤±è´¥: ${tokenResponse.status}`, 'error');
                }
                
                log('2. è°ƒç”¨Employee API...', 'info');
                const employeeResponse = await fetch('/api/v1/employees');
                updateCounter('employee');
                if (employeeResponse.ok) {
                    log('âœ… Employee APIæˆåŠŸ', 'success');
                } else {
                    log(`âŒ Employee APIå¤±è´¥: ${employeeResponse.status}`, 'error');
                }
                
                log('3. è°ƒç”¨Load API...', 'info');
                const loadResponse = await fetch('/api/v1/attendance/status/load/2026-01');
                updateCounter('load');
                if (loadResponse.status === 404) {
                    log('âœ… Load APIè¿”å›404ï¼ˆæ­£å¸¸ï¼‰', 'success');
                } else if (loadResponse.ok) {
                    log('âœ… Load APIæˆåŠŸ', 'success');
                } else {
                    log(`âŒ Load APIå¤±è´¥: ${loadResponse.status}`, 'error');
                }
                
                log('ğŸ‰ åˆå§‹åŠ è½½æµ‹è¯•å®Œæˆ', 'success');
                log(`æ€»è°ƒç”¨æ¬¡æ•° - Token: ${tokenCount}, Employee: ${employeeCount}, Load: ${loadCount}`, 'info');
                
            } catch (error) {
                log(`âŒ åˆå§‹åŠ è½½æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function testMonthSwitch() {
            log('ğŸ”„ å¼€å§‹æµ‹è¯•æœˆä»½åˆ‡æ¢åœºæ™¯...', 'info');
            log('æ¨¡æ‹Ÿï¼šglobalMonthä»2026-01åˆ‡æ¢åˆ°2025-12', 'info');
            
            const beforeCounts = { token: tokenCount, employee: employeeCount, load: loadCount };
            
            try {
                // æ¨¡æ‹Ÿæœˆä»½åˆ‡æ¢åªéœ€è¦é‡æ–°è°ƒç”¨Load API
                log('æœˆä»½åˆ‡æ¢åº”è¯¥åªè°ƒç”¨Load APIï¼Œä¸è°ƒç”¨Tokenå’ŒEmployee API', 'warning');
                
                log('è°ƒç”¨æ–°æœˆä»½çš„Load API...', 'info');
                const loadResponse = await fetch('/api/v1/attendance/status/load/2025-12');
                updateCounter('load');
                
                if (loadResponse.status === 404) {
                    log('âœ… Load APIè¿”å›404ï¼ˆæ­£å¸¸ï¼‰', 'success');
                } else if (loadResponse.ok) {
                    log('âœ… Load APIæˆåŠŸ', 'success');
                } else {
                    log(`âŒ Load APIå¤±è´¥: ${loadResponse.status}`, 'error');
                }
                
                const afterCounts = { token: tokenCount, employee: employeeCount, load: loadCount };
                
                log('ğŸ‰ æœˆä»½åˆ‡æ¢æµ‹è¯•å®Œæˆ', 'success');
                log(`è°ƒç”¨æ¬¡æ•°å˜åŒ– - Token: ${beforeCounts.token}->${afterCounts.token}, Employee: ${beforeCounts.employee}->${afterCounts.employee}, Load: ${beforeCounts.load}->${afterCounts.load}`, 'info');
                
                if (afterCounts.token === beforeCounts.token && afterCounts.employee === beforeCounts.employee) {
                    log('âœ… æœˆä»½åˆ‡æ¢æ²¡æœ‰é‡å¤è°ƒç”¨Tokenå’ŒEmployee API', 'success');
                } else {
                    log('âŒ æœˆä»½åˆ‡æ¢é‡å¤è°ƒç”¨äº†Tokenæˆ–Employee API', 'error');
                }
                
            } catch (error) {
                log(`âŒ æœˆä»½åˆ‡æ¢æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function testSameMonthSwitch() {
            log('ğŸ”„ å¼€å§‹æµ‹è¯•ç›¸åŒæœˆä»½åˆ‡æ¢åœºæ™¯...', 'info');
            log('æ¨¡æ‹Ÿï¼šglobalMonthä»2026-01åˆ‡æ¢åˆ°2026-01ï¼ˆç›¸åŒå€¼ï¼‰', 'info');
            
            const beforeCounts = { token: tokenCount, employee: employeeCount, load: loadCount };
            
            // ç›¸åŒæœˆä»½åˆ‡æ¢ä¸åº”è¯¥è§¦å‘ä»»ä½•APIè°ƒç”¨
            log('ç›¸åŒæœˆä»½åˆ‡æ¢ä¸åº”è¯¥è§¦å‘ä»»ä½•APIè°ƒç”¨', 'warning');
            
            // ç­‰å¾…ä¸€ä¸‹ï¼Œæ¨¡æ‹ŸuseEffectçš„æ‰§è¡Œ
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const afterCounts = { token: tokenCount, employee: employeeCount, load: loadCount };
            
            log('ğŸ‰ ç›¸åŒæœˆä»½åˆ‡æ¢æµ‹è¯•å®Œæˆ', 'success');
            log(`è°ƒç”¨æ¬¡æ•°å˜åŒ– - Token: ${beforeCounts.token}->${afterCounts.token}, Employee: ${beforeCounts.employee}->${afterCounts.employee}, Load: ${beforeCounts.load}->${afterCounts.load}`, 'info');
            
            if (afterCounts.token === beforeCounts.token && 
                afterCounts.employee === beforeCounts.employee && 
                afterCounts.load === beforeCounts.load) {
                log('âœ… ç›¸åŒæœˆä»½åˆ‡æ¢æ²¡æœ‰è§¦å‘ä»»ä½•APIè°ƒç”¨', 'success');
            } else {
                log('âŒ ç›¸åŒæœˆä»½åˆ‡æ¢é”™è¯¯åœ°è§¦å‘äº†APIè°ƒç”¨', 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('é‡å¤APIè°ƒç”¨é—®é¢˜ä¿®å¤éªŒè¯å·¥å…·åŠ è½½å®Œæˆ', 'success');
            log('', 'info');
            log('ğŸ¯ æœ¬æ¬¡ä¿®å¤è§£å†³çš„é—®é¢˜:', 'info');
            log('1. è¿›å…¥é¡µé¢æ—¶é‡å¤è°ƒç”¨APIæ¥å£', 'warning');
            log('2. useEffectä¾èµ–å¾ªç¯å¯¼è‡´çš„æ— é™é‡æ–°æ¸²æŸ“', 'warning');
            log('3. ç›¸åŒglobalMonthå€¼ä¹Ÿè§¦å‘é‡æ–°åŠ è½½', 'warning');
            log('', 'info');
            log('âœ… ä¿®å¤åçš„é¢„æœŸæ•ˆæœ:', 'info');
            log('â€¢ åˆå§‹åŠ è½½ï¼šæ¯ä¸ªAPIåªè°ƒç”¨ä¸€æ¬¡', 'success');
            log('â€¢ æœˆä»½åˆ‡æ¢ï¼šåªé‡æ–°è°ƒç”¨Load API', 'success');
            log('â€¢ ç›¸åŒæœˆä»½ï¼šä¸è§¦å‘ä»»ä½•APIè°ƒç”¨', 'success');
            log('', 'info');
            log('ç°åœ¨å¯ä»¥å¼€å§‹æµ‹è¯•ä¿®å¤æ•ˆæœ...', 'info');
        };
    </script>
</body>
</html>