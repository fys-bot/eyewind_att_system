<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’‰é’‰æ¨é€åŠŸèƒ½ä¿®å¤éªŒè¯</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .code-block { background: #f8f9fa; padding: 15px; border-radius: 4px; border-left: 4px solid #007bff; margin: 10px 0; font-family: 'Courier New', monospace; white-space: pre-wrap; }
        .timeline { margin: 20px 0; }
        .timeline-item { display: flex; align-items: center; margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .timeline-step { background: #007bff; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; }
        .timeline-step.success { background: #28a745; }
        .timeline-step.error { background: #dc3545; }
        .timeline-step.warning { background: #ffc107; color: #212529; }
        h1, h2, h3 { color: #333; }
        .fix-summary { background: #e7f3ff; padding: 15px; border-radius: 4px; border-left: 4px solid #007bff; margin: 20px 0; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .comparison-item { padding: 15px; border-radius: 4px; }
        .before { background: #fff5f5; border-left: 4px solid #dc3545; }
        .after { background: #f0fff4; border-left: 4px solid #28a745; }
        .test-section { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 20px 0; }
        .api-endpoint { background: #e3f2fd; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é’‰é’‰æ¨é€åŠŸèƒ½CORSé—®é¢˜ä¿®å¤</h1>
        
        <div class="status success">
            <strong>âœ… ä¿®å¤å®Œæˆ</strong> - è§£å†³äº†å‰ç«¯ç›´æ¥è°ƒç”¨é’‰é’‰webhookçš„CORSé—®é¢˜ï¼Œå¹¶å¢å¼ºäº†è‰¾ç‰¹äººåŠŸèƒ½
        </div>

        <div class="fix-summary">
            <h3>ğŸ¯ é—®é¢˜åˆ†æ</h3>
            <p>ç”¨æˆ·åœ¨ç‚¹å‡»æ¨é€æ—¶é‡åˆ°CORSé”™è¯¯ï¼Œè¿™æ˜¯å› ä¸ºæµè§ˆå™¨çš„åŒæºç­–ç•¥é˜»æ­¢äº†å‰ç«¯ç›´æ¥è°ƒç”¨é’‰é’‰çš„webhookæ¥å£ã€‚</p>
            
            <h4>ğŸ” å…·ä½“é—®é¢˜ï¼š</h4>
            <ul>
                <li><strong>CORSé™åˆ¶</strong>ï¼šæµè§ˆå™¨é˜»æ­¢è·¨åŸŸè¯·æ±‚åˆ°é’‰é’‰æœåŠ¡å™¨</li>
                <li><strong>å®‰å…¨ç­–ç•¥</strong>ï¼šé’‰é’‰webhookä¸æ”¯æŒæµè§ˆå™¨ç›´æ¥è°ƒç”¨</li>
                <li><strong>è‰¾ç‰¹åŠŸèƒ½é™åˆ¶</strong>ï¼šéœ€è¦æ­£ç¡®çš„æ¶ˆæ¯æ ¼å¼å’Œç”¨æˆ·IDæ˜ å°„</li>
            </ul>
        </div>

        <h2>ğŸ”§ è§£å†³æ–¹æ¡ˆ</h2>
        
        <div class="comparison">
            <div class="comparison-item before">
                <h4>âŒ ä¿®å¤å‰ï¼ˆç›´æ¥è°ƒç”¨ï¼‰</h4>
                <div class="code-block">// âŒ å‰ç«¯ç›´æ¥è°ƒç”¨é’‰é’‰webhook
const response = await fetch(pushWebhook, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(payload)
});

// ç»“æœï¼šCORSé”™è¯¯</div>
                
                <div class="status error">
                    <strong>é—®é¢˜ï¼š</strong>æµè§ˆå™¨åŒæºç­–ç•¥é˜»æ­¢è·¨åŸŸè¯·æ±‚
                </div>
            </div>
            
            <div class="comparison-item after">
                <h4>âœ… ä¿®å¤åï¼ˆæœåŠ¡å™¨ä»£ç†ï¼‰</h4>
                <div class="code-block">// âœ… é€šè¿‡æœ¬åœ°æœåŠ¡å™¨ä»£ç†
const result = await sendDingTalkMessage({
  webhook: pushWebhook,
  content: pushContent,
  atUsers: atUsers
});

// æœåŠ¡å™¨ç«¯å¤„ç†CORSå’Œæ¶ˆæ¯æ ¼å¼</div>
                
                <div class="status success">
                    <strong>ä¿®å¤ï¼š</strong>æœ¬åœ°æœåŠ¡å™¨ä½œä¸ºä»£ç†ï¼Œé¿å…CORSé—®é¢˜
                </div>
            </div>
        </div>

        <h2>ğŸ—ï¸ æ¶æ„è®¾è®¡</h2>
        
        <div class="timeline">
            <div class="timeline-item">
                <div class="timeline-step success">1</div>
                <div>
                    <strong>å‰ç«¯å‘èµ·æ¨é€</strong><br>
                    <small>ç”¨æˆ·ç‚¹å‡»æ¨é€æŒ‰é’®ï¼Œè°ƒç”¨æœ¬åœ°API</small>
                </div>
            </div>
            
            <div class="timeline-item">
                <div class="timeline-step success">2</div>
                <div>
                    <strong>æœ¬åœ°æœåŠ¡å™¨æ¥æ”¶</strong><br>
                    <small>POST /api/v1/push/dingtalk</small>
                </div>
            </div>
            
            <div class="timeline-item">
                <div class="timeline-step success">3</div>
                <div>
                    <strong>å‚æ•°éªŒè¯å’Œå¤„ç†</strong><br>
                    <small>éªŒè¯webhookæ ¼å¼ï¼Œå¤„ç†è‰¾ç‰¹ç”¨æˆ·åˆ—è¡¨</small>
                </div>
            </div>
            
            <div class="timeline-item">
                <div class="timeline-step success">4</div>
                <div>
                    <strong>æ„å»ºé’‰é’‰æ¶ˆæ¯</strong><br>
                    <small>æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼Œæ·»åŠ @åŠŸèƒ½</small>
                </div>
            </div>
            
            <div class="timeline-item">
                <div class="timeline-step success">5</div>
                <div>
                    <strong>è°ƒç”¨é’‰é’‰API</strong><br>
                    <small>æœåŠ¡å™¨ç«¯å‘é€HTTPè¯·æ±‚åˆ°é’‰é’‰</small>
                </div>
            </div>
            
            <div class="timeline-item">
                <div class="timeline-step success">6</div>
                <div>
                    <strong>è¿”å›ç»“æœ</strong><br>
                    <small>å°†é’‰é’‰å“åº”è¿”å›ç»™å‰ç«¯</small>
                </div>
            </div>
        </div>

        <h2>ğŸ“‹ æ–°å¢æ–‡ä»¶å’Œä¿®æ”¹</h2>
        
        <h3>ğŸ†• æ–°å¢æœåŠ¡å™¨ç«¯æ–‡ä»¶</h3>
        
        <div class="api-endpoint">
        <strong>server/src/routes/push.ts</strong> - æ¨é€è·¯ç”±
        </div>
        <div class="code-block">// é’‰é’‰æœºå™¨äººæ¨é€æ¥å£
router.post('/dingtalk', async (req, res) => {
  // éªŒè¯å‚æ•°
  // æ„å»ºé’‰é’‰æ¶ˆæ¯æ ¼å¼
  // å¤„ç†è‰¾ç‰¹ç”¨æˆ·
  // å‘é€åˆ°é’‰é’‰
  // è¿”å›ç»“æœ
});</div>

        <div class="api-endpoint">
        <strong>services/pushApiService.ts</strong> - å‰ç«¯æ¨é€æœåŠ¡
        </div>
        <div class="code-block">// å‘é€é’‰é’‰æœºå™¨äººæ¶ˆæ¯
export async function sendDingTalkMessage(request: DingTalkPushRequest)

// éªŒè¯webhookæ ¼å¼
export function validateDingTalkWebhook(webhook: string)

// æ ¼å¼åŒ–è‰¾ç‰¹ç”¨æˆ·
export function formatAtUsers(users: AtUser[])</div>

        <h3>ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶</h3>
        
        <div class="api-endpoint">
        <strong>server/src/index.ts</strong> - æ³¨å†Œæ¨é€è·¯ç”±
        </div>
        <div class="code-block">import pushRouter from './routes/push';
app.use('/api/v1/push', pushRouter);</div>

        <div class="api-endpoint">
        <strong>server/package.json</strong> - æ·»åŠ axiosä¾èµ–
        </div>
        <div class="code-block">"dependencies": {
  "axios": "^1.6.0",
  // ... å…¶ä»–ä¾èµ–
}</div>

        <div class="api-endpoint">
        <strong>components/attendance/dashboard/AttendanceDashboardPage.tsx</strong> - ä½¿ç”¨æ–°æ¨é€æœåŠ¡
        </div>
        <div class="code-block">import { sendDingTalkMessage, validateDingTalkWebhook } from '../../../services/pushApiService.ts';

// ä¿®æ”¹handlePushå‡½æ•°ä½¿ç”¨æ–°æœåŠ¡</div>

        <h2>ğŸ¯ è‰¾ç‰¹åŠŸèƒ½å¢å¼º</h2>
        
        <div class="status info">
            <h4>æ”¯æŒçš„è‰¾ç‰¹æ–¹å¼ï¼š</h4>
            <ul>
                <li><strong>æ‰‹æœºå·è‰¾ç‰¹</strong>ï¼šé€šè¿‡atMobileså­—æ®µ</li>
                <li><strong>ç”¨æˆ·IDè‰¾ç‰¹</strong>ï¼šé€šè¿‡atUserIdså­—æ®µ</li>
                <li><strong>æ··åˆè‰¾ç‰¹</strong>ï¼šåŒæ—¶æ”¯æŒæ‰‹æœºå·å’Œç”¨æˆ·ID</li>
                <li><strong>é¢„è®¾è”ç³»äºº</strong>ï¼šæ”¯æŒè´¢åŠ¡ç­‰å¸¸ç”¨è”ç³»äºº</li>
            </ul>
        </div>

        <div class="code-block">// é’‰é’‰æ¶ˆæ¯æ ¼å¼
{
  "msgtype": "text",
  "text": {
    "content": "Hiï¼Œ@å¼ ä¸‰ @æå›› \n\né™„ä»¶å·²æäº¤ä¸º2025å¹´1æœˆé£çœ¼&æµ·å¤šå¤šè€ƒå‹¤..."
  },
  "at": {
    "atMobiles": ["13800138000", "13900139000"],
    "atUserIds": ["user123", "user456"],
    "isAtAll": false
  }
}</div>

        <h2>ğŸ§ª æµ‹è¯•éªŒè¯</h2>
        
        <div class="test-section">
            <h4>ğŸ” æµ‹è¯•æ­¥éª¤ï¼š</h4>
            <ol>
                <li><strong>å¯åŠ¨æœåŠ¡å™¨</strong>ï¼š<code>cd server && npm run dev</code></li>
                <li><strong>æµ‹è¯•è¿é€šæ€§</strong>ï¼šè®¿é—® <code>http://localhost:5000/api/v1/push/test</code></li>
                <li><strong>é…ç½®webhook</strong>ï¼šåœ¨æ¨é€å¼¹çª—ä¸­è¾“å…¥é’‰é’‰æœºå™¨äººwebhookåœ°å€</li>
                <li><strong>é€‰æ‹©è‰¾ç‰¹äººå‘˜</strong>ï¼šä»å‘˜å·¥åˆ—è¡¨ä¸­é€‰æ‹©è¦@çš„äºº</li>
                <li><strong>å‘é€æ¨é€</strong>ï¼šç‚¹å‡»"å‘é€æ¨é€"æŒ‰é’®</li>
                <li><strong>éªŒè¯ç»“æœ</strong>ï¼šæ£€æŸ¥é’‰é’‰ç¾¤æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯å’Œ@æé†’</li>
            </ol>
        </div>

        <div class="status success">
            <h4>âœ… é¢„æœŸç»“æœï¼š</h4>
            <ul>
                <li>ä¸å†å‡ºç°CORSé”™è¯¯</li>
                <li>èƒ½å¤ŸæˆåŠŸå‘é€æ¶ˆæ¯åˆ°é’‰é’‰ç¾¤</li>
                <li>è‰¾ç‰¹åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œè¢«@çš„äººä¼šæ”¶åˆ°æé†’</li>
                <li>æ¶ˆæ¯æ ¼å¼æ­£ç¡®ï¼Œå†…å®¹å®Œæ•´</li>
            </ul>
        </div>

        <div class="status warning">
            <h4>âš ï¸ æ³¨æ„äº‹é¡¹ï¼š</h4>
            <ul>
                <li>ç¡®ä¿æœåŠ¡å™¨å·²å¯åŠ¨ï¼ˆç«¯å£5000ï¼‰</li>
                <li>é’‰é’‰æœºå™¨äººwebhookåœ°å€å¿…é¡»æœ‰æ•ˆ</li>
                <li>è¢«@çš„äººå‘˜å¿…é¡»åœ¨é’‰é’‰ç¾¤ä¸­</li>
                <li>æ‰‹æœºå·æ ¼å¼è¦æ­£ç¡®ï¼ˆ11ä½æ•°å­—ï¼‰</li>
                <li>æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®</li>
            </ul>
        </div>

        <h2>ğŸ”§ æ•…éšœæ’é™¤</h2>
        
        <div class="code-block">// å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

1. "æ¨é€æœåŠ¡è¿æ¥å¤±è´¥"
   â†’ æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨ï¼šnpm run dev

2. "æ— æ•ˆçš„é’‰é’‰webhookåœ°å€"
   â†’ ç¡®ä¿webhookåŒ…å«access_tokenå‚æ•°

3. "é’‰é’‰æ¨é€å¤±è´¥: invalid webhook url"
   â†’ æ£€æŸ¥æœºå™¨äººæ˜¯å¦è¢«åˆ é™¤æˆ–webhookæ˜¯å¦è¿‡æœŸ

4. "ç½‘ç»œè¯·æ±‚å¤±è´¥"
   â†’ æ£€æŸ¥æœåŠ¡å™¨ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

5. "@åŠŸèƒ½ä¸ç”Ÿæ•ˆ"
   â†’ ç¡®ä¿è¢«@çš„äººåœ¨é’‰é’‰ç¾¤ä¸­ï¼Œæ‰‹æœºå·æ­£ç¡®</div>

        <h2>ğŸ“‹ APIæ–‡æ¡£</h2>
        
        <div class="api-endpoint">
        <strong>POST</strong> /api/v1/push/dingtalk
        </div>
        <div class="code-block">// è¯·æ±‚ä½“
{
  "webhook": "https://oapi.dingtalk.com/robot/send?access_token=...",
  "content": "æ¶ˆæ¯å†…å®¹",
  "atUsers": [
    {
      "name": "å¼ ä¸‰",
      "mobile": "13800138000",
      "userid": "user123"
    }
  ]
}

// å“åº”
{
  "code": 0,
  "message": "æ¨é€æˆåŠŸ",
  "data": {
    "success": true,
    "dingResponse": { "errcode": 0, "errmsg": "ok" }
  }
}</div>

        <div class="api-endpoint">
        <strong>GET</strong> /api/v1/push/test
        </div>
        <div class="code-block">// å“åº”
{
  "code": 0,
  "message": "æ¨é€æœåŠ¡æ­£å¸¸",
  "data": {
    "timestamp": "2025-01-31T10:30:00.000Z",
    "service": "push-service"
  }
}</div>

        <div class="status success">
            <strong>ğŸ‰ ä¿®å¤å®Œæˆï¼</strong> é’‰é’‰æ¨é€åŠŸèƒ½ç°åœ¨é€šè¿‡æœ¬åœ°æœåŠ¡å™¨ä»£ç†ï¼Œè§£å†³äº†CORSé—®é¢˜ï¼Œå¹¶æ”¯æŒå®Œæ•´çš„è‰¾ç‰¹åŠŸèƒ½ã€‚ç”¨æˆ·å¯ä»¥æ­£å¸¸æ¨é€è€ƒå‹¤æŠ¥å‘Šåˆ°é’‰é’‰ç¾¤ï¼Œå¹¶@æŒ‡å®šäººå‘˜ã€‚
        </div>
    </div>
</body>
</html>