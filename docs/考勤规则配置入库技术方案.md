# 考勤规则配置入库技术方案

## 1. 背景与目标

### 1.1 背景
当前考勤规则配置存储在浏览器 LocalStorage 中，存在以下问题：
- 数据无法跨设备同步
- 无法进行多用户协作管理
- 缺乏数据备份和恢复机制
- 无法追踪配置变更历史
- 不支持权限控制

### 1.2 目标
- 将考勤规则配置持久化到数据库
- 支持多公司、多租户配置管理
- 实现配置变更审计追踪
- 提供配置版本管理和回滚能力
- 保持与现有前端的兼容性

---

## 2. 现有配置结构分析

### 2.1 配置分类

| 分类 | 模块 | 说明 |
|------|------|------|
| 全局通用 | 作息时间配置 | 上下班时间、午休时间 |
| 全局通用 | 出勤天数规则 | 应出勤/正常出勤计算规则 |
| 行政管理 | 迟到规则配置 | 多条件迟到判定规则 |
| 行政管理 | 考勤弹性与豁免 | 月度豁免次数和时长 |
| 行政管理 | 加班统计规则 | 加班节点和周末加班规则 |
| 行政管理 | 跨天打卡规则 | 跨天打卡弹性安排 |
| 财务相关 | 全勤奖规则 | 全勤判定条件和奖金 |
| 财务相关 | 绩效扣款规则 | 阶梯式扣款规则 |
| 特殊规则 | 法定调班规则 | 补班日/放假日配置 |
| 特殊规则 | 居家办公规则 | 居家办公日期和条件 |
| 特殊规则 | 请假展示规则 | 请假类型展示标签 |

### 2.2 数据特点
- **主配置**：单值字段，如作息时间、开关状态、金额等
- **子规则**：一对多关系，如迟到规则、绩效扣款规则等
- **日期配置**：动态增减的日期列表，如调班日、居家办公日

---

## 3. 数据库设计

### 3.1 设计原则

1. **表名统一前缀**：所有表使用 `att_rule_` 前缀，便于识别和管理
2. **精简表数量**：将相似结构的规则合并，减少表数量
3. **使用 JSON 存储**：对于数据量小、结构简单的配置，直接使用 JSON 字段存储

### 3.2 表结构概览

| 表名 | 说明 | 数据量预估 |
|------|------|------------|
| `att_rule_config` | 主配置表 | 每公司1条 |
| `att_rule_detail` | 通用规则明细表 | 每公司约20-50条 |
| `att_rule_special_date` | 特殊日期表 | 每公司每年约10-30条 |
| `att_rule_change_log` | 变更历史表 | 按操作累积 |

**优化说明**：从原来的 9 张表精简为 4 张表

### 3.3 ER 图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         att_rule_config (主配置表)                           │
│  - 基础作息时间、豁免配置、绩效配置、全勤配置                                   │
│  - 出勤天数配置、调班/居家办公开关、加班/跨天打卡配置                           │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          │ 1:N
          ▼
┌──────────────────────────┐  ┌──────────────────────────┐
│   att_rule_detail        │  │  att_rule_special_date   │
│   通用规则明细表          │  │  特殊日期表               │
│   - 迟到规则             │  │  - 调班日期               │
│   - 绩效扣款规则         │  │  - 居家办公日期           │
│   - 全勤判定规则         │  │                          │
│   - 请假展示规则         │  │                          │
│   - 跨天打卡规则         │  │                          │
└──────────────────────────┘  └──────────────────────────┘

┌──────────────────────────┐
│   att_rule_change_log    │
│   变更历史表              │
└──────────────────────────┘
```

### 3.4 公司主体说明

系统支持两个公司主体，所有配置表通过 `company_id` 字段区分：

| company_id | 公司名称 | 说明 |
|------------|----------|------|
| `eyewind` | 风眼科技 | 风眼主体公司 |
| `hydodo` | 海多多 | 海多多主体公司 |

### 3.5 表结构详细设计

#### 3.5.1 主配置表 (att_rule_config)

```sql
CREATE TABLE att_rule_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    company_id ENUM('eyewind','hydodo') NOT NULL COMMENT '公司主体：eyewind=风眼科技, hydodo=海多多',
    config_name VARCHAR(128) DEFAULT '默认配置' COMMENT '配置名称',
    
    -- ========== 基础作息时间 ==========
    work_start_time TIME NOT NULL DEFAULT '09:00:00' COMMENT '上班时间',
    work_end_time TIME NOT NULL DEFAULT '18:30:00' COMMENT '下班时间',
    lunch_start_time TIME DEFAULT '12:00:00' COMMENT '午休开始',
    lunch_end_time TIME DEFAULT '13:30:00' COMMENT '午休结束',
    
    -- ========== 豁免配置 ==========
    late_exemption_enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用豁免',
    late_exemption_count INT DEFAULT 3 COMMENT '月度豁免次数',
    late_exemption_minutes INT DEFAULT 15 COMMENT '单次豁免时长(分钟)',
    
    -- ========== 绩效扣款配置 ==========
    perf_penalty_enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用绩效扣款',
    perf_penalty_mode ENUM('unlimited','capped') DEFAULT 'capped' COMMENT '扣款主模式：unlimited=上不封顶, capped=封顶模式',
    -- 上不封顶模式配置
    unlimited_threshold_time TIME DEFAULT '09:01:00' COMMENT '迟到起算时间(上不封顶模式)',
    unlimited_calc_type ENUM('perMinute','fixed') DEFAULT 'perMinute' COMMENT '计算方式：perMinute=按分钟, fixed=固定扣款',
    unlimited_per_minute DECIMAL(10,2) DEFAULT 5.00 COMMENT '每分钟扣款金额',
    unlimited_fixed_amount DECIMAL(10,2) DEFAULT 50.00 COMMENT '固定扣款金额(每次迟到)',
    -- 封顶模式配置
    capped_penalty_type ENUM('ladder','fixedCap') DEFAULT 'ladder' COMMENT '封顶子模式：ladder=阶梯扣款, fixedCap=固定封顶',
    capped_per_minute DECIMAL(10,2) DEFAULT 5.00 COMMENT '每分钟扣款金额(固定封顶模式)',
    max_perf_penalty DECIMAL(10,2) DEFAULT 250.00 COMMENT '绩效扣款封顶金额',
    
    -- ========== 全勤配置 ==========
    full_attend_enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用全勤',
    full_attend_bonus DECIMAL(10,2) DEFAULT 200.00 COMMENT '全勤奖金额',
    full_attend_allow_adj BOOLEAN DEFAULT TRUE COMMENT '调休是否算全勤',
    
    -- ========== 出勤天数配置 ==========
    attend_days_enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用出勤统计',
    should_attend_calc ENUM('workdays','fixed','custom') DEFAULT 'workdays' COMMENT '应出勤计算方式',
    fixed_should_days INT DEFAULT NULL COMMENT '固定应出勤天数',
    exclude_holidays BOOLEAN DEFAULT TRUE COMMENT '排除法定节假日',
    exclude_weekends BOOLEAN DEFAULT TRUE COMMENT '排除周末',
    count_late_as_attend BOOLEAN DEFAULT TRUE COMMENT '迟到算出勤',
    count_missing_as_attend BOOLEAN DEFAULT TRUE COMMENT '缺卡算出勤',
    count_half_leave_as_half BOOLEAN DEFAULT TRUE COMMENT '半天假算0.5天',
    min_hours_for_full_day DECIMAL(4,2) DEFAULT 4.00 COMMENT '满足出勤的最少工时',
    
    -- ========== 法定调班配置 ==========
    workday_swap_enabled BOOLEAN DEFAULT FALSE COMMENT '是否启用法定调班',
    auto_follow_national BOOLEAN DEFAULT TRUE COMMENT '自动跟随国家调休',
    
    -- ========== 居家办公配置 ==========
    remote_work_enabled BOOLEAN DEFAULT FALSE COMMENT '是否启用居家办公',
    remote_require_approval BOOLEAN DEFAULT TRUE COMMENT '居家办公需审批',
    remote_count_as_attend BOOLEAN DEFAULT TRUE COMMENT '居家算正常出勤',
    remote_max_days_month INT DEFAULT NULL COMMENT '每月最多居家天数',
    remote_max_hours_month DECIMAL(5,2) DEFAULT NULL COMMENT '每月最多居家小时数',
    remote_allowed_weekdays JSON DEFAULT NULL COMMENT '允许居家的星期几 [1,2,3,4,5]',
    remote_default_time_mode ENUM('day','hour') DEFAULT 'day' COMMENT '默认时间模式',
    
    -- ========== 加班配置 ==========
    overtime_checkpoints JSON DEFAULT '["19:30","20:30","22:00","24:00"]' COMMENT '加班统计节点',
    weekend_overtime_threshold INT DEFAULT 8 COMMENT '周末加班影响周一阈值(小时)',
    
    -- ========== 跨天打卡配置 ==========
    cross_day_enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用跨天打卡',
    cross_day_max_checkout TIME DEFAULT '24:00:00' COMMENT '最晚打卡时间',
    cross_day_next_checkin TIME DEFAULT '13:30:00' COMMENT '次日最晚打卡时间',
    
    -- ========== 元数据 ==========
    version INT DEFAULT 1 COMMENT '配置版本号',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否生效',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by VARCHAR(64) COMMENT '创建人',
    updated_by VARCHAR(64) COMMENT '最后修改人',
    
    UNIQUE KEY uk_company_active (company_id, is_active),
    INDEX idx_company_id (company_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='考勤规则主配置表';
```

#### 3.5.2 通用规则明细表 (att_rule_detail)

将迟到规则、绩效扣款规则、全勤判定规则、请假展示规则、跨天打卡规则合并为一张表，通过 `rule_type` 区分。

```sql
CREATE TABLE att_rule_detail (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    config_id BIGINT NOT NULL COMMENT '关联主配置ID',
    rule_type ENUM(
        'late',           -- 迟到规则
        'penalty',        -- 绩效扣款阶梯规则
        'full_attend',    -- 全勤判定规则
        'leave_display',  -- 请假展示规则
        'cross_day'       -- 跨天打卡规则
    ) NOT NULL COMMENT '规则类型',
    
    -- ========== 通用字段 ==========
    rule_key VARCHAR(64) DEFAULT NULL COMMENT '规则键(如考勤类型: late/sick/annual等)',
    rule_name VARCHAR(128) DEFAULT NULL COMMENT '规则名称/显示名称',
    enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    sort_order INT DEFAULT 0 COMMENT '排序',
    description VARCHAR(256) DEFAULT NULL COMMENT '规则描述',
    
    -- ========== 时间相关字段 ==========
    time_start TIME DEFAULT NULL COMMENT '开始时间(迟到规则:前一天打卡时间; 跨天规则:打卡时间)',
    time_end TIME DEFAULT NULL COMMENT '结束时间(迟到规则:迟到阈值时间; 跨天规则:次日打卡时间)',
    
    -- ========== 数值相关字段 ==========
    min_value INT DEFAULT NULL COMMENT '最小值(绩效规则:最小分钟数; 全勤规则:阈值)',
    max_value INT DEFAULT NULL COMMENT '最大值(绩效规则:最大分钟数, 999=无上限)',
    amount DECIMAL(10,2) DEFAULT NULL COMMENT '金额(绩效规则:扣款金额)',
    threshold_hours INT DEFAULT NULL COMMENT '小时阈值(请假展示规则:分界时长)',
    
    -- ========== 文本相关字段 ==========
    unit ENUM('count','hours') DEFAULT NULL COMMENT '单位(全勤规则)',
    label_short VARCHAR(64) DEFAULT NULL COMMENT '短期标签(请假展示规则)',
    label_long VARCHAR(64) DEFAULT NULL COMMENT '长期标签(请假展示规则)',
    
    -- ========== 元数据 ==========
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_config_id (config_id),
    INDEX idx_rule_type (rule_type),
    INDEX idx_config_type (config_id, rule_type),
    FOREIGN KEY (config_id) REFERENCES att_rule_config(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='考勤规则明细表(通用)';
```

**各规则类型字段使用说明：**

| rule_type | 使用字段 | 说明 |
|-----------|----------|------|
| `late` | time_start, time_end, description | 前一天打卡时间 → 迟到阈值时间 |
| `penalty` | min_value, max_value, amount, description | 迟到分钟区间 → 扣款金额 |
| `full_attend` | rule_key, rule_name, enabled, min_value, unit | 考勤类型 → 阈值判定 |
| `leave_display` | rule_key, threshold_hours, label_short, label_long | 请假类型 → 展示标签 |
| `cross_day` | time_start, time_end, description | 打卡时间 → 次日打卡时间 |

**数据示例：**

```sql
-- 迟到规则示例
INSERT INTO att_rule_detail (config_id, rule_type, time_start, time_end, description, sort_order) VALUES
(1, 'late', '18:30:00', '09:01:00', '前一天18:30打卡，9:01算迟到', 1),
(1, 'late', '20:30:00', '09:31:00', '前一天20:30打卡，9:31算迟到', 2),
(1, 'late', '24:00:00', '13:31:00', '前一天24:00打卡，13:31算迟到', 3);

-- 绩效扣款阶梯规则示例
INSERT INTO att_rule_detail (config_id, rule_type, min_value, max_value, amount, description, sort_order) VALUES
(1, 'penalty', 0, 5, 50.00, '迟到0-5分钟扣50元', 1),
(1, 'penalty', 5, 15, 100.00, '迟到5-15分钟扣100元', 2),
(1, 'penalty', 15, 30, 150.00, '迟到15-30分钟扣150元', 3),
(1, 'penalty', 30, 45, 200.00, '迟到30-45分钟扣200元', 4),
(1, 'penalty', 45, 999, 250.00, '迟到45分钟以上扣250元(封顶)', 5);

-- 全勤判定规则示例
INSERT INTO att_rule_detail (config_id, rule_type, rule_key, rule_name, enabled, min_value, unit, sort_order) VALUES
(1, 'full_attend', 'late', '迟到', TRUE, 0, 'count', 1),
(1, 'full_attend', 'missing', '缺卡', TRUE, 0, 'count', 2),
(1, 'full_attend', 'sick', '病假', TRUE, 0, 'hours', 3),
(1, 'full_attend', 'annual', '年假', TRUE, 0, 'hours', 4);

-- 请假展示规则示例
INSERT INTO att_rule_detail (config_id, rule_type, rule_key, threshold_hours, label_short, label_long, sort_order) VALUES
(1, 'leave_display', '病假', 24, '病假<=24小时', '病假>24小时', 1);

-- 跨天打卡规则示例
INSERT INTO att_rule_detail (config_id, rule_type, time_start, time_end, description, sort_order) VALUES
(1, 'cross_day', '20:30:00', '09:30:00', '晚上8点半打卡，第二天可以早上9点半打卡', 1);
```

#### 3.5.3 特殊日期表 (att_rule_special_date)

将调班日期和居家办公日期合并为一张表，通过 `date_type` 区分。

```sql
CREATE TABLE att_rule_special_date (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    config_id BIGINT NOT NULL COMMENT '关联主配置ID',
    date_type ENUM('swap','remote') NOT NULL COMMENT '日期类型：swap=调班, remote=居家办公',
    target_date DATE NOT NULL COMMENT '目标日期',
    reason VARCHAR(256) DEFAULT NULL COMMENT '原因说明',
    
    -- ========== 调班专用字段 (date_type='swap') ==========
    swap_type ENUM('workday','holiday') DEFAULT NULL COMMENT '调班类型：workday=需上班, holiday=不需上班',
    
    -- ========== 居家办公专用字段 (date_type='remote') ==========
    time_mode ENUM('day','hour') DEFAULT 'day' COMMENT '时间模式：day=按天, hour=按小时',
    start_time TIME DEFAULT NULL COMMENT '开始时间(按小时模式)',
    end_time TIME DEFAULT NULL COMMENT '结束时间(按小时模式)',
    duration_hours DECIMAL(4,2) DEFAULT NULL COMMENT '居家时长(小时)',
    scope ENUM('all','department','individual') DEFAULT 'all' COMMENT '适用范围',
    scope_ids JSON DEFAULT NULL COMMENT '范围ID列表(部门ID或员工ID)',
    
    -- ========== 元数据 ==========
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(64) DEFAULT NULL COMMENT '创建人',
    
    INDEX idx_config_id (config_id),
    INDEX idx_date_type (date_type),
    INDEX idx_target_date (target_date),
    UNIQUE KEY uk_config_date_type (config_id, target_date, date_type),
    FOREIGN KEY (config_id) REFERENCES att_rule_config(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='考勤特殊日期表(调班/居家办公)';
```

**数据示例：**

```sql
-- 调班日期示例
INSERT INTO att_rule_special_date (config_id, date_type, target_date, reason, swap_type) VALUES
(1, 'swap', '2026-02-07', '春节调休补班', 'workday'),
(1, 'swap', '2026-02-08', '公司周年庆放假', 'holiday');

-- 居家办公日期示例（按天模式）
INSERT INTO att_rule_special_date (config_id, date_type, target_date, reason, time_mode, scope) VALUES
(1, 'remote', '2026-02-10', '恶劣天气', 'day', 'all');

-- 居家办公日期示例（按小时模式）
INSERT INTO att_rule_special_date (config_id, date_type, target_date, reason, time_mode, start_time, end_time, duration_hours, scope) VALUES
(1, 'remote', '2026-02-11', '设备维护', 'hour', '09:00:00', '12:00:00', 3.00, 'all');
```

#### 3.5.4 变更历史表 (att_rule_change_log)

```sql
CREATE TABLE att_rule_change_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    config_id BIGINT NOT NULL COMMENT '关联主配置ID',
    change_type ENUM('create','update','delete','rollback') NOT NULL COMMENT '变更类型',
    change_field VARCHAR(128) DEFAULT NULL COMMENT '变更字段',
    old_value TEXT DEFAULT NULL COMMENT '变更前值',
    new_value TEXT DEFAULT NULL COMMENT '变更后值',
    snapshot JSON DEFAULT NULL COMMENT '完整配置快照(用于回滚)',
    change_reason VARCHAR(512) DEFAULT NULL COMMENT '变更原因',
    changed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    changed_by VARCHAR(64) NOT NULL COMMENT '操作人',
    
    INDEX idx_config_id (config_id),
    INDEX idx_changed_at (changed_at),
    FOREIGN KEY (config_id) REFERENCES att_rule_config(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='考勤规则变更历史表';
```

### 3.6 表结构对比（优化前 vs 优化后）

| 优化前 | 优化后 | 说明 |
|--------|--------|------|
| `attendance_rule_config` | `att_rule_config` | 主配置表，统一前缀 |
| `late_rule` | `att_rule_detail` (rule_type='late') | 合并到通用规则表 |
| `performance_penalty_rule` | `att_rule_detail` (rule_type='penalty') | 合并到通用规则表 |
| `full_attendance_rule` | `att_rule_detail` (rule_type='full_attend') | 合并到通用规则表 |
| `leave_display_rule` | `att_rule_detail` (rule_type='leave_display') | 合并到通用规则表 |
| `cross_day_rule` | `att_rule_detail` (rule_type='cross_day') | 合并到通用规则表 |
| `workday_swap_date` | `att_rule_special_date` (date_type='swap') | 合并到特殊日期表 |
| `remote_work_date` | `att_rule_special_date` (date_type='remote') | 合并到特殊日期表 |
| `config_change_history` | `att_rule_change_log` | 统一前缀 |

**优化效果**：从 9 张表精简为 4 张表，减少 55% 的表数量。

---

## 4. API 接口设计

### 4.1 RESTful API 规范

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/v1/attendance/rules/{companyId}` | 获取公司完整配置 |
| PUT | `/api/v1/attendance/rules/{companyId}` | 更新完整配置 |
| PATCH | `/api/v1/attendance/rules/{companyId}` | 部分更新配置 |
| GET | `/api/v1/attendance/rules/{companyId}/history` | 获取变更历史 |
| POST | `/api/v1/attendance/rules/{companyId}/rollback` | 回滚到指定版本 |

### 4.2 接口详细设计

#### 4.2.1 获取配置

```http
GET /api/v1/attendance/rules/{companyId}
Authorization: Bearer {token}

Response 200:
{
    "code": 0,
    "data": {
        "id": 1,
        "companyId": "eyewind",
        "version": 3,
        "workStartTime": "09:00",
        "workEndTime": "18:30",
        "lunchStartTime": "12:00",
        "lunchEndTime": "13:30",
        "lateRules": [...],
        "performancePenaltyRules": [...],
        "fullAttendanceRules": [...],
        "leaveDisplayRules": [...],
        "crossDayRules": [...],
        "workdaySwapDates": [...],
        "remoteWorkDates": [...],
        "updatedAt": "2026-01-30T10:00:00Z",
        "updatedBy": "admin"
    }
}
```

#### 4.2.2 更新配置

```http
PUT /api/v1/attendance/rules/{companyId}
Authorization: Bearer {token}
Content-Type: application/json

Request Body:
{
    "workStartTime": "09:00",
    "workEndTime": "18:30",
    "lateRules": [...],
    "performancePenaltyRules": [...],
    "changeReason": "调整迟到规则"
}

Response 200:
{
    "code": 0,
    "data": {
        "id": 1,
        "version": 4,
        "updatedAt": "2026-01-30T11:00:00Z"
    }
}
```

### 4.3 错误码定义

| 错误码 | 说明 |
|--------|------|
| 40001 | 配置不存在 |
| 40002 | 配置版本冲突 |
| 40003 | 参数校验失败 |
| 40004 | 历史记录不存在 |
| 40005 | 无权限操作 |

---

## 5. 数据迁移策略

### 5.1 迁移流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ 1. 导出  │ ──▶ │ 2. 转换  │ ──▶ │ 3. 校验  │ ──▶ │ 4. 导入  │
│LocalStorage│   │ 数据格式 │     │ 数据完整 │     │ 数据库   │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
                                                        │
                                                        ▼
                                 ┌──────────┐     ┌──────────┐
                                 │ 6. 清理  │ ◀── │ 5. 验证  │
                                 │LocalStorage│   │ 功能正常 │
                                 └──────────┘     └──────────┘
```

### 5.2 迁移脚本示例

```typescript
// services/migrationService.ts

export async function migrateLocalStorageToDatabase(): Promise<MigrationResult> {
    const localConfigs = localStorage.getItem('attendanceRuleConfigs');
    if (!localConfigs) return { success: false, errors: ['无本地配置'] };
    
    const configs = JSON.parse(localConfigs);
    
    for (const [companyId, config] of Object.entries(configs)) {
        // 1. 插入主配置
        const configId = await insertMainConfig(companyId, config);
        
        // 2. 插入规则明细
        await insertRuleDetails(configId, 'late', config.lateRules);
        await insertRuleDetails(configId, 'penalty', config.performancePenaltyRules);
        await insertRuleDetails(configId, 'full_attend', config.fullAttendanceRules);
        await insertRuleDetails(configId, 'leave_display', config.leaveDisplayRules);
        await insertRuleDetails(configId, 'cross_day', config.crossDayCheckout?.rules);
        
        // 3. 插入特殊日期
        await insertSpecialDates(configId, 'swap', config.workdaySwapRules?.customDays);
        await insertSpecialDates(configId, 'remote', config.remoteWorkRules?.remoteDays);
    }
    
    return { success: true };
}
```

---

## 6. 缓存策略

### 6.1 多级缓存架构

```
┌──────────────┐
│   前端请求   │
└──────┬───────┘
       │
       ▼
┌──────────────┐     命中
│  内存缓存    │ ─────────▶ 返回
│  (5分钟)     │
└──────┬───────┘
       │ 未命中
       ▼
┌──────────────┐     命中
│  IndexedDB   │ ─────────▶ 返回 + 更新内存
│  (24小时)    │
└──────┬───────┘
       │ 未命中
       ▼
┌──────────────┐     命中
│  Redis       │ ─────────▶ 返回 + 更新本地
│  (1小时)     │
└──────┬───────┘
       │ 未命中
       ▼
┌──────────────┐
│   数据库     │ ─────────▶ 返回 + 更新所有缓存
└──────────────┘
```

---

## 7. 权限控制设计

### 7.1 权限矩阵

| 角色 | 查看配置 | 修改配置 | 查看历史 | 回滚配置 |
|------|----------|----------|----------|----------|
| 超级管理员 | ✅ | ✅ | ✅ | ✅ |
| 公司管理员 | ✅ | ✅ | ✅ | ✅ |
| HR主管 | ✅ | ✅ | ✅ | ❌ |
| HR专员 | ✅ | ❌ | ✅ | ❌ |
| 普通员工 | ❌ | ❌ | ❌ | ❌ |

### 7.2 权限码定义

```typescript
export const ATT_RULE_PERMISSIONS = {
    VIEW: 'att:rules:view',
    EDIT: 'att:rules:edit',
    HISTORY: 'att:rules:history',
    ROLLBACK: 'att:rules:rollback'
} as const;
```

---

## 8. 实施计划

### 8.1 阶段划分

| 阶段 | 内容 | 时间 | 交付物 |
|------|------|------|--------|
| 第一阶段 | 数据库设计与建表 | 1周 | DDL脚本、ER图 |
| 第二阶段 | 后端API开发 | 2周 | API接口、单元测试 |
| 第三阶段 | 前端适配改造 | 1周 | 前端代码、集成测试 |
| 第四阶段 | 数据迁移与双写 | 1周 | 迁移脚本、监控面板 |
| 第五阶段 | 灰度发布与验证 | 1周 | 灰度方案、回滚预案 |
| 第六阶段 | 全量切换与清理 | 1周 | 清理脚本、文档更新 |

### 8.2 风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 数据迁移失败 | 配置丢失 | 迁移前备份、支持回滚 |
| API性能问题 | 页面加载慢 | 多级缓存、性能监控 |
| 并发冲突 | 配置覆盖 | 乐观锁、版本号校验 |
| 权限漏洞 | 数据泄露 | 权限审计、安全测试 |

---

## 9. 附录

### 9.1 完整建表脚本

```sql
-- =============================================
-- 考勤规则配置数据库建表脚本
-- 表名前缀: att_rule_
-- =============================================

-- 1. 主配置表
CREATE TABLE att_rule_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    company_id ENUM('eyewind','hydodo') NOT NULL,
    config_name VARCHAR(128) DEFAULT '默认配置',
    work_start_time TIME NOT NULL DEFAULT '09:00:00',
    work_end_time TIME NOT NULL DEFAULT '18:30:00',
    lunch_start_time TIME DEFAULT '12:00:00',
    lunch_end_time TIME DEFAULT '13:30:00',
    late_exemption_enabled BOOLEAN DEFAULT TRUE,
    late_exemption_count INT DEFAULT 3,
    late_exemption_minutes INT DEFAULT 15,
    perf_penalty_enabled BOOLEAN DEFAULT TRUE,
    perf_penalty_mode ENUM('unlimited','capped') DEFAULT 'capped',
    unlimited_threshold_time TIME DEFAULT '09:01:00',
    unlimited_calc_type ENUM('perMinute','fixed') DEFAULT 'perMinute',
    unlimited_per_minute DECIMAL(10,2) DEFAULT 5.00,
    unlimited_fixed_amount DECIMAL(10,2) DEFAULT 50.00,
    capped_penalty_type ENUM('ladder','fixedCap') DEFAULT 'ladder',
    capped_per_minute DECIMAL(10,2) DEFAULT 5.00,
    max_perf_penalty DECIMAL(10,2) DEFAULT 250.00,
    full_attend_enabled BOOLEAN DEFAULT TRUE,
    full_attend_bonus DECIMAL(10,2) DEFAULT 200.00,
    full_attend_allow_adj BOOLEAN DEFAULT TRUE,
    attend_days_enabled BOOLEAN DEFAULT TRUE,
    should_attend_calc ENUM('workdays','fixed','custom') DEFAULT 'workdays',
    fixed_should_days INT DEFAULT NULL,
    exclude_holidays BOOLEAN DEFAULT TRUE,
    exclude_weekends BOOLEAN DEFAULT TRUE,
    count_late_as_attend BOOLEAN DEFAULT TRUE,
    count_missing_as_attend BOOLEAN DEFAULT TRUE,
    count_half_leave_as_half BOOLEAN DEFAULT TRUE,
    min_hours_for_full_day DECIMAL(4,2) DEFAULT 4.00,
    workday_swap_enabled BOOLEAN DEFAULT FALSE,
    auto_follow_national BOOLEAN DEFAULT TRUE,
    remote_work_enabled BOOLEAN DEFAULT FALSE,
    remote_require_approval BOOLEAN DEFAULT TRUE,
    remote_count_as_attend BOOLEAN DEFAULT TRUE,
    remote_max_days_month INT DEFAULT NULL,
    remote_max_hours_month DECIMAL(5,2) DEFAULT NULL,
    remote_allowed_weekdays JSON DEFAULT NULL,
    remote_default_time_mode ENUM('day','hour') DEFAULT 'day',
    overtime_checkpoints JSON DEFAULT '["19:30","20:30","22:00","24:00"]',
    weekend_overtime_threshold INT DEFAULT 8,
    cross_day_enabled BOOLEAN DEFAULT TRUE,
    cross_day_max_checkout TIME DEFAULT '24:00:00',
    cross_day_next_checkin TIME DEFAULT '13:30:00',
    version INT DEFAULT 1,
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by VARCHAR(64),
    updated_by VARCHAR(64),
    UNIQUE KEY uk_company_active (company_id, is_active),
    INDEX idx_company_id (company_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='考勤规则主配置表';

-- 2. 通用规则明细表
CREATE TABLE att_rule_detail (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    config_id BIGINT NOT NULL,
    rule_type ENUM('late','penalty','full_attend','leave_display','cross_day') NOT NULL,
    rule_key VARCHAR(64) DEFAULT NULL,
    rule_name VARCHAR(128) DEFAULT NULL,
    enabled BOOLEAN DEFAULT TRUE,
    sort_order INT DEFAULT 0,
    description VARCHAR(256) DEFAULT NULL,
    time_start TIME DEFAULT NULL,
    time_end TIME DEFAULT NULL,
    min_value INT DEFAULT NULL,
    max_value INT DEFAULT NULL,
    amount DECIMAL(10,2) DEFAULT NULL,
    threshold_hours INT DEFAULT NULL,
    unit ENUM('count','hours') DEFAULT NULL,
    label_short VARCHAR(64) DEFAULT NULL,
    label_long VARCHAR(64) DEFAULT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_config_id (config_id),
    INDEX idx_rule_type (rule_type),
    INDEX idx_config_type (config_id, rule_type),
    FOREIGN KEY (config_id) REFERENCES att_rule_config(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='考勤规则明细表';

-- 3. 特殊日期表
CREATE TABLE att_rule_special_date (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    config_id BIGINT NOT NULL,
    date_type ENUM('swap','remote') NOT NULL,
    target_date DATE NOT NULL,
    reason VARCHAR(256) DEFAULT NULL,
    swap_type ENUM('workday','holiday') DEFAULT NULL,
    time_mode ENUM('day','hour') DEFAULT 'day',
    start_time TIME DEFAULT NULL,
    end_time TIME DEFAULT NULL,
    duration_hours DECIMAL(4,2) DEFAULT NULL,
    scope ENUM('all','department','individual') DEFAULT 'all',
    scope_ids JSON DEFAULT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(64) DEFAULT NULL,
    INDEX idx_config_id (config_id),
    INDEX idx_date_type (date_type),
    INDEX idx_target_date (target_date),
    UNIQUE KEY uk_config_date_type (config_id, target_date, date_type),
    FOREIGN KEY (config_id) REFERENCES att_rule_config(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='考勤特殊日期表';

-- 4. 变更历史表
CREATE TABLE att_rule_change_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    config_id BIGINT NOT NULL,
    change_type ENUM('create','update','delete','rollback') NOT NULL,
    change_field VARCHAR(128) DEFAULT NULL,
    old_value TEXT DEFAULT NULL,
    new_value TEXT DEFAULT NULL,
    snapshot JSON DEFAULT NULL,
    change_reason VARCHAR(512) DEFAULT NULL,
    changed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    changed_by VARCHAR(64) NOT NULL,
    INDEX idx_config_id (config_id),
    INDEX idx_changed_at (changed_at),
    FOREIGN KEY (config_id) REFERENCES att_rule_config(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='考勤规则变更历史表';
```

### 9.2 配置字段映射表

#### 公司主体映射

| 前端值 | 数据库值 | 说明 |
|--------|----------|------|
| `'eyewind'` | `'eyewind'` | 风眼科技 |
| `'hydodo'` | `'hydodo'` | 海多多 |

#### 主配置表字段映射

| 前端字段 | 数据库字段 | 类型 |
|----------|------------|------|
| selectedCompany | company_id | ENUM |
| workStartTime | work_start_time | TIME |
| workEndTime | work_end_time | TIME |
| lunchStartTime | lunch_start_time | TIME |
| lunchEndTime | lunch_end_time | TIME |
| lateExemptionEnabled | late_exemption_enabled | BOOLEAN |
| lateExemptionCount | late_exemption_count | INT |
| lateExemptionMinutes | late_exemption_minutes | INT |
| performancePenaltyEnabled | perf_penalty_enabled | BOOLEAN |
| performancePenaltyMode | perf_penalty_mode | ENUM |
| unlimitedPenaltyThresholdTime | unlimited_threshold_time | TIME |
| unlimitedPenaltyCalcType | unlimited_calc_type | ENUM |
| unlimitedPenaltyPerMinute | unlimited_per_minute | DECIMAL |
| unlimitedPenaltyFixedAmount | unlimited_fixed_amount | DECIMAL |
| cappedPenaltyType | capped_penalty_type | ENUM |
| cappedPenaltyPerMinute | capped_per_minute | DECIMAL |
| maxPerformancePenalty | max_perf_penalty | DECIMAL |
| fullAttendanceEnabled | full_attend_enabled | BOOLEAN |
| fullAttendanceBonus | full_attend_bonus | DECIMAL |
| fullAttendanceAllowAdjustment | full_attend_allow_adj | BOOLEAN |
| remoteWorkEnabled | remote_work_enabled | BOOLEAN |
| remoteWorkDefaultTimeMode | remote_default_time_mode | ENUM |

#### 规则明细表字段映射

| rule_type | 前端数据结构 | 使用的数据库字段 |
|-----------|--------------|------------------|
| `late` | `LateRule` | time_start, time_end, description |
| `penalty` | `PerformancePenaltyRule` | min_value, max_value, amount, description |
| `full_attend` | `FullAttendanceRule` | rule_key, rule_name, enabled, min_value, unit |
| `leave_display` | `LeaveDisplayRule` | rule_key, threshold_hours, label_short, label_long |
| `cross_day` | `CrossDayRule` | time_start, time_end, description |

#### 特殊日期表字段映射

| date_type | 前端数据结构 | 使用的数据库字段 |
|-----------|--------------|------------------|
| `swap` | `WorkdaySwapDay` | target_date, swap_type, reason |
| `remote` | `RemoteWorkDay` | target_date, time_mode, start_time, end_time, duration_hours, scope, scope_ids, reason |

---

*文档版本: v2.0*  
*创建日期: 2026-01-30*  
*更新日期: 2026-01-31*  
*更新内容:*
- *v1.0: 初始版本*
- *v1.1: 居家办公规则支持按天/按小时两种模式*
- *v1.2: 绩效扣款封顶模式支持阶梯扣款和固定封顶两种子模式*
- *v2.0: 优化表结构，统一表名前缀为 att_rule_，从9张表精简为4张表*

*作者: Kiro AI Assistant*
