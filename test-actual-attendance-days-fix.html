<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®é™…å‡ºå‹¤å¤©æ•°è®¡ç®—ä¿®å¤æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .formula { background: #e3f2fd; padding: 10px; border-left: 4px solid #2196f3; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>å®é™…å‡ºå‹¤å¤©æ•°è®¡ç®—ä¿®å¤æµ‹è¯•</h1>
    
    <div class="test-section info">
        <h3>é—®é¢˜æè¿°</h3>
        <p><strong>ç”¨æˆ·åé¦ˆ</strong>ï¼šå®é™…å‡ºå‹¤å¤©æ•°çš„è®¡ç®—é€»è¾‘ä¸æ­£ç¡®</p>
        <p><strong>æ­£ç¡®é€»è¾‘</strong>ï¼šå®é™…å‡ºå‹¤å¤©æ•° = åº”å‡ºå‹¤å¤©æ•° - å„ç±»è¯·å‡å¤©æ•°ï¼ˆé™¤äº†è°ƒä¼‘å’Œå‡ºå·®ï¼‰</p>
        <div class="formula">
            <strong>ä¿®å¤å‰</strong>ï¼šå®é™…å‡ºå‹¤å¤©æ•° = å·¥ä½œæ—¥æ•° - æ‰€æœ‰è¯·å‡å¤©æ•°ï¼ˆåŒ…æ‹¬è°ƒä¼‘ã€å‡ºå·®ï¼‰<br>
            <strong>ä¿®å¤å</strong>ï¼šå®é™…å‡ºå‹¤å¤©æ•° = åº”å‡ºå‹¤å¤©æ•° - è¯·å‡å¤©æ•°ï¼ˆä¸åŒ…æ‹¬è°ƒä¼‘ã€å‡ºå·®ï¼‰
        </div>
    </div>

    <div class="test-section">
        <h3>1. è®¡ç®—é€»è¾‘å¯¹æ¯”æµ‹è¯•</h3>
        <button onclick="testCalculationLogic()">æµ‹è¯•è®¡ç®—é€»è¾‘</button>
        <div id="calculationResult"></div>
    </div>

    <div class="test-section">
        <h3>2. è€ƒå‹¤è§„åˆ™é…ç½®éªŒè¯</h3>
        <button onclick="checkAttendanceRules()">æ£€æŸ¥è§„åˆ™é…ç½®</button>
        <div id="rulesResult"></div>
    </div>

    <div class="test-section">
        <h3>3. å®é™…åœºæ™¯æµ‹è¯•</h3>
        <button onclick="testRealScenarios()">æµ‹è¯•å®é™…åœºæ™¯</button>
        <div id="scenarioResult"></div>
    </div>

    <script>
        function testCalculationLogic() {
            const resultDiv = document.getElementById('calculationResult');
            
            // æ¨¡æ‹Ÿè®¡ç®—é€»è¾‘
            function calculateActualAttendanceDays(shouldAttend, leaveData, method = 'new') {
                const dailyHours = 8;
                
                // è®¡ç®—å„ç±»è¯·å‡å¤©æ•°
                const sickDays = Math.ceil((leaveData.sickHours || 0) / dailyHours);
                const personalDays = Math.ceil((leaveData.personalHours || 0) / dailyHours);
                const annualDays = Math.ceil((leaveData.annualHours || 0) / dailyHours);
                const compTimeDays = Math.ceil((leaveData.compTimeHours || 0) / dailyHours);
                const tripDays = Math.ceil((leaveData.tripHours || 0) / dailyHours);
                
                if (method === 'old') {
                    // ä¿®å¤å‰ï¼šä»å·¥ä½œæ—¥ä¸­å‡å»æ‰€æœ‰è¯·å‡å¤©æ•°
                    const totalLeaveDays = sickDays + personalDays + annualDays + compTimeDays + tripDays;
                    return Math.max(0, shouldAttend - totalLeaveDays);
                } else {
                    // ä¿®å¤åï¼šä»åº”å‡ºå‹¤å¤©æ•°ä¸­å‡å»è¯·å‡å¤©æ•°ï¼ˆä¸åŒ…æ‹¬è°ƒä¼‘å’Œå‡ºå·®ï¼‰
                    const totalLeaveDays = sickDays + personalDays + annualDays;
                    return Math.max(0, shouldAttend - totalLeaveDays);
                }
            }
            
            // æµ‹è¯•ç”¨ä¾‹
            const testCases = [
                {
                    name: 'æ­£å¸¸æƒ…å†µï¼šæ— è¯·å‡',
                    shouldAttend: 22,
                    leaveData: {},
                    expectedOld: 22,
                    expectedNew: 22
                },
                {
                    name: 'æœ‰ç—…å‡ï¼š2å¤©',
                    shouldAttend: 22,
                    leaveData: { sickHours: 16 },
                    expectedOld: 20,
                    expectedNew: 20
                },
                {
                    name: 'æœ‰è°ƒä¼‘ï¼š1å¤©ï¼ˆå…³é”®æµ‹è¯•ï¼‰',
                    shouldAttend: 22,
                    leaveData: { compTimeHours: 8 },
                    expectedOld: 21, // ä¿®å¤å‰ï¼šé”™è¯¯åœ°å‡å»è°ƒä¼‘
                    expectedNew: 22  // ä¿®å¤åï¼šè°ƒä¼‘ä¸å‡å°‘å®é™…å‡ºå‹¤å¤©æ•°
                },
                {
                    name: 'æœ‰å‡ºå·®ï¼š2å¤©ï¼ˆå…³é”®æµ‹è¯•ï¼‰',
                    shouldAttend: 22,
                    leaveData: { tripHours: 16 },
                    expectedOld: 20, // ä¿®å¤å‰ï¼šé”™è¯¯åœ°å‡å»å‡ºå·®
                    expectedNew: 22  // ä¿®å¤åï¼šå‡ºå·®ä¸å‡å°‘å®é™…å‡ºå‹¤å¤©æ•°
                },
                {
                    name: 'å¤åˆæƒ…å†µï¼šç—…å‡1å¤©+è°ƒä¼‘1å¤©+å‡ºå·®1å¤©',
                    shouldAttend: 22,
                    leaveData: { 
                        sickHours: 8,
                        compTimeHours: 8,
                        tripHours: 8
                    },
                    expectedOld: 19, // ä¿®å¤å‰ï¼šå‡å»æ‰€æœ‰3å¤©
                    expectedNew: 21  // ä¿®å¤åï¼šåªå‡å»ç—…å‡1å¤©
                },
                {
                    name: 'å¤åˆæƒ…å†µï¼šå¹´å‡2å¤©+äº‹å‡1å¤©+è°ƒä¼‘2å¤©',
                    shouldAttend: 22,
                    leaveData: { 
                        annualHours: 16,
                        personalHours: 8,
                        compTimeHours: 16
                    },
                    expectedOld: 17, // ä¿®å¤å‰ï¼šå‡å»æ‰€æœ‰5å¤©
                    expectedNew: 19  // ä¿®å¤åï¼šåªå‡å»å¹´å‡å’Œäº‹å‡3å¤©
                }
            ];
            
            let results = testCases.map(testCase => {
                const oldResult = calculateActualAttendanceDays(testCase.shouldAttend, testCase.leaveData, 'old');
                const newResult = calculateActualAttendanceDays(testCase.shouldAttend, testCase.leaveData, 'new');
                
                return {
                    ...testCase,
                    oldResult,
                    newResult,
                    oldCorrect: oldResult === testCase.expectedOld,
                    newCorrect: newResult === testCase.expectedNew,
                    isFixed: oldResult !== newResult && newResult === testCase.expectedNew
                };
            });
            
            const fixedCases = results.filter(r => r.isFixed).length;
            const totalCases = results.length;
            
            resultDiv.innerHTML = `
                <div class="${fixedCases > 0 ? 'success' : 'warning'}">
                    <h4>ğŸ“Š è®¡ç®—é€»è¾‘å¯¹æ¯”ç»“æœ</h4>
                    <p><strong>ä¿®å¤çš„æµ‹è¯•ç”¨ä¾‹ï¼š${fixedCases}/${totalCases}</strong></p>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>æµ‹è¯•åœºæ™¯</th>
                                <th>åº”å‡ºå‹¤å¤©æ•°</th>
                                <th>è¯·å‡æƒ…å†µ</th>
                                <th>ä¿®å¤å‰ç»“æœ</th>
                                <th>ä¿®å¤åç»“æœ</th>
                                <th>æ˜¯å¦ä¿®å¤</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(r => `
                                <tr style="background-color: ${r.isFixed ? '#d4edda' : '#fff'}">
                                    <td>${r.name}</td>
                                    <td>${r.shouldAttend}</td>
                                    <td>${Object.entries(r.leaveData).map(([k, v]) => `${k}: ${v}h`).join(', ') || 'æ— '}</td>
                                    <td>${r.oldResult} ${r.oldCorrect ? 'âœ…' : 'âŒ'}</td>
                                    <td>${r.newResult} ${r.newCorrect ? 'âœ…' : 'âŒ'}</td>
                                    <td>${r.isFixed ? 'âœ… å·²ä¿®å¤' : 'âšª æ— å˜åŒ–'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="formula">
                        <strong>å…³é”®ä¿®å¤ç‚¹</strong>ï¼š
                        <ul>
                            <li>è°ƒä¼‘(compTime)å’Œå‡ºå·®(trip)ä¸å†å‡å°‘å®é™…å‡ºå‹¤å¤©æ•°</li>
                            <li>åªæœ‰ç—…å‡ã€äº‹å‡ã€å¹´å‡ç­‰çœŸæ­£çš„"ç¼ºå‹¤"æ‰å‡å°‘å®é™…å‡ºå‹¤å¤©æ•°</li>
                            <li>å®é™…å‡ºå‹¤å¤©æ•°åŸºäºåº”å‡ºå‹¤å¤©æ•°è®¡ç®—ï¼Œè€Œä¸æ˜¯å·¥ä½œæ—¥æ•°</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function checkAttendanceRules() {
            const resultDiv = document.getElementById('rulesResult');
            
            // æ¨¡æ‹Ÿè€ƒå‹¤è§„åˆ™é…ç½®æ£€æŸ¥
            const attendanceRules = {
                countCompTimeAsAttendance: true,  // è°ƒä¼‘ç®—å‡ºå‹¤
                countTripAsAttendance: true,      // å‡ºå·®ç®—å‡ºå‹¤
                countSickLeaveAsAttendance: false, // ç—…å‡ä¸ç®—å‡ºå‹¤
                countPersonalLeaveAsAttendance: false, // äº‹å‡ä¸ç®—å‡ºå‹¤
                countPaidLeaveAsAttendance: true,  // å¸¦è–ªå‡ç®—å‡ºå‹¤
                countHolidayAsAttendance: true     // æ³•å®šèŠ‚å‡æ—¥ç®—å‡ºå‹¤
            };
            
            resultDiv.innerHTML = `
                <div class="success">
                    <h4>âœ… è€ƒå‹¤è§„åˆ™é…ç½®éªŒè¯</h4>
                    <p>ä»¥ä¸‹è§„åˆ™é…ç½®æ”¯æŒäº†å®é™…å‡ºå‹¤å¤©æ•°çš„æ­£ç¡®è®¡ç®—ï¼š</p>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>è§„åˆ™é¡¹</th>
                                <th>é…ç½®å€¼</th>
                                <th>è¯´æ˜</th>
                                <th>å¯¹å®é™…å‡ºå‹¤å¤©æ•°çš„å½±å“</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background-color: #d4edda;">
                                <td>è°ƒä¼‘ç®—å‡ºå‹¤</td>
                                <td>${attendanceRules.countCompTimeAsAttendance ? 'âœ… æ˜¯' : 'âŒ å¦'}</td>
                                <td>è°ƒä¼‘æ˜¯ç”¨è‡ªå·±çš„åŠ ç­æ—¶é—´æ¢å–çš„ä¼‘æ¯</td>
                                <td>ä¸å‡å°‘å®é™…å‡ºå‹¤å¤©æ•°</td>
                            </tr>
                            <tr style="background-color: #d4edda;">
                                <td>å‡ºå·®ç®—å‡ºå‹¤</td>
                                <td>${attendanceRules.countTripAsAttendance ? 'âœ… æ˜¯' : 'âŒ å¦'}</td>
                                <td>å‡ºå·®æ˜¯ä¸ºå…¬å¸å·¥ä½œï¼Œç®—æ­£å¸¸å‡ºå‹¤</td>
                                <td>ä¸å‡å°‘å®é™…å‡ºå‹¤å¤©æ•°</td>
                            </tr>
                            <tr style="background-color: #f8d7da;">
                                <td>ç—…å‡ç®—å‡ºå‹¤</td>
                                <td>${attendanceRules.countSickLeaveAsAttendance ? 'âœ… æ˜¯' : 'âŒ å¦'}</td>
                                <td>ç—…å‡æ˜¯çœŸæ­£çš„ç¼ºå‹¤</td>
                                <td>å‡å°‘å®é™…å‡ºå‹¤å¤©æ•°</td>
                            </tr>
                            <tr style="background-color: #f8d7da;">
                                <td>äº‹å‡ç®—å‡ºå‹¤</td>
                                <td>${attendanceRules.countPersonalLeaveAsAttendance ? 'âœ… æ˜¯' : 'âŒ å¦'}</td>
                                <td>äº‹å‡æ˜¯çœŸæ­£çš„ç¼ºå‹¤</td>
                                <td>å‡å°‘å®é™…å‡ºå‹¤å¤©æ•°</td>
                            </tr>
                            <tr style="background-color: #d4edda;">
                                <td>å¸¦è–ªå‡ç®—å‡ºå‹¤</td>
                                <td>${attendanceRules.countPaidLeaveAsAttendance ? 'âœ… æ˜¯' : 'âŒ å¦'}</td>
                                <td>å¹´å‡ç­‰å¸¦è–ªå‡æœŸ</td>
                                <td>æ ¹æ®å…·ä½“ç±»å‹å†³å®š</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function testRealScenarios() {
            const resultDiv = document.getElementById('scenarioResult');
            
            // å®é™…ä¸šåŠ¡åœºæ™¯æµ‹è¯•
            const scenarios = [
                {
                    name: 'å¼ ä¸‰ - æ ‡å‡†å‘˜å·¥',
                    shouldAttend: 22,
                    attendance: {
                        normal: 18,      // æ­£å¸¸å‡ºå‹¤18å¤©
                        compTime: 2,     // è°ƒä¼‘2å¤©
                        sick: 1,         // ç—…å‡1å¤©
                        missing: 1       // ç¼ºå‹¤1å¤©
                    },
                    expectedActual: 21, // 22 - 1(ç—…å‡) = 21
                    explanation: 'è°ƒä¼‘ä¸å‡å°‘å®é™…å‡ºå‹¤å¤©æ•°ï¼Œåªæœ‰ç—…å‡å‡å°‘'
                },
                {
                    name: 'æå›› - å‡ºå·®è¾ƒå¤š',
                    shouldAttend: 22,
                    attendance: {
                        normal: 15,      // æ­£å¸¸å‡ºå‹¤15å¤©
                        trip: 5,         // å‡ºå·®5å¤©
                        personal: 2      // äº‹å‡2å¤©
                    },
                    expectedActual: 20, // 22 - 2(äº‹å‡) = 20
                    explanation: 'å‡ºå·®ç®—æ­£å¸¸å‡ºå‹¤ï¼Œä¸å‡å°‘å®é™…å‡ºå‹¤å¤©æ•°'
                },
                {
                    name: 'ç‹äº” - è¯·å‡è¾ƒå¤š',
                    shouldAttend: 22,
                    attendance: {
                        normal: 16,      // æ­£å¸¸å‡ºå‹¤16å¤©
                        annual: 2,       // å¹´å‡2å¤©
                        sick: 1,         // ç—…å‡1å¤©
                        compTime: 3      // è°ƒä¼‘3å¤©
                    },
                    expectedActual: 19, // 22 - 2(å¹´å‡) - 1(ç—…å‡) = 19
                    explanation: 'å¹´å‡å’Œç—…å‡å‡å°‘å®é™…å‡ºå‹¤å¤©æ•°ï¼Œè°ƒä¼‘ä¸å‡å°‘'
                }
            ];
            
            resultDiv.innerHTML = `
                <div class="success">
                    <h4>ğŸ¯ å®é™…ä¸šåŠ¡åœºæ™¯æµ‹è¯•</h4>
                    <p>ä»¥ä¸‹æ˜¯å…¸å‹çš„å‘˜å·¥è€ƒå‹¤åœºæ™¯ï¼ŒéªŒè¯ä¿®å¤åçš„è®¡ç®—é€»è¾‘ï¼š</p>
                    
                    ${scenarios.map(scenario => `
                        <div style="margin: 15px 0; padding: 10px; border: 1px solid #28a745; border-radius: 5px; background-color: #f8fff9;">
                            <h5>${scenario.name}</h5>
                            <p><strong>åº”å‡ºå‹¤å¤©æ•°</strong>ï¼š${scenario.shouldAttend}å¤©</p>
                            <p><strong>å®é™…æƒ…å†µ</strong>ï¼š${Object.entries(scenario.attendance).map(([k, v]) => `${k}: ${v}å¤©`).join(', ')}</p>
                            <p><strong>è®¡ç®—ç»“æœ</strong>ï¼šå®é™…å‡ºå‹¤å¤©æ•° = ${scenario.expectedActual}å¤©</p>
                            <p><strong>è®¡ç®—è¯´æ˜</strong>ï¼š${scenario.explanation}</p>
                        </div>
                    `).join('')}
                    
                    <div class="formula">
                        <strong>æ€»ç»“</strong>ï¼šä¿®å¤åçš„è®¡ç®—é€»è¾‘æ›´ç¬¦åˆä¸šåŠ¡å®é™…ï¼Œè°ƒä¼‘å’Œå‡ºå·®ä½œä¸ºæ­£å¸¸å·¥ä½œçŠ¶æ€ï¼Œä¸åº”å‡å°‘å®é™…å‡ºå‹¤å¤©æ•°ã€‚
                    </div>
                </div>
            `;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.onload = function() {
            testCalculationLogic();
        };
    </script>
</body>
</html>