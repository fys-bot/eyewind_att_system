<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒå‹¤è§„åˆ™æŒä¹…åŒ–æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .step { margin: 10px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ è€ƒå‹¤è§„åˆ™æŒä¹…åŒ–æµ‹è¯•</h1>
    <p>æ­¤æµ‹è¯•éªŒè¯è€ƒå‹¤è§„åˆ™ä¿å­˜åæ˜¯å¦èƒ½æ­£ç¡®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œä»¥åŠé‡æ–°åŠ è½½æ—¶æ˜¯å¦èƒ½æ­£ç¡®æ˜¾ç¤ºä¿å­˜çš„é…ç½®ã€‚</p>

    <div class="test-section info">
        <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h3>
        <div class="step">1. è·å–å½“å‰é…ç½®ä½œä¸ºåŸºå‡†</div>
        <div class="step">2. ä¿®æ”¹é…ç½®å¹¶ä¿å­˜åˆ°æ•°æ®åº“</div>
        <div class="step">3. æ¸…é™¤å‰ç«¯ç¼“å­˜æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°</div>
        <div class="step">4. é‡æ–°ä»æ•°æ®åº“åŠ è½½é…ç½®</div>
        <div class="step">5. éªŒè¯ä¿å­˜çš„é…ç½®æ˜¯å¦æ­£ç¡®åŠ è½½</div>
        <div class="step">6. æ¢å¤åŸå§‹é…ç½®</div>
    </div>

    <div class="test-section">
        <h3>ğŸ® æµ‹è¯•æ§åˆ¶</h3>
        <button onclick="runFullTest()" id="runTestBtn">å¼€å§‹å®Œæ•´æµ‹è¯•</button>
        <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        <button onclick="getCurrentConfig()">ä»…è·å–å½“å‰é…ç½®</button>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:5000';
        let originalConfig = null;
        let testResults = [];

        function addResult(message, type = 'info', data = null) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            
            let content = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            if (data) {
                content += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            div.innerHTML = content;
            results.appendChild(div);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            div.scrollIntoView({ behavior: 'smooth' });
            
            testResults.push({ timestamp: new Date(), message, type, data });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
        }

        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'x-user-id': 'test-user',
                    'x-user-name': 'Test User'
                }
            };
            
            const response = await fetch(url, { ...defaultOptions, ...options });
            const data = await response.json();
            
            if (data.code !== 0) {
                throw new Error(data.message || `API é”™è¯¯: ${data.code}`);
            }
            
            return data.data;
        }

        async function getCurrentConfig() {
            try {
                addResult('ğŸ“¥ æ­£åœ¨è·å–å½“å‰é…ç½®...');
                const config = await apiRequest('/api/v1/attendance/rules/eyewind');
                addResult(`âœ… æˆåŠŸè·å–é…ç½® (ç‰ˆæœ¬: ${config.version})`, 'success');
                addResult('å½“å‰é…ç½®è¯¦æƒ…:', 'info', {
                    version: config.version,
                    work_start_time: config.work_start_time,
                    work_end_time: config.work_end_time,
                    late_exemption_enabled: config.late_exemption_enabled,
                    late_exemption_count: config.late_exemption_count,
                    perf_penalty_enabled: config.perf_penalty_enabled,
                    full_attend_enabled: config.full_attend_enabled,
                    full_attend_bonus: config.full_attend_bonus
                });
                return config;
            } catch (error) {
                addResult(`âŒ è·å–é…ç½®å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        async function saveTestConfig(changes) {
            try {
                addResult('ğŸ’¾ æ­£åœ¨ä¿å­˜æµ‹è¯•é…ç½®...', 'info', changes);
                const result = await apiRequest('/api/v1/attendance/rules/eyewind', {
                    method: 'PUT',
                    body: JSON.stringify({
                        ...changes,
                        changeReason: 'è‡ªåŠ¨åŒ–æµ‹è¯•ï¼šéªŒè¯é…ç½®æŒä¹…åŒ–'
                    })
                });
                addResult(`âœ… é…ç½®ä¿å­˜æˆåŠŸ (æ–°ç‰ˆæœ¬: ${result.version})`, 'success');
                return result;
            } catch (error) {
                addResult(`âŒ ä¿å­˜é…ç½®å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        async function verifyConfigChanges(expectedChanges, actualConfig) {
            addResult('ğŸ” æ­£åœ¨éªŒè¯é…ç½®æ›´æ”¹...');
            let allCorrect = true;
            const verificationResults = {};

            for (const [key, expectedValue] of Object.entries(expectedChanges)) {
                const actualValue = actualConfig[key];
                const isCorrect = actualValue == expectedValue || 
                                (typeof expectedValue === 'string' && actualValue === expectedValue + ':00');
                
                verificationResults[key] = {
                    expected: expectedValue,
                    actual: actualValue,
                    correct: isCorrect
                };

                if (!isCorrect) {
                    allCorrect = false;
                }
            }

            addResult('éªŒè¯ç»“æœ:', allCorrect ? 'success' : 'error', verificationResults);

            if (allCorrect) {
                addResult('ğŸ‰ æ‰€æœ‰é…ç½®æ›´æ”¹éƒ½å·²æ­£ç¡®ä¿å­˜å’ŒåŠ è½½ï¼', 'success');
            } else {
                addResult('âš ï¸ éƒ¨åˆ†é…ç½®æ›´æ”¹æœªæ­£ç¡®ä¿å­˜æˆ–åŠ è½½', 'warning');
            }

            return allCorrect;
        }

        async function runFullTest() {
            const runTestBtn = document.getElementById('runTestBtn');
            runTestBtn.disabled = true;
            runTestBtn.textContent = 'æµ‹è¯•è¿›è¡Œä¸­...';

            try {
                addResult('ğŸš€ å¼€å§‹è€ƒå‹¤è§„åˆ™æŒä¹…åŒ–å®Œæ•´æµ‹è¯•', 'info');
                
                // æ­¥éª¤ 1: è·å–åŸå§‹é…ç½®
                addResult('ğŸ“‹ æ­¥éª¤ 1: è·å–åŸå§‹é…ç½®');
                originalConfig = await getCurrentConfig();
                
                // æ­¥éª¤ 2: å‡†å¤‡æµ‹è¯•æ›´æ”¹
                addResult('ğŸ“‹ æ­¥éª¤ 2: å‡†å¤‡æµ‹è¯•æ›´æ”¹');
                const testChanges = {
                    work_start_time: '08:45',  // ä¿®æ”¹ä¸Šç­æ—¶é—´
                    work_end_time: '17:45',    // ä¿®æ”¹ä¸‹ç­æ—¶é—´
                    late_exemption_count: 5,   // ä¿®æ”¹è±å…æ¬¡æ•°
                    full_attend_bonus: 300,    // ä¿®æ”¹å…¨å‹¤å¥–é‡‘é¢
                    perf_penalty_enabled: !originalConfig.perf_penalty_enabled  // åˆ‡æ¢ç»©æ•ˆæ‰£æ¬¾å¼€å…³
                };
                
                addResult('æµ‹è¯•æ›´æ”¹å†…å®¹:', 'info', testChanges);
                
                // æ­¥éª¤ 3: ä¿å­˜æµ‹è¯•é…ç½®
                addResult('ğŸ“‹ æ­¥éª¤ 3: ä¿å­˜æµ‹è¯•é…ç½®åˆ°æ•°æ®åº“');
                await saveTestConfig(testChanges);
                
                // æ­¥éª¤ 4: ç­‰å¾…ä¸€ä¸‹ç¡®ä¿æ•°æ®åº“å†™å…¥å®Œæˆ
                addResult('â³ ç­‰å¾…æ•°æ®åº“å†™å…¥å®Œæˆ...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // æ­¥éª¤ 5: é‡æ–°åŠ è½½é…ç½®éªŒè¯æŒä¹…åŒ–
                addResult('ğŸ“‹ æ­¥éª¤ 4: é‡æ–°ä»æ•°æ®åº“åŠ è½½é…ç½®éªŒè¯æŒä¹…åŒ–');
                const reloadedConfig = await getCurrentConfig();
                
                // æ­¥éª¤ 6: éªŒè¯æ›´æ”¹
                addResult('ğŸ“‹ æ­¥éª¤ 5: éªŒè¯é…ç½®æ›´æ”¹æ˜¯å¦æ­£ç¡®æŒä¹…åŒ–');
                const isCorrect = await verifyConfigChanges(testChanges, reloadedConfig);
                
                // æ­¥éª¤ 7: æ¢å¤åŸå§‹é…ç½®
                addResult('ğŸ“‹ æ­¥éª¤ 6: æ¢å¤åŸå§‹é…ç½®');
                await saveTestConfig({
                    work_start_time: originalConfig.work_start_time.substring(0, 5),
                    work_end_time: originalConfig.work_end_time.substring(0, 5),
                    late_exemption_count: originalConfig.late_exemption_count,
                    full_attend_bonus: originalConfig.full_attend_bonus,
                    perf_penalty_enabled: originalConfig.perf_penalty_enabled
                });
                
                // æœ€ç»ˆç»“æœ
                if (isCorrect) {
                    addResult('ğŸŠ æµ‹è¯•å®Œæˆï¼šè€ƒå‹¤è§„åˆ™æŒä¹…åŒ–åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼', 'success');
                } else {
                    addResult('âŒ æµ‹è¯•å¤±è´¥ï¼šè€ƒå‹¤è§„åˆ™æŒä¹…åŒ–å­˜åœ¨é—®é¢˜', 'error');
                }
                
            } catch (error) {
                addResult(`ğŸ’¥ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
                
                // å°è¯•æ¢å¤åŸå§‹é…ç½®
                if (originalConfig) {
                    try {
                        addResult('ğŸ”„ å°è¯•æ¢å¤åŸå§‹é…ç½®...');
                        await saveTestConfig({
                            work_start_time: originalConfig.work_start_time.substring(0, 5),
                            work_end_time: originalConfig.work_end_time.substring(0, 5),
                            late_exemption_count: originalConfig.late_exemption_count,
                            full_attend_bonus: originalConfig.full_attend_bonus,
                            perf_penalty_enabled: originalConfig.perf_penalty_enabled
                        });
                        addResult('âœ… åŸå§‹é…ç½®å·²æ¢å¤', 'success');
                    } catch (restoreError) {
                        addResult(`âŒ æ¢å¤åŸå§‹é…ç½®å¤±è´¥: ${restoreError.message}`, 'error');
                    }
                }
            } finally {
                runTestBtn.disabled = false;
                runTestBtn.textContent = 'å¼€å§‹å®Œæ•´æµ‹è¯•';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡å™¨è¿æ¥
        window.addEventListener('load', async () => {
            try {
                await fetch(`${API_BASE}/health`);
                addResult('âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸', 'success');
            } catch (error) {
                addResult('âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ', 'error');
            }
        });
    </script>
</body>
</html>