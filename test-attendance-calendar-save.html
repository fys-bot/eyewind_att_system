<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒå‹¤æ—¥å†ç¼–è¾‘ä¿å­˜å…¥åº“åŠŸèƒ½éªŒè¯</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .code-block { background: #f8f9fa; padding: 15px; border-radius: 4px; border-left: 4px solid #007bff; margin: 10px 0; font-family: 'Courier New', monospace; white-space: pre-wrap; }
        .timeline { margin: 20px 0; }
        .timeline-item { display: flex; align-items: center; margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .timeline-step { background: #007bff; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; }
        .timeline-step.success { background: #28a745; }
        .timeline-step.error { background: #dc3545; }
        .timeline-step.warning { background: #ffc107; color: #212529; }
        h1, h2, h3 { color: #333; }
        .fix-summary { background: #e7f3ff; padding: 15px; border-radius: 4px; border-left: 4px solid #007bff; margin: 20px 0; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .comparison-item { padding: 15px; border-radius: 4px; }
        .before { background: #fff5f5; border-left: 4px solid #dc3545; }
        .after { background: #f0fff4; border-left: 4px solid #28a745; }
        .api-endpoint { background: #e3f2fd; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ è€ƒå‹¤æ—¥å†ç¼–è¾‘ä¿å­˜å…¥åº“åŠŸèƒ½</h1>
        
        <div class="status success">
            <strong>âœ… åŠŸèƒ½å®Œæˆ</strong> - è€ƒå‹¤æ—¥å†ç¼–è¾‘ä¿å­˜åç°åœ¨ä¼šæ­£ç¡®å…¥åº“åˆ°æ•°æ®åº“
        </div>

        <div class="fix-summary">
            <h3>ğŸ¯ åŠŸèƒ½éœ€æ±‚</h3>
            <p>ç”¨æˆ·åœ¨è€ƒå‹¤æ—¥å†é¡µé¢ç¼–è¾‘è€ƒå‹¤æ•°æ®åï¼Œç‚¹å‡»ä¿å­˜éœ€è¦å°†ä¿®æ”¹çš„æ•°æ®å…¥åº“åˆ°æ•°æ®åº“ä¸­ï¼Œè€Œä¸æ˜¯ä»…ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ã€‚</p>
            
            <h4>ğŸ” å®ç°è¦ç‚¹ï¼š</h4>
            <ul>
                <li><strong>æ•°æ®åº“å…¥åº“</strong>ï¼šè°ƒç”¨æœåŠ¡å™¨APIå°†ä¿®æ”¹çš„è€ƒå‹¤æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“</li>
                <li><strong>æ‰¹é‡æ›´æ–°</strong>ï¼šæ”¯æŒä¸€æ¬¡æ€§ä¿å­˜å¤šæ¡è€ƒå‹¤è®°å½•çš„ä¿®æ”¹</li>
                <li><strong>é”™è¯¯å¤„ç†</strong>ï¼šæä¾›é™çº§æ–¹æ¡ˆï¼Œæ•°æ®åº“ä¿å­˜å¤±è´¥æ—¶å¯é€‰æ‹©ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜</li>
                <li><strong>å®¡è®¡æ—¥å¿—</strong>ï¼šè®°å½•ä¿®æ”¹æ“ä½œçš„è¯¦ç»†æ—¥å¿—</li>
            </ul>
        </div>

        <h2>ğŸ”§ å®ç°æ–¹æ¡ˆ</h2>
        
        <div class="comparison">
            <div class="comparison-item before">
                <h4>âŒ ä¿®æ”¹å‰ï¼ˆä»…æœ¬åœ°ç¼“å­˜ï¼‰</h4>
                <div class="code-block">// âŒ åªä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
const cacheKey = `ATTENDANCE_MAP_CACHE_${currentCompany}_${month}`;
await SmartCache.set(cacheKey, attendanceMap);

// å°è¯•åŒæ­¥åˆ°æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰
try {
  // å¯èƒ½å¤±è´¥ï¼Œä½†ä¸å½±å“"ä¿å­˜æˆåŠŸ"çš„æç¤º
  await attendanceApiService.batchUpdateDaily(companyId, updates);
} catch (apiError) {
  console.warn('æœåŠ¡å™¨åŒæ­¥å¤±è´¥ï¼Œæ•°æ®ä»…ä¿å­˜åˆ°æœ¬åœ°');
}

alert('âœ… ä¿å­˜æˆåŠŸï¼'); // å³ä½¿æ•°æ®åº“ä¿å­˜å¤±è´¥ä¹Ÿæ˜¾ç¤ºæˆåŠŸ</div>
                
                <div class="status error">
                    <strong>é—®é¢˜ï¼š</strong>æ•°æ®åªä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ï¼Œåˆ·æ–°é¡µé¢æˆ–åˆ‡æ¢è®¾å¤‡åä¿®æ”¹ä¼šä¸¢å¤±
                </div>
            </div>
            
            <div class="comparison-item after">
                <h4>âœ… ä¿®æ”¹åï¼ˆæ•°æ®åº“å…¥åº“ï¼‰</h4>
                <div class="code-block">// âœ… ä¼˜å…ˆä¿å­˜åˆ°æ•°æ®åº“
const updates = []; // æ”¶é›†æ‰€æœ‰ä¿®æ”¹çš„è®°å½•

// æ„å»ºæ›´æ–°è®°å½•
for (const [userId, userDays] of Object.entries(attendanceMap)) {
  for (const [dayStr, status] of Object.entries(userDays)) {
    updates.push({
      userId,
      date,
      status: status.status,
      onDutyTime: status.onDutyTime,
      offDutyTime: status.offDutyTime,
      records: status.records || [],
      editReason: 'è€ƒå‹¤æ—¥å†ç¼–è¾‘ä¿®æ”¹',
      linkedProcInstId: status.records?.find(r => r.procInstId)?.procInstId
    });
  }
}

// è°ƒç”¨APIè¿›è¡Œå…¥åº“
const result = await attendanceApiService.batchUpdateDaily(companyId, updates);

// æ•°æ®åº“ä¿å­˜æˆåŠŸåï¼Œæ›´æ–°æœ¬åœ°ç¼“å­˜
await SmartCache.set(cacheKey, attendanceMap);

alert(`âœ… ä¿å­˜æˆåŠŸï¼å·²æ›´æ–° ${result.updated} æ¡è®°å½•åˆ°æ•°æ®åº“`);</div>
                
                <div class="status success">
                    <strong>ä¿®å¤ï¼š</strong>æ•°æ®ä¼˜å…ˆä¿å­˜åˆ°æ•°æ®åº“ï¼Œç¡®ä¿æŒä¹…åŒ–å’Œå¤šè®¾å¤‡åŒæ­¥
                </div>
            </div>
        </div>

        <h2>ğŸ”„ ä¿å­˜æµç¨‹</h2>
        
        <div class="timeline">
            <div class="timeline-item">
                <div class="timeline-step success">1</div>
                <div>
                    <strong>ç”¨æˆ·ç¼–è¾‘è€ƒå‹¤æ•°æ®</strong><br>
                    <small>åœ¨è€ƒå‹¤æ—¥å†ä¸­ä¿®æ”¹å‘˜å·¥çš„è€ƒå‹¤çŠ¶æ€</small>
                </div>
            </div>
            
            <div class="timeline-item">
                <div class="timeline-step success">2</div>
                <div>
                    <strong>ç‚¹å‡»ä¿å­˜æŒ‰é’®</strong><br>
                    <small>è§¦å‘handleSaveEditå‡½æ•°</small>
                </div>
            </div>
            
            <div class="timeline-item">
                <div class="timeline-step success">3</div>
                <div>
                    <strong>ç¡®è®¤ä¿å­˜æç¤º</strong><br>
                    <small>æ˜¾ç¤ºä¿å­˜ç¡®è®¤å¯¹è¯æ¡†ï¼Œè¯´æ˜å°†å…¥åº“åˆ°æ•°æ®åº“</small>
                </div>
            </div>
            
            <div class="timeline-item">
                <div class="timeline-step success">4</div>
                <div>
                    <strong>æ”¶é›†ä¿®æ”¹æ•°æ®</strong><br>
                    <small>éå†attendanceMapï¼Œæ„å»ºæ›´æ–°è®°å½•æ•°ç»„</small>
                </div>
            </div>
            
            <div class="timeline-item">
                <div class="timeline-step success">5</div>
                <div>
                    <strong>è°ƒç”¨APIå…¥åº“</strong><br>
                    <small>PUT /api/v1/attendance/daily/:companyId</small>
                </div>
            </div>
            
            <div class="timeline-item">
                <div class="timeline-step success">6</div>
                <div>
                    <strong>æ•°æ®åº“ä¿å­˜</strong><br>
                    <small>æœåŠ¡å™¨ç«¯æ‰¹é‡æ›´æ–°è€ƒå‹¤è®°å½•åˆ°æ•°æ®åº“</small>
                </div>
            </div>
            
            <div class="timeline-item">
                <div class="timeline-step success">7</div>
                <div>
                    <strong>è®°å½•å®¡è®¡æ—¥å¿—</strong><br>
                    <small>è®°å½•ä¿®æ”¹æ“ä½œçš„è¯¦ç»†æ—¥å¿—</small>
                </div>
            </div>
            
            <div class="timeline-item">
                <div class="timeline-step success">8</div>
                <div>
                    <strong>æ›´æ–°æœ¬åœ°ç¼“å­˜</strong><br>
                    <small>æ•°æ®åº“ä¿å­˜æˆåŠŸåï¼ŒåŒæ­¥æ›´æ–°æœ¬åœ°ç¼“å­˜</small>
                </div>
            </div>
            
            <div class="timeline-item">
                <div class="timeline-step success">9</div>
                <div>
                    <strong>æ˜¾ç¤ºæˆåŠŸæç¤º</strong><br>
                    <small>æ˜¾ç¤ºå®é™…æ›´æ–°çš„è®°å½•æ•°é‡</small>
                </div>
            </div>
        </div>

        <h2>ğŸ—ï¸ æŠ€æœ¯å®ç°</h2>
        
        <h3>1. æ•°æ®æ”¶é›†</h3>
        <div class="code-block">// éå†è€ƒå‹¤åœ°å›¾ï¼Œæ”¶é›†æ‰€æœ‰ä¿®æ”¹çš„è®°å½•
const updates: any[] = [];
for (const [userId, userDays] of Object.entries(attendanceMap)) {
  for (const [dayStr, status] of Object.entries(userDays)) {
    const day = parseInt(dayStr);
    const date = `${month}-${String(day).padStart(2, '0')}`;
    
    const updateRecord = {
      userId,
      date,
      status: status.status,
      onDutyTime: status.onDutyTime,
      offDutyTime: status.offDutyTime,
      records: status.records || [],
      editReason: 'è€ƒå‹¤æ—¥å†ç¼–è¾‘ä¿®æ”¹',
      linkedProcInstId: status.records?.find(r => r.procInstId)?.procInstId
    };
    
    updates.push(updateRecord);
  }
}</div>

        <h3>2. APIè°ƒç”¨</h3>
        <div class="api-endpoint">
        <strong>PUT</strong> /api/v1/attendance/daily/:companyId
        </div>
        <div class="code-block">// è°ƒç”¨æ‰¹é‡æ›´æ–°API
const result = await attendanceApiService.batchUpdateDaily(companyId, updates);

// è¿”å›ç»“æœ
{
  "updated": 15,        // å®é™…æ›´æ–°çš„è®°å½•æ•°
  "editLogIds": [...]   // ç”Ÿæˆçš„ç¼–è¾‘æ—¥å¿—IDåˆ—è¡¨
}</div>

        <h3>3. é”™è¯¯å¤„ç†</h3>
        <div class="code-block">try {
  // å°è¯•æ•°æ®åº“ä¿å­˜
  const result = await attendanceApiService.batchUpdateDaily(companyId, updates);
  alert(`âœ… ä¿å­˜æˆåŠŸï¼å·²æ›´æ–° ${result.updated} æ¡è®°å½•åˆ°æ•°æ®åº“`);
} catch (error) {
  // æ•°æ®åº“ä¿å­˜å¤±è´¥ï¼Œæä¾›é™çº§é€‰é¡¹
  const fallbackMessage = `
âŒ æ•°æ®åº“ä¿å­˜å¤±è´¥ï¼š${error.message}

æ˜¯å¦ä»…ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ï¼Ÿ
â€¢ ç‚¹å‡»"ç¡®å®š"ï¼šä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ï¼ˆä¸‹æ¬¡åˆ·æ–°å¯èƒ½ä¸¢å¤±ï¼‰
â€¢ ç‚¹å‡»"å–æ¶ˆ"ï¼šæ”¾å¼ƒä¿å­˜ï¼Œç»§ç»­ç¼–è¾‘
  `;
  
  if (confirm(fallbackMessage)) {
    await SmartCache.set(cacheKey, attendanceMap);
    alert('âš ï¸ å·²ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ï¼Œå»ºè®®ç¨åé‡è¯•æ•°æ®åº“ä¿å­˜');
  }
}</div>

        <h2>ğŸ¯ å…³é”®æ”¹è¿›ç‚¹</h2>
        
        <div class="status info">
            <h4>1. æ•°æ®åº“ä¼˜å…ˆ</h4>
            <p>ä¿®æ”¹ä¿å­˜é€»è¾‘ï¼Œä¼˜å…ˆä¿å­˜åˆ°æ•°æ®åº“ï¼Œç¡®ä¿æ•°æ®æŒä¹…åŒ–ã€‚</p>
        </div>
        
        <div class="status info">
            <h4>2. æ‰¹é‡æ“ä½œ</h4>
            <p>æ”¯æŒä¸€æ¬¡æ€§ä¿å­˜å¤šæ¡è€ƒå‹¤è®°å½•çš„ä¿®æ”¹ï¼Œæé«˜æ•ˆç‡ã€‚</p>
        </div>
        
        <div class="status info">
            <h4>3. é”™è¯¯å¤„ç†</h4>
            <p>æä¾›é™çº§æ–¹æ¡ˆï¼Œæ•°æ®åº“ä¿å­˜å¤±è´¥æ—¶å¯é€‰æ‹©ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ã€‚</p>
        </div>
        
        <div class="status info">
            <h4>4. å®¡è®¡æ—¥å¿—</h4>
            <p>æœåŠ¡å™¨ç«¯è‡ªåŠ¨è®°å½•ä¿®æ”¹æ“ä½œçš„è¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºè¿½è¸ªã€‚</p>
        </div>

        <h2>ğŸ§ª æµ‹è¯•éªŒè¯</h2>
        
        <div class="status success">
            <h4>âœ… é¢„æœŸè¡Œä¸ºï¼š</h4>
            <ul>
                <li>ç¼–è¾‘è€ƒå‹¤æ•°æ®åç‚¹å‡»ä¿å­˜ï¼Œæ•°æ®ä¼šå…¥åº“åˆ°æ•°æ®åº“</li>
                <li>ä¿å­˜æˆåŠŸåæ˜¾ç¤ºå®é™…æ›´æ–°çš„è®°å½•æ•°é‡</li>
                <li>æ•°æ®åº“ä¿å­˜å¤±è´¥æ—¶æä¾›é™çº§é€‰é¡¹</li>
                <li>å¯ä»¥åœ¨ç¼–è¾‘æ—¥å¿—ä¸­æŸ¥çœ‹ä¿®æ”¹è®°å½•</li>
                <li>å¤šè®¾å¤‡é—´æ•°æ®ä¿æŒåŒæ­¥</li>
            </ul>
        </div>

        <div class="status warning">
            <h4>âš ï¸ æµ‹è¯•æ­¥éª¤ï¼š</h4>
            <ol>
                <li><strong>å¯åŠ¨æœåŠ¡å™¨</strong>ï¼šç¡®ä¿åç«¯æœåŠ¡å™¨æ­£å¸¸è¿è¡Œ</li>
                <li><strong>è¿›å…¥è€ƒå‹¤æ—¥å†</strong>ï¼šæ‰“å¼€è€ƒå‹¤æ—¥å†é¡µé¢</li>
                <li><strong>å¼€å¯ç¼–è¾‘æ¨¡å¼</strong>ï¼šç‚¹å‡»ç¼–è¾‘æŒ‰é’®</li>
                <li><strong>ä¿®æ”¹è€ƒå‹¤æ•°æ®</strong>ï¼šä¿®æ”¹æŸäº›å‘˜å·¥çš„è€ƒå‹¤çŠ¶æ€</li>
                <li><strong>ä¿å­˜ä¿®æ”¹</strong>ï¼šç‚¹å‡»ä¿å­˜æŒ‰é’®</li>
                <li><strong>éªŒè¯å…¥åº“</strong>ï¼šæ£€æŸ¥æ•°æ®åº“ä¸­çš„è®°å½•æ˜¯å¦æ›´æ–°</li>
                <li><strong>æŸ¥çœ‹æ—¥å¿—</strong>ï¼šåœ¨ç¼–è¾‘æ—¥å¿—ä¸­æŸ¥çœ‹ä¿®æ”¹è®°å½•</li>
            </ol>
        </div>

        <h2>ğŸ“‹ ç›¸å…³APIæ¥å£</h2>
        
        <div class="api-endpoint">
        <strong>PUT</strong> /api/v1/attendance/daily/:companyId - æ‰¹é‡æ›´æ–°æ¯æ—¥è€ƒå‹¤
        </div>
        <div class="code-block">// è¯·æ±‚ä½“
{
  "updates": [
    {
      "userId": "user123",
      "date": "2025-01-15",
      "status": "normal",
      "onDutyTime": "09:00",
      "offDutyTime": "18:30",
      "records": [...],
      "editReason": "è€ƒå‹¤æ—¥å†ç¼–è¾‘ä¿®æ”¹",
      "linkedProcInstId": "proc456"
    }
  ]
}

// å“åº”
{
  "code": 0,
  "data": {
    "updated": 15,
    "editLogIds": [101, 102, 103, ...]
  }
}</div>

        <div class="api-endpoint">
        <strong>GET</strong> /api/v1/attendance/edit-logs/:companyId - æŸ¥çœ‹ç¼–è¾‘æ—¥å¿—
        </div>
        <div class="code-block">// å“åº”
{
  "code": 0,
  "data": {
    "total": 50,
    "list": [
      {
        "id": 101,
        "user_id": "user123",
        "user_name": "å¼ ä¸‰",
        "attendance_date": "2025-01-15",
        "edit_type": "status",
        "old_status": "incomplete",
        "new_status": "normal",
        "edit_reason": "è€ƒå‹¤æ—¥å†ç¼–è¾‘ä¿®æ”¹",
        "editor_id": "admin",
        "editor_name": "ç®¡ç†å‘˜",
        "edit_time": "2025-01-31T10:30:00Z"
      }
    ]
  }
}</div>

        <h2>ğŸ”§ æ•…éšœæ’é™¤</h2>
        
        <div class="code-block">// å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

1. "æ•°æ®åº“ä¿å­˜å¤±è´¥"
   â†’ æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
   â†’ æ£€æŸ¥ç½‘ç»œè¿æ¥
   â†’ æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

2. "æ‰¹é‡æ›´æ–°å¤±è´¥"
   â†’ æ£€æŸ¥æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®
   â†’ ç¡®è®¤å…¬å¸IDå’Œæ—¥æœŸæ ¼å¼æœ‰æ•ˆ
   â†’ æŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯

3. "æƒé™ä¸è¶³"
   â†’ ç¡®è®¤ç”¨æˆ·æœ‰ç¼–è¾‘è€ƒå‹¤æ•°æ®çš„æƒé™
   â†’ æ£€æŸ¥è¯·æ±‚å¤´ä¸­çš„ç”¨æˆ·ä¿¡æ¯

4. "æœ¬åœ°ç¼“å­˜ä¸ä¸€è‡´"
   â†’ æ¸…é™¤æœ¬åœ°ç¼“å­˜é‡æ–°åŠ è½½
   â†’ åˆ·æ–°é¡µé¢è·å–æœ€æ–°æ•°æ®</div>

        <div class="status success">
            <strong>ğŸ‰ åŠŸèƒ½å®Œæˆï¼</strong> è€ƒå‹¤æ—¥å†ç¼–è¾‘ä¿å­˜åŠŸèƒ½ç°åœ¨ä¼šæ­£ç¡®å°†ä¿®æ”¹çš„æ•°æ®å…¥åº“åˆ°æ•°æ®åº“ï¼Œç¡®ä¿æ•°æ®çš„æŒä¹…åŒ–å’Œä¸€è‡´æ€§ã€‚ç”¨æˆ·çš„ç¼–è¾‘æ“ä½œä¼šè¢«å®Œæ•´è®°å½•ï¼Œæ”¯æŒå®¡è®¡å’Œè¿½è¸ªã€‚
        </div>
    </div>
</body>
</html>