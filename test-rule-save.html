<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•è€ƒå‹¤è§„åˆ™ä¿å­˜</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>è€ƒå‹¤è§„åˆ™ä¿å­˜æµ‹è¯•</h1>
    
    <div>
        <button onclick="testGetConfig()">1. è·å–å½“å‰é…ç½®</button>
        <button onclick="testSaveConfig()">2. æµ‹è¯•ä¿å­˜é…ç½®</button>
        <button onclick="testGetConfigAfterSave()">3. ä¿å­˜åé‡æ–°è·å–</button>
    </div>
    
    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:5000';
        let currentConfig = null;
        
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }
        
        async function testGetConfig() {
            try {
                addResult('æ­£åœ¨è·å– eyewind é…ç½®...');
                const response = await fetch(`${API_BASE}/api/v1/attendance/rules/eyewind`);
                const data = await response.json();
                
                if (data.code === 0) {
                    currentConfig = data.data;
                    addResult(`âœ… æˆåŠŸè·å–é…ç½®ï¼Œç‰ˆæœ¬: ${currentConfig.version}`, 'success');
                    addResult(`<pre>${JSON.stringify(currentConfig, null, 2)}</pre>`);
                } else {
                    addResult(`âŒ è·å–é…ç½®å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testSaveConfig() {
            if (!currentConfig) {
                addResult('âŒ è¯·å…ˆè·å–é…ç½®', 'error');
                return;
            }
            
            try {
                addResult('æ­£åœ¨æµ‹è¯•ä¿å­˜é…ç½®...');
                
                // ä¿®æ”¹ä¸€ä¸ªç®€å•çš„å­—æ®µè¿›è¡Œæµ‹è¯•
                const updateData = {
                    work_start_time: '09:15', // ä¿®æ”¹ä¸Šç­æ—¶é—´
                    changeReason: 'æµ‹è¯•ä¿å­˜åŠŸèƒ½'
                };
                
                const response = await fetch(`${API_BASE}/api/v1/attendance/rules/eyewind`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': 'test-user',
                        'x-user-name': 'Test User'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                
                if (data.code === 0) {
                    addResult(`âœ… ä¿å­˜æˆåŠŸï¼æ–°ç‰ˆæœ¬: ${data.data.version}`, 'success');
                    addResult(`<pre>${JSON.stringify(data.data, null, 2)}</pre>`);
                } else {
                    addResult(`âŒ ä¿å­˜å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ ä¿å­˜è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testGetConfigAfterSave() {
            try {
                addResult('æ­£åœ¨é‡æ–°è·å–é…ç½®éªŒè¯ä¿å­˜ç»“æœ...');
                const response = await fetch(`${API_BASE}/api/v1/attendance/rules/eyewind?t=${Date.now()}`);
                const data = await response.json();
                
                if (data.code === 0) {
                    const newConfig = data.data;
                    addResult(`âœ… é‡æ–°è·å–æˆåŠŸï¼Œç‰ˆæœ¬: ${newConfig.version}`, 'success');
                    addResult(`ä¸Šç­æ—¶é—´: ${newConfig.work_start_time}`, newConfig.work_start_time === '09:15:00' ? 'success' : 'error');
                    
                    if (newConfig.work_start_time === '09:15:00') {
                        addResult('ğŸ‰ ä¿å­˜åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼', 'success');
                    } else {
                        addResult('âš ï¸ ä¿å­˜çš„æ•°æ®æ²¡æœ‰ç”Ÿæ•ˆ', 'error');
                    }
                } else {
                    addResult(`âŒ é‡æ–°è·å–å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>