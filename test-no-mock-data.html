<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§»é™¤Mockæ•°æ®å’Œç¼“å­˜é—®é¢˜ä¿®å¤æµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f8fafc;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .demo-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .before, .after {
            padding: 15px;
            border-radius: 8px;
        }
        .before {
            background: #fef2f2;
            border: 1px solid #fecaca;
        }
        .after {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }
        .log { 
            background: #f1f5f9; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #059669; }
        .info { color: #0284c7; }
        .warning { color: #d97706; }
        .error { color: #dc2626; }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
        button:hover {
            background: #f9fafb;
        }
        .error-display {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .empty-display {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç§»é™¤Mockæ•°æ®å’Œç¼“å­˜é—®é¢˜ä¿®å¤</h1>
        <p>ä¿®å¤è€ƒå‹¤ç¡®è®¤é¡µé¢çš„ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼šç¼“å­˜å¯¼è‡´ä¸é‡æ–°è¯·æ±‚ï¼Œä»¥åŠæ¥å£å¤±è´¥æ—¶ä½¿ç”¨mockæ•°æ®ã€‚</p>
        
        <div class="demo-section">
            <h3>é—®é¢˜åˆ†æ</h3>
            <div class="comparison">
                <div class="before">
                    <h4>ä¿®å¤å‰çš„é—®é¢˜ âŒ</h4>
                    <ul>
                        <li>æœ‰æœ¬åœ°ç¼“å­˜ï¼Œè¯·æ±‚è¿‡ä¸€æ¬¡å°±ä¸å†è¯·æ±‚</li>
                        <li>æ¥å£æ²¡æ•°æ®æ—¶ä½¿ç”¨mockæ•°æ®åº”ä»˜</li>
                        <li>æ¥å£æŠ¥é”™æ—¶ä¹Ÿä½¿ç”¨mockæ•°æ®</li>
                        <li>ç”¨æˆ·çœ‹ä¸åˆ°çœŸå®çš„é”™è¯¯çŠ¶æ€</li>
                        <li>æœˆä»½åˆ‡æ¢æ—¶å¯èƒ½ä¸ä¼šé‡æ–°è¯·æ±‚</li>
                    </ul>
                </div>
                <div class="after">
                    <h4>ä¿®å¤åçš„æ•ˆæœ âœ…</h4>
                    <ul>
                        <li>æ¸…é™¤ç¼“å­˜ï¼Œç¡®ä¿æ¯æ¬¡éƒ½é‡æ–°è¯·æ±‚</li>
                        <li>æ¥å£æ²¡æ•°æ®æ—¶æ˜¾ç¤ºçœŸå®çš„ç©ºçŠ¶æ€</li>
                        <li>æ¥å£æŠ¥é”™æ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å’Œé‡è¯•æŒ‰é’®</li>
                        <li>ç”¨æˆ·èƒ½çœ‹åˆ°çœŸå®çš„ç³»ç»ŸçŠ¶æ€</li>
                        <li>æœˆä»½åˆ‡æ¢æ—¶å¼ºåˆ¶é‡æ–°è¯·æ±‚</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="demo-section">
            <h3>ä¿®å¤å†…å®¹è¯¦è§£</h3>
            
            <h4>1. ç§»é™¤Mockæ•°æ®ä½¿ç”¨</h4>
            <div class="code-block">
// ä¿®å¤å‰ âŒ
if (!apiResponse.success || !apiResponse.data) {
    console.warn('[AttendancePage] APIè¿”å›æ— æ•ˆæ•°æ®ï¼Œä½¿ç”¨mockæ•°æ®');
    setSheets(db.getAttendanceSheets()); // ä½¿ç”¨mockæ•°æ®
}

// ä¿®å¤å âœ…
if (!apiResponse.success || !apiResponse.data) {
    console.warn('[AttendancePage] APIè¿”å›æ— æ•ˆæ•°æ®');
    setSheetsError(apiResponse.message || 'APIè¿”å›æ— æ•ˆæ•°æ®');
    setSheets([]); // ä¸ä½¿ç”¨mockæ•°æ®ï¼Œç›´æ¥è®¾ç½®ä¸ºç©º
}
            </div>
            
            <h4>2. é”™è¯¯å¤„ç†æ”¹è¿›</h4>
            <div class="code-block">
// ä¿®å¤å‰ âŒ
} catch (error) {
    setSheetsError(error.message);
    setSheets(db.getAttendanceSheets()); // ä½¿ç”¨mockæ•°æ®
}

// ä¿®å¤å âœ…
} catch (error) {
    setSheetsError(error.message);
    setSheets([]); // ä¸ä½¿ç”¨mockæ•°æ®ï¼Œè®©ç”¨æˆ·çœ‹åˆ°çœŸå®é”™è¯¯
}
            </div>
            
            <h4>3. ç¼“å­˜æ§åˆ¶</h4>
            <div class="code-block">
// ä¿®å¤å‰ âŒ
const response = await fetch(loadUrl);

// ä¿®å¤å âœ…
const response = await fetch(loadUrl, {
    method: 'GET',
    headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
    }
});
            </div>
            
            <h4>4. æœˆä»½å˜åŒ–æ—¶æ¸…é™¤ç¼“å­˜</h4>
            <div class="code-block">
// æ–°å¢é€»è¾‘ âœ…
useEffect(() => {
    if (hasInitializedRef.current && globalMonth) {
        SmartCache.remove(`ATTENDANCE_SHEETS_RAW`); // æ¸…é™¤ç¼“å­˜
        hasInitializedRef.current = false;
        loadData(); // é‡æ–°åŠ è½½
    }
}, [globalMonth, loadData]);
            </div>
        </div>

        <div class="demo-section">
            <h3>ç”¨æˆ·ç•Œé¢æ”¹è¿›</h3>
            
            <h4>é”™è¯¯çŠ¶æ€æ˜¾ç¤º</h4>
            <div class="error-display">
                <div style="color: #dc2626; font-size: 18px; font-weight: 500; margin-bottom: 8px;">âš ï¸ åŠ è½½å¤±è´¥</div>
                <div style="color: #6b7280; font-size: 14px; margin-bottom: 15px;">APIè¯·æ±‚å¤±è´¥: 500 Internal Server Error</div>
                <button style="background: #0ea5e9; color: white; border: none; padding: 8px 16px; border-radius: 6px;">é‡æ–°åŠ è½½</button>
            </div>
            
            <h4>ç©ºçŠ¶æ€æ˜¾ç¤º</h4>
            <div class="empty-display">
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“…</div>
                <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">2026å¹´1æœˆæš‚æ— è€ƒå‹¤æ•°æ®</div>
                <div style="color: #6b7280; font-size: 14px; margin-bottom: 15px;">é£çœ¼ç§‘æŠ€åœ¨2026å¹´1æœˆè¿˜æ²¡æœ‰è€ƒå‹¤ç¡®è®¤å•æ•°æ®ã€‚æ‚¨å¯ä»¥åˆ›å»ºæ–°çš„è€ƒå‹¤ç¡®è®¤å•æˆ–åˆ‡æ¢åˆ°å…¶ä»–æœˆä»½æŸ¥çœ‹ã€‚</div>
                <button style="background: #0ea5e9; color: white; border: none; padding: 8px 16px; border-radius: 6px;">åˆ›å»ºè€ƒå‹¤ç¡®è®¤å•</button>
            </div>
        </div>

        <div class="demo-section">
            <h3>æµ‹è¯•åœºæ™¯</h3>
            <button onclick="testNoCacheRequest()">æµ‹è¯•æ— ç¼“å­˜è¯·æ±‚</button>
            <button onclick="testErrorHandling()">æµ‹è¯•é”™è¯¯å¤„ç†</button>
            <button onclick="testEmptyData()">æµ‹è¯•ç©ºæ•°æ®å¤„ç†</button>
            <button onclick="testMonthChange()">æµ‹è¯•æœˆä»½åˆ‡æ¢</button>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div id="logs"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testNoCacheRequest() {
            log('å¼€å§‹æµ‹è¯•æ— ç¼“å­˜è¯·æ±‚...', 'info');
            
            // æ¨¡æ‹Ÿå¸¦ç¼“å­˜æ§åˆ¶çš„è¯·æ±‚
            const headers = {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            };
            
            log('è¯·æ±‚å¤´è®¾ç½®:', 'info');
            Object.entries(headers).forEach(([key, value]) => {
                log(`  ${key}: ${value}`, 'info');
            });
            
            try {
                const response = await fetch('/api/v1/attendance/status/load/2026-01', {
                    method: 'GET',
                    headers: headers
                });
                
                if (response.ok) {
                    log('âœ… æ— ç¼“å­˜è¯·æ±‚æˆåŠŸï¼Œæ¯æ¬¡éƒ½ä¼šé‡æ–°è¯·æ±‚', 'success');
                } else {
                    log(`âš ï¸ è¯·æ±‚è¿”å›çŠ¶æ€: ${response.status}`, 'warning');
                }
            } catch (error) {
                log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testErrorHandling() {
            log('å¼€å§‹æµ‹è¯•é”™è¯¯å¤„ç†é€»è¾‘...', 'info');
            
            // æ¨¡æ‹Ÿä¸åŒçš„é”™è¯¯åœºæ™¯
            const errorScenarios = [
                { type: 'APIå¤±è´¥', status: 500, message: 'Internal Server Error' },
                { type: 'æ— æ•ˆæ•°æ®', success: false, message: 'APIè¿”å›æ— æ•ˆæ•°æ®' },
                { type: 'ç½‘ç»œé”™è¯¯', error: 'Network Error' }
            ];
            
            errorScenarios.forEach(scenario => {
                log(`ğŸ”„ æµ‹è¯•åœºæ™¯: ${scenario.type}`, 'info');
                
                if (scenario.error) {
                    log(`âŒ æ•è·é”™è¯¯: ${scenario.error}`, 'error');
                    log('âœ… è®¾ç½®sheetsä¸ºç©ºæ•°ç»„ï¼Œä¸ä½¿ç”¨mockæ•°æ®', 'success');
                    log('âœ… æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å’Œé‡è¯•æŒ‰é’®', 'success');
                } else if (!scenario.success) {
                    log(`âš ï¸ APIè¿”å›å¤±è´¥: ${scenario.message}`, 'warning');
                    log('âœ… è®¾ç½®sheetsä¸ºç©ºæ•°ç»„ï¼Œä¸ä½¿ç”¨mockæ•°æ®', 'success');
                    log('âœ… æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯', 'success');
                } else {
                    log(`âŒ HTTPé”™è¯¯: ${scenario.status}`, 'error');
                    log('âœ… æŠ›å‡ºå¼‚å¸¸ï¼Œè¿›å…¥catchå¤„ç†', 'success');
                }
            });
            
            log('é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ', 'success');
        }

        function testEmptyData() {
            log('å¼€å§‹æµ‹è¯•ç©ºæ•°æ®å¤„ç†...', 'info');
            
            // æ¨¡æ‹Ÿç©ºæ•°æ®åœºæ™¯
            const emptyScenarios = [
                { desc: 'æ¥å£è¿”å›ç©ºæ•°æ®', data: {} },
                { desc: 'æ¥å£è¿”å›null', data: null },
                { desc: 'æ¥å£è¿”å›ç©ºæ•°ç»„', data: [] }
            ];
            
            emptyScenarios.forEach(({ desc, data }) => {
                log(`ğŸ”„ æµ‹è¯•åœºæ™¯: ${desc}`, 'info');
                
                if (!data || (Array.isArray(data) && data.length === 0) || Object.keys(data).length === 0) {
                    log('âœ… æ£€æµ‹åˆ°ç©ºæ•°æ®', 'success');
                    log('âœ… ä¸ä½¿ç”¨mockæ•°æ®å¡«å……', 'success');
                    log('âœ… æ˜¾ç¤ºçœŸå®çš„ç©ºçŠ¶æ€é¡µé¢', 'success');
                } else {
                    log('â„¹ï¸ æœ‰æ•°æ®ï¼Œæ­£å¸¸å¤„ç†', 'info');
                }
            });
            
            log('ç©ºæ•°æ®å¤„ç†æµ‹è¯•å®Œæˆ', 'success');
        }

        function testMonthChange() {
            log('å¼€å§‹æµ‹è¯•æœˆä»½åˆ‡æ¢é€»è¾‘...', 'info');
            
            // æ¨¡æ‹Ÿæœˆä»½åˆ‡æ¢
            const monthChanges = [
                { from: '2026-01', to: '2026-02' },
                { from: '2026-02', to: '2025-12' },
                { from: '2025-12', to: '2026-01' }
            ];
            
            monthChanges.forEach(({ from, to }) => {
                log(`ğŸ”„ æœˆä»½åˆ‡æ¢: ${from} -> ${to}`, 'info');
                log('âœ… æ¸…é™¤SmartCacheç¼“å­˜', 'success');
                log('âœ… é‡ç½®hasInitializedRefä¸ºfalse', 'success');
                log('âœ… è°ƒç”¨loadData()é‡æ–°åŠ è½½', 'success');
                log(`âœ… è¯·æ±‚æ–°URL: /api/v1/attendance/status/load/${to}`, 'success');
            });
            
            log('æœˆä»½åˆ‡æ¢æµ‹è¯•å®Œæˆ', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('Mockæ•°æ®ç§»é™¤å’Œç¼“å­˜ä¿®å¤æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'success');
            log('ä¸»è¦ä¿®å¤:', 'info');
            log('1. å®Œå…¨ç§»é™¤mockæ•°æ®çš„ä½¿ç”¨', 'info');
            log('2. æ·»åŠ ç¼“å­˜æ§åˆ¶å¤´ï¼Œç¡®ä¿æ¯æ¬¡é‡æ–°è¯·æ±‚', 'info');
            log('3. æœˆä»½åˆ‡æ¢æ—¶æ¸…é™¤ç¼“å­˜', 'info');
            log('4. ä¼˜å…ˆæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œæä¾›é‡è¯•åŠŸèƒ½', 'info');
            log('5. çœŸå®åæ˜ ç³»ç»ŸçŠ¶æ€ï¼Œä¸éšç’é”™è¯¯', 'info');
        };
    </script>
</body>
</html>