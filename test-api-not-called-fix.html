<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæœªè°ƒç”¨é—®é¢˜ä¿®å¤éªŒè¯</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f8fafc;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .problem-found {
            background: #fef2f2;
            border: 1px solid #f87171;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .fix-applied {
            background: #dcfce7;
            border: 1px solid #16a34a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .log { 
            background: #f1f5f9; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #059669; }
        .info { color: #0284c7; }
        .warning { color: #d97706; }
        .error { color: #dc2626; }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
        button:hover {
            background: #f9fafb;
        }
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” APIæœªè°ƒç”¨é—®é¢˜ä¿®å¤éªŒè¯</h1>
        
        <div class="problem-found">
            <h3>âŒ é—®é¢˜å‘ç°</h3>
            <p><strong>ç°è±¡ï¼š</strong>ç‚¹å‡»"è€ƒå‹¤ç¡®è®¤"åï¼Œé¡µé¢æ˜¾ç¤º"æ­£åœ¨åŠ è½½è€ƒå‹¤æ•°æ®..."ï¼Œä½†ç½‘ç»œé¢æ¿æ²¡æœ‰ä»»ä½•APIè¯·æ±‚</p>
            
            <h4>ğŸ” æ ¹æœ¬åŸå› ï¼š</h4>
            <p><strong>é€»è¾‘æ­»é”ï¼š</strong>useEffectå’ŒloadDataå‡½æ•°ä¹‹é—´çš„é€»è¾‘çŸ›ç›¾</p>
            <ol>
                <li>useEffectè®¾ç½® <code>hasInitializedRef.current = true</code></li>
                <li>ç„¶åè°ƒç”¨ <code>loadData()</code></li>
                <li>ä½†loadDataæ£€æŸ¥åˆ° <code>hasInitializedRef.current</code> ä¸ºtrueï¼Œç›´æ¥return</li>
                <li>ç»“æœï¼šä»€ä¹ˆéƒ½æ²¡æ‰§è¡Œï¼ŒAPIæ²¡æœ‰è¢«è°ƒç”¨</li>
            </ol>
        </div>
        
        <div class="fix-applied">
            <h3>âœ… ä¿®å¤æ–¹æ¡ˆ</h3>
            <p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong>ç§»é™¤loadDataå‡½æ•°ä¸­çš„é‡å¤è°ƒç”¨æ£€æŸ¥ï¼Œå°†é˜²é‡å¤é€»è¾‘å®Œå…¨äº¤ç»™useEffectå¤„ç†</p>
            
            <h4>ğŸ”§ ä¿®å¤å†…å®¹ï¼š</h4>
            <ol>
                <li><strong>ç§»é™¤loadDataä¸­çš„æ£€æŸ¥ï¼š</strong>ä¸å†åœ¨loadDataå‡½æ•°å†…éƒ¨æ£€æŸ¥hasInitializedRef</li>
                <li><strong>useEffectè´Ÿè´£é˜²é‡å¤ï¼š</strong>åªæœ‰useEffectè´Ÿè´£æ£€æŸ¥å’Œè®¾ç½®hasInitializedRef</li>
                <li><strong>ç®€åŒ–è°ƒç”¨é€»è¾‘ï¼š</strong>loadDataå‡½æ•°ä¸“æ³¨äºæ•°æ®åŠ è½½ï¼Œä¸ç®¡ç†çŠ¶æ€</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h3>ğŸ§ª ä¿®å¤éªŒè¯æµ‹è¯•</h3>
            <button onclick="testApiCalling()">æµ‹è¯•APIè°ƒç”¨</button>
            <button onclick="simulatePageLoad()">æ¨¡æ‹Ÿé¡µé¢åŠ è½½</button>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ ä¿®å¤å‰åå¯¹æ¯”</h3>
            
            <h4>ä¿®å¤å‰çš„é—®é¢˜ä»£ç ï¼š</h4>
            <div class="code-block">
// âŒ é—®é¢˜ä»£ç ï¼šé€»è¾‘æ­»é”
const loadData = useCallback(async () => {
    if (hasInitializedRef.current) {
        console.log('å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
        return; // ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œä»»ä½•é€»è¾‘
    }
    // ... å®é™…çš„åŠ è½½é€»è¾‘
}, []);

useEffect(() => {
    if (!hasInitializedRef.current) {
        hasInitializedRef.current = true; // è®¾ç½®ä¸ºtrue
        loadData(); // è°ƒç”¨loadDataï¼Œä½†loadDataçœ‹åˆ°trueå°±è¿”å›äº†
    }
}, []);
            </div>
            
            <h4>ä¿®å¤åçš„ä»£ç ï¼š</h4>
            <div class="code-block">
// âœ… ä¿®å¤ä»£ç ï¼šèŒè´£åˆ†ç¦»
const loadData = useCallback(async () => {
    // ç§»é™¤é‡å¤è°ƒç”¨æ£€æŸ¥ï¼Œä¸“æ³¨äºæ•°æ®åŠ è½½
    console.log('å¼€å§‹åŠ è½½æ•°æ®');
    setIsLoading(true);
    // ... å®é™…çš„åŠ è½½é€»è¾‘
}, []);

useEffect(() => {
    if (!hasInitializedRef.current) {
        hasInitializedRef.current = true; // useEffectè´Ÿè´£é˜²é‡å¤
        loadData(); // loadDataä¸“æ³¨äºåŠ è½½æ•°æ®
    }
}, []);
            </div>
        </div>
        
        <div id="logs"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testApiCalling() {
            log('ğŸ§ª å¼€å§‹æµ‹è¯•APIè°ƒç”¨...', 'info');
            
            try {
                // æµ‹è¯•å‘˜å·¥APIï¼ˆloadDataå‡½æ•°ä¼šè°ƒç”¨çš„ç¬¬ä¸€ä¸ªAPIï¼‰
                log('1. æµ‹è¯•å‘˜å·¥APIè°ƒç”¨...', 'info');
                const employeeResponse = await fetch('/api/v1/employees');
                if (employeeResponse.status === 404) {
                    log('â„¹ï¸ å‘˜å·¥APIè¿”å›404ï¼ˆå¯èƒ½æ˜¯è·¯å¾„é—®é¢˜ï¼Œä½†è‡³å°‘å‘èµ·äº†è¯·æ±‚ï¼‰', 'info');
                } else if (employeeResponse.ok) {
                    log('âœ… å‘˜å·¥APIè°ƒç”¨æˆåŠŸ', 'success');
                } else {
                    log(`âš ï¸ å‘˜å·¥APIè¿”å›çŠ¶æ€: ${employeeResponse.status}`, 'warning');
                }
                
                // æµ‹è¯•è€ƒå‹¤Load API
                log('2. æµ‹è¯•è€ƒå‹¤Load APIè°ƒç”¨...', 'info');
                const loadResponse = await fetch('/api/v1/attendance/status/load/2026-01');
                if (loadResponse.status === 404) {
                    log('âœ… Load APIè¿”å›404ï¼ˆæ­£å¸¸ï¼Œè¯´æ˜APIè¢«è°ƒç”¨äº†ï¼‰', 'success');
                } else if (loadResponse.ok) {
                    log('âœ… Load APIè°ƒç”¨æˆåŠŸ', 'success');
                } else {
                    log(`âš ï¸ Load APIè¿”å›çŠ¶æ€: ${loadResponse.status}`, 'warning');
                }
                
                log('ğŸ‰ APIè°ƒç”¨æµ‹è¯•å®Œæˆ - å…³é”®æ˜¯APIè¯·æ±‚è¢«å‘èµ·äº†', 'success');
                
            } catch (error) {
                log(`âŒ APIè°ƒç”¨æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        function simulatePageLoad() {
            log('ğŸ“± æ¨¡æ‹Ÿä¿®å¤åçš„é¡µé¢åŠ è½½è¿‡ç¨‹...', 'info');
            
            // æ¨¡æ‹Ÿç»„ä»¶çŠ¶æ€
            let hasInitialized = false;
            
            log('1. ç»„ä»¶æŒ‚è½½ï¼ŒuseEffectæ‰§è¡Œ', 'info');
            log(`   hasInitialized: ${hasInitialized}`, 'info');
            
            if (!hasInitialized) {
                hasInitialized = true;
                log('2. è®¾ç½®hasInitializedä¸ºtrue', 'info');
                log('3. è°ƒç”¨loadDataå‡½æ•°', 'info');
                log('4. loadDataå‡½æ•°å¼€å§‹æ‰§è¡Œï¼ˆä¸å†è¢«é˜»æ­¢ï¼‰', 'success');
                log('   - è®¾ç½®loadingçŠ¶æ€', 'info');
                log('   - è°ƒç”¨å‘˜å·¥API', 'info');
                log('   - è°ƒç”¨è€ƒå‹¤Load API', 'info');
                log('   - å¤„ç†å“åº”æ•°æ®', 'info');
                log('   - åœ¨finallyå—ä¸­è®¾ç½®loadingä¸ºfalse', 'info');
                log('âœ… é¡µé¢åŠ è½½æµç¨‹æ­£å¸¸ï¼ŒAPIä¼šè¢«è°ƒç”¨', 'success');
            } else {
                log('â„¹ï¸ å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡é‡å¤è°ƒç”¨', 'info');
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('APIæœªè°ƒç”¨é—®é¢˜ä¿®å¤éªŒè¯å·¥å…·åŠ è½½å®Œæˆ', 'success');
            log('', 'info');
            log('ğŸ¯ é—®é¢˜æ ¹æºåˆ†æ:', 'info');
            log('â€¢ useEffectè®¾ç½®hasInitializedRef=trueåè°ƒç”¨loadData', 'warning');
            log('â€¢ loadDataæ£€æŸ¥hasInitializedRef=trueå°±ç›´æ¥è¿”å›', 'warning');
            log('â€¢ å½¢æˆé€»è¾‘æ­»é”ï¼ŒAPIæ°¸è¿œä¸ä¼šè¢«è°ƒç”¨', 'error');
            log('', 'info');
            log('âœ… ä¿®å¤æ–¹æ¡ˆ:', 'info');
            log('â€¢ ç§»é™¤loadDataä¸­çš„é‡å¤è°ƒç”¨æ£€æŸ¥', 'success');
            log('â€¢ useEffectè´Ÿè´£é˜²é‡å¤ï¼ŒloadDataè´Ÿè´£åŠ è½½æ•°æ®', 'success');
            log('â€¢ èŒè´£åˆ†ç¦»ï¼Œé¿å…é€»è¾‘å†²çª', 'success');
            log('', 'info');
            log('ğŸ” ä¿®å¤åçš„é¢„æœŸæ•ˆæœ:', 'info');
            log('â€¢ ç‚¹å‡»è€ƒå‹¤ç¡®è®¤åï¼Œç½‘ç»œé¢æ¿ä¼šæ˜¾ç¤ºAPIè¯·æ±‚', 'success');
            log('â€¢ é¡µé¢ä¼šæ ¹æ®APIå“åº”æ˜¾ç¤ºç›¸åº”å†…å®¹', 'success');
            log('â€¢ ä¸å†å‡ºç°"ä¸€ç›´åŠ è½½ä½†æ²¡æœ‰APIè°ƒç”¨"çš„é—®é¢˜', 'success');
            log('', 'info');
            log('ç°åœ¨å¯ä»¥å¼€å§‹éªŒè¯ä¿®å¤æ•ˆæœ...', 'info');
        };
    </script>
</body>
</html>