<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€åŒ–ç‰ˆæœ¬æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; font-weight: bold; }
        .loading { background: #fff3cd; border: 2px solid #ffeaa7; color: #856404; }
        .success { background: #d4edda; border: 2px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 2px solid #f5c6cb; color: #721c24; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        .logs { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; }
    </style>
</head>
<body>
    <h1>ğŸ”§ AttendancePage ç®€åŒ–ç‰ˆæœ¬æµ‹è¯•</h1>
    
    <div id="status" class="status loading">
        ğŸ”„ å‡†å¤‡æµ‹è¯•...
    </div>
    
    <button onclick="testSimpleFlow()">ğŸš€ æµ‹è¯•ç®€åŒ–æµç¨‹</button>
    <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    
    <div id="logs" class="logs">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>

    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            const logMessage = `[${timestamp}] ${emoji} ${message}`;
            logs.push(logMessage);
            document.getElementById('logs').textContent = logs.join('\n');
            console.log(logMessage);
        }
        
        function updateStatus(message, type = 'loading') {
            const statusEl = document.getElementById('status');
            const emoji = type === 'loading' ? 'ğŸ”„' : type === 'success' ? 'âœ…' : 'âŒ';
            statusEl.textContent = `${emoji} ${message}`;
            statusEl.className = `status ${type}`;
        }
        
        function clearLogs() {
            logs = [];
            document.getElementById('logs').textContent = 'æ—¥å¿—å·²æ¸…ç©º...';
        }
        
        async function testSimpleFlow() {
            log('å¼€å§‹æµ‹è¯•ç®€åŒ–çš„AttendancePageæµç¨‹');
            updateStatus('æ­£åœ¨æµ‹è¯•APIè°ƒç”¨...', 'loading');
            
            try {
                // æ­¥éª¤1: æµ‹è¯•APIè°ƒç”¨
                log('æ­¥éª¤1: è°ƒç”¨ /api/v1/attendance/status/load');
                const response = await fetch('/api/v1/attendance/status/load');
                
                log(`APIå“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                // æ­¥éª¤2: è§£æå“åº”
                log('æ­¥éª¤2: è§£æAPIå“åº”');
                const apiResponse = await response.json();
                
                log(`å“åº”æ ¼å¼æ£€æŸ¥: success=${apiResponse.success}, data=${typeof apiResponse.data}`);
                
                if (!apiResponse.success || !apiResponse.data) {
                    throw new Error('APIè¿”å›æ— æ•ˆæ•°æ®');
                }
                
                // æ­¥éª¤3: å¤„ç†æ•°æ®
                log('æ­¥éª¤3: å¤„ç†è€ƒå‹¤æ•°æ®');
                const recordsByMonth = apiResponse.data;
                const months = Object.keys(recordsByMonth);
                
                log(`æ‰¾åˆ°æœˆä»½: ${months.join(', ')}`);
                
                let totalSheets = 0;
                let totalRecords = 0;
                
                for (const [month, records] of Object.entries(recordsByMonth)) {
                    if (Array.isArray(records) && records.length > 0) {
                        totalSheets++;
                        totalRecords += records.length;
                        log(`${month}: ${records.length} æ¡è®°å½•`);
                    }
                }
                
                // æ­¥éª¤4: æ¨¡æ‹ŸçŠ¶æ€æ›´æ–°
                log('æ­¥éª¤4: æ¨¡æ‹ŸReactçŠ¶æ€æ›´æ–°');
                log('è®¾ç½® isLoading = false');
                log('è®¾ç½® sheets = transformedSheets');
                
                // æ­¥éª¤5: æ¨¡æ‹Ÿæ¸²æŸ“æ£€æŸ¥
                log('æ­¥éª¤5: æ¨¡æ‹Ÿæ¸²æŸ“æ¡ä»¶æ£€æŸ¥');
                const mockState = {
                    view: 'dashboard',
                    isLoading: false,  // è¿™åº”è¯¥æ˜¯false
                    isRefreshing: false,
                    sheets: new Array(totalSheets).fill(null)
                };
                
                const shouldShowLoading = mockState.view === 'dashboard' && mockState.isLoading && !mockState.isRefreshing;
                log(`æ¸²æŸ“æ¡ä»¶: view=${mockState.view}, isLoading=${mockState.isLoading}, isRefreshing=${mockState.isRefreshing}`);
                log(`åº”è¯¥æ˜¾ç¤ºloading: ${shouldShowLoading}`);
                
                if (shouldShowLoading) {
                    updateStatus('âŒ æµ‹è¯•å¤±è´¥: ä»ç„¶ä¼šæ˜¾ç¤ºloadingçŠ¶æ€', 'error');
                    log('é—®é¢˜: isLoadingä»ç„¶ä¸ºtrueï¼Œä¼šç»§ç»­æ˜¾ç¤ºloading', 'error');
                } else {
                    updateStatus(`âœ… æµ‹è¯•æˆåŠŸ: æ‰¾åˆ° ${totalSheets} ä¸ªè€ƒå‹¤å•ï¼Œå…± ${totalRecords} æ¡è®°å½•`, 'success');
                    log(`æµ‹è¯•æˆåŠŸ: åº”è¯¥æ˜¾ç¤º ${totalSheets} ä¸ªè€ƒå‹¤å•`, 'success');
                }
                
            } catch (error) {
                log(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹æµ‹è¯•
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•');
            updateStatus('å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•', 'success');
        });
    </script>
</body>
</html>