<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒå‹¤ä»ªè¡¨ç›˜APIè°ƒç”¨ä¼˜åŒ–éªŒè¯</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f8fafc;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .problem-found {
            background: #fef2f2;
            border: 1px solid #f87171;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .fix-applied {
            background: #dcfce7;
            border: 1px solid #16a34a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .result { 
            margin-top: 10px; 
            padding: 15px; 
            background: #f1f5f9; 
            border-radius: 6px; 
            white-space: pre-wrap; 
            font-family: monospace; 
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { border-left: 4px solid #059669; }
        .error { border-left: 4px solid #dc2626; }
        .info { border-left: 4px solid #0284c7; }
        .warning { border-left: 4px solid #d97706; }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
        button:hover {
            background: #f9fafb;
        }
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .api-call-counter {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ è€ƒå‹¤ä»ªè¡¨ç›˜APIè°ƒç”¨ä¼˜åŒ–éªŒè¯</h1>
        
        <div class="problem-found">
            <h3>âŒ å‘ç°çš„é—®é¢˜</h3>
            <p><strong>ç°è±¡ï¼š</strong>è¿›å…¥è€ƒå‹¤ä»ªè¡¨ç›˜æ—¶å‡ºç°å¤§é‡é‡å¤çš„APIè°ƒç”¨</p>
            
            <h4>ğŸ” æ ¹æœ¬åŸå› ï¼š</h4>
            <ol>
                <li><strong>å¤šä¸ªuseEffectåŒæ—¶è§¦å‘</strong>ï¼šè§„åˆ™é…ç½®ã€æ•°æ®åŠ è½½ã€å‘˜å·¥åˆ—è¡¨ç­‰å¤šä¸ªuseEffectåŒæ—¶æ‰§è¡Œ</li>
                <li><strong>å¾ªç¯ä¾èµ–é—®é¢˜</strong>ï¼šloadAllDataå‡½æ•°çš„ä¾èµ–é¡¹å˜åŒ–å¯¼è‡´useEffecté‡å¤è§¦å‘</li>
                <li><strong>é‡å¤çš„æ•°æ®è·å–</strong>ï¼šloadAllDataå’ŒloadAllCompanyUserséƒ½è°ƒç”¨fetchCompanyData</li>
                <li><strong>ç¼ºå°‘é˜²é‡å¤æœºåˆ¶</strong>ï¼šæ²¡æœ‰åŠ è½½çŠ¶æ€æ§åˆ¶å’Œé˜²æŠ–æœºåˆ¶</li>
            </ol>
        </div>
        
        <div class="fix-applied">
            <h3>âœ… ä¿®å¤æ–¹æ¡ˆ</h3>
            <p><strong>ä¼˜åŒ–æ•°æ®åŠ è½½é€»è¾‘ï¼š</strong>å‡å°‘é‡å¤APIè°ƒç”¨ï¼Œæé«˜é¡µé¢åŠ è½½æ•ˆç‡</p>
            
            <h4>ğŸ”§ ä¿®å¤å†…å®¹ï¼š</h4>
            <ol>
                <li><strong>æ·»åŠ é˜²é‡å¤è°ƒç”¨æœºåˆ¶</strong>ï¼šæ£€æŸ¥isLoadingçŠ¶æ€ï¼Œé˜²æ­¢é‡å¤è°ƒç”¨</li>
                <li><strong>ä¼˜åŒ–useEffectä¾èµ–</strong>ï¼šç§»é™¤å¾ªç¯ä¾èµ–ï¼Œå‡å°‘ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“</li>
                <li><strong>åˆå¹¶æ•°æ®åŠ è½½é€»è¾‘</strong>ï¼šé¿å…å¤šä¸ªå‡½æ•°åŒæ—¶è°ƒç”¨ç›¸åŒçš„API</li>
                <li><strong>æ·»åŠ é˜²æŠ–æœºåˆ¶</strong>ï¼šä½¿ç”¨loadingDebounceçŠ¶æ€é˜²æ­¢å¿«é€Ÿé‡å¤è°ƒç”¨</li>
                <li><strong>æ”¹è¿›ç¼“å­˜ç­–ç•¥</strong>ï¼šä¼˜å…ˆä½¿ç”¨å·²åŠ è½½çš„æ•°æ®ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚</li>
                <li><strong>å¢å¼ºæ—¥å¿—è®°å½•</strong>ï¼šæ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥</li>
            </ol>
        </div>
        
        <div class="api-call-counter">
            <h4>ğŸ“Š APIè°ƒç”¨ç›‘æ§</h4>
            <p>ç›‘æ§é¡µé¢åŠ è½½è¿‡ç¨‹ä¸­çš„APIè°ƒç”¨æ¬¡æ•°</p>
            <div id="apiCallStats">
                <div>Token API: <span id="tokenCount">0</span> æ¬¡</div>
                <div>Employee API: <span id="employeeCount">0</span> æ¬¡</div>
                <div>Attendance API: <span id="attendanceCount">0</span> æ¬¡</div>
                <div>Process API: <span id="processCount">0</span> æ¬¡</div>
                <div>æ€»è®¡: <span id="totalCount">0</span> æ¬¡</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ§ª ä¼˜åŒ–æ•ˆæœéªŒè¯</h3>
            <button onclick="startMonitoring()">å¼€å§‹ç›‘æ§APIè°ƒç”¨</button>
            <button onclick="stopMonitoring()">åœæ­¢ç›‘æ§</button>
            <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
            <button onclick="simulatePageLoad()">æ¨¡æ‹Ÿé¡µé¢åŠ è½½</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ ä¿®å¤å‰åå¯¹æ¯”</h3>
            
            <h4>ä¿®å¤å‰çš„é—®é¢˜ï¼š</h4>
            <div class="code-block">
// âŒ é—®é¢˜ä»£ç ï¼šå¤šä¸ªuseEffectåŒæ—¶è§¦å‘
useEffect(() => { 
  if (ruleConfigLoaded) {
    loadAllData(); // ç¬¬ä¸€æ¬¡è°ƒç”¨
  }
}, [loadAllData, ruleConfigLoaded]); // å¾ªç¯ä¾èµ–

useEffect(() => {
  const loadAllCompanyUsers = async () => {
    // é‡å¤è°ƒç”¨fetchCompanyData
    const data = await fetchCompanyData('eyewind', ...);
    const data2 = await fetchCompanyData('hydodo', ...);
  };
  loadAllCompanyUsers();
}, [globalMonth]); // æœˆä»½å˜åŒ–æ—¶é‡å¤è°ƒç”¨
            </div>
            
            <h4>ä¿®å¤åçš„ä»£ç ï¼š</h4>
            <div class="code-block">
// âœ… ä¿®å¤ä»£ç ï¼šæ·»åŠ é˜²é‡å¤è°ƒç”¨æœºåˆ¶
const loadAllData = useCallback(async (forceRefresh = false, isSilent = false) => {
  // é˜²æ­¢é‡å¤è°ƒç”¨
  if (!isSilent && (isLoading || loadingDebounce)) {
    console.log('æ•°æ®æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
    return;
  }
  
  setLoadingDebounce(true);
  // ... æ•°æ®åŠ è½½é€»è¾‘
  setTimeout(() => setLoadingDebounce(false), 1000);
}, [globalMonth, currentCompany, isLoading, loadingDebounce]);

useEffect(() => { 
  if (ruleConfigLoaded && !isLoading) {
    loadAllData(); 
  }
}, [ruleConfigLoaded]); // ç§»é™¤å¾ªç¯ä¾èµ–
            </div>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        let isMonitoring = false;
        let apiCalls = {
            token: 0,
            employee: 0,
            attendance: 0,
            process: 0
        };
        
        // åŸå§‹fetchå‡½æ•°
        const originalFetch = window.fetch;
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        function updateApiCallStats() {
            document.getElementById('tokenCount').textContent = apiCalls.token;
            document.getElementById('employeeCount').textContent = apiCalls.employee;
            document.getElementById('attendanceCount').textContent = apiCalls.attendance;
            document.getElementById('processCount').textContent = apiCalls.process;
            document.getElementById('totalCount').textContent = 
                apiCalls.token + apiCalls.employee + apiCalls.attendance + apiCalls.process;
        }
        
        function startMonitoring() {
            if (isMonitoring) {
                log('âš ï¸ ç›‘æ§å·²åœ¨è¿è¡Œä¸­', 'warning');
                return;
            }
            
            isMonitoring = true;
            apiCalls = { token: 0, employee: 0, attendance: 0, process: 0 };
            updateApiCallStats();
            
            // æ‹¦æˆªfetchè¯·æ±‚
            window.fetch = function(...args) {
                const url = args[0];
                
                if (typeof url === 'string') {
                    if (url.includes('/api/v1/auth/token')) {
                        apiCalls.token++;
                        log(`ğŸ”‘ Token APIè°ƒç”¨: ${url}`, 'info');
                    } else if (url.includes('/api/v1/employees')) {
                        apiCalls.employee++;
                        log(`ğŸ‘¥ Employee APIè°ƒç”¨: ${url}`, 'info');
                    } else if (url.includes('/api/v1/attendance')) {
                        apiCalls.attendance++;
                        log(`ğŸ“Š Attendance APIè°ƒç”¨: ${url}`, 'info');
                    } else if (url.includes('/api/v1/process')) {
                        apiCalls.process++;
                        log(`ğŸ“‹ Process APIè°ƒç”¨: ${url}`, 'info');
                    }
                    
                    updateApiCallStats();
                }
                
                return originalFetch.apply(this, args);
            };
            
            log('ğŸš€ å¼€å§‹ç›‘æ§APIè°ƒç”¨...', 'success');
        }
        
        function stopMonitoring() {
            if (!isMonitoring) {
                log('âš ï¸ ç›‘æ§æœªåœ¨è¿è¡Œ', 'warning');
                return;
            }
            
            isMonitoring = false;
            window.fetch = originalFetch;
            
            const total = apiCalls.token + apiCalls.employee + apiCalls.attendance + apiCalls.process;
            log(`ğŸ ç›‘æ§å·²åœæ­¢`, 'success');
            log(`ğŸ“Š APIè°ƒç”¨ç»Ÿè®¡:`, 'info');
            log(`   Token API: ${apiCalls.token} æ¬¡`, 'info');
            log(`   Employee API: ${apiCalls.employee} æ¬¡`, 'info');
            log(`   Attendance API: ${apiCalls.attendance} æ¬¡`, 'info');
            log(`   Process API: ${apiCalls.process} æ¬¡`, 'info');
            log(`   æ€»è®¡: ${total} æ¬¡`, total > 10 ? 'error' : total > 5 ? 'warning' : 'success');
            
            if (total > 10) {
                log('âŒ APIè°ƒç”¨æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å­˜åœ¨é‡å¤è°ƒç”¨é—®é¢˜', 'error');
            } else if (total > 5) {
                log('âš ï¸ APIè°ƒç”¨æ¬¡æ•°è¾ƒå¤šï¼Œå»ºè®®è¿›ä¸€æ­¥ä¼˜åŒ–', 'warning');
            } else {
                log('âœ… APIè°ƒç”¨æ¬¡æ•°åˆç†', 'success');
            }
        }
        
        function simulatePageLoad() {
            log('ğŸ”„ æ¨¡æ‹Ÿé¡µé¢åŠ è½½è¿‡ç¨‹...', 'info');
            
            // æ¨¡æ‹Ÿä¼˜åŒ–å‰çš„å¤šæ¬¡APIè°ƒç”¨
            log('ä¿®å¤å‰çš„è°ƒç”¨æ¨¡å¼:', 'warning');
            log('1. è§„åˆ™é…ç½®useEffectè§¦å‘ â†’ loadAllData()', 'warning');
            log('2. å‘˜å·¥åˆ—è¡¨useEffectè§¦å‘ â†’ fetchCompanyData(eyewind)', 'warning');
            log('3. å‘˜å·¥åˆ—è¡¨useEffectè§¦å‘ â†’ fetchCompanyData(hydodo)', 'warning');
            log('4. globalMonthå˜åŒ– â†’ loadAllData()é‡æ–°åˆ›å»º â†’ å†æ¬¡è§¦å‘', 'warning');
            log('5. è€ƒå‹¤åœ°å›¾useEffectè§¦å‘ â†’ å¤„ç†æ•°æ®', 'warning');
            log('æ€»è®¡: å¯èƒ½äº§ç”Ÿ5-10æ¬¡é‡å¤çš„APIè°ƒç”¨', 'error');
            
            log('', 'info');
            
            // æ¨¡æ‹Ÿä¼˜åŒ–åçš„è°ƒç”¨æ¨¡å¼
            log('ä¿®å¤åçš„è°ƒç”¨æ¨¡å¼:', 'success');
            log('1. è§„åˆ™é…ç½®åŠ è½½å®Œæˆ â†’ æ£€æŸ¥!isLoading â†’ loadAllData()', 'success');
            log('2. é˜²é‡å¤è°ƒç”¨æœºåˆ¶ â†’ è·³è¿‡é‡å¤è°ƒç”¨', 'success');
            log('3. å‘˜å·¥åˆ—è¡¨å¤ç”¨å·²åŠ è½½æ•°æ® â†’ é¿å…é‡å¤APIè°ƒç”¨', 'success');
            log('4. é˜²æŠ–æœºåˆ¶ â†’ 1ç§’å†…é˜²æ­¢é‡å¤è°ƒç”¨', 'success');
            log('æ€»è®¡: åªäº§ç”Ÿ1-2æ¬¡å¿…è¦çš„APIè°ƒç”¨', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('è€ƒå‹¤ä»ªè¡¨ç›˜APIè°ƒç”¨ä¼˜åŒ–éªŒè¯å·¥å…·åŠ è½½å®Œæˆ', 'success');
            log('', 'info');
            log('ğŸ¯ ä¼˜åŒ–çš„æ ¸å¿ƒé—®é¢˜:', 'info');
            log('â€¢ å¤šä¸ªuseEffectåŒæ—¶è§¦å‘å¯¼è‡´é‡å¤APIè°ƒç”¨', 'warning');
            log('â€¢ å¾ªç¯ä¾èµ–å¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“', 'warning');
            log('â€¢ ç¼ºå°‘é˜²é‡å¤è°ƒç”¨æœºåˆ¶', 'warning');
            log('â€¢ å‘˜å·¥æ•°æ®é‡å¤è·å–', 'warning');
            log('', 'info');
            log('âœ… ä¼˜åŒ–æ–¹æ¡ˆ:', 'info');
            log('â€¢ æ·»åŠ é˜²é‡å¤è°ƒç”¨æœºåˆ¶', 'success');
            log('â€¢ ä¼˜åŒ–useEffectä¾èµ–å…³ç³»', 'success');
            log('â€¢ åˆå¹¶é‡å¤çš„æ•°æ®åŠ è½½é€»è¾‘', 'success');
            log('â€¢ æ·»åŠ é˜²æŠ–æœºåˆ¶', 'success');
            log('â€¢ æ”¹è¿›ç¼“å­˜ç­–ç•¥', 'success');
            log('', 'info');
            log('ğŸ” ä¼˜åŒ–åçš„é¢„æœŸæ•ˆæœ:', 'info');
            log('â€¢ APIè°ƒç”¨æ¬¡æ•°å¤§å¹…å‡å°‘ï¼ˆä»10+æ¬¡é™åˆ°2-3æ¬¡ï¼‰', 'success');
            log('â€¢ é¡µé¢åŠ è½½é€Ÿåº¦æå‡', 'success');
            log('â€¢ æœåŠ¡å™¨å‹åŠ›å‡è½»', 'success');
            log('â€¢ ç”¨æˆ·ä½“éªŒæ”¹å–„', 'success');
            log('', 'info');
            log('ç°åœ¨å¯ä»¥å¼€å§‹éªŒè¯ä¼˜åŒ–æ•ˆæœ...', 'info');
        };
    </script>
</body>
</html>