<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>考勤确认预览</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // 启用基于 class 的 Dark Mode
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            // 品牌主色调
            'primary': {
              '500': '#3b82f6', // sky-500
              '600': '#2563eb', // sky-600
            },
          }
        }
      }
    }
  </script>
  <style>
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-family: 'Inter', 'Helvetica Neue', 'Helvetica', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Arial', sans-serif;
    }

    .hidden {
      display: none;
    }

    /* 优化滚动条样式，使其在深色模式下不突兀 */
    #content-container::-webkit-scrollbar {
      width: 4px;
    }

    #content-container::-webkit-scrollbar-thumb {
      background-color: #475569;
      border-radius: 2px;
    }

    #content-container::-webkit-scrollbar-track {
      background-color: transparent;
    }

    /* 针对移动端隐藏滚动条，但允许滚动 */
    @media (max-width: 767px) {
      #content-container {
        -ms-overflow-style: none;
        /* IE and Edge */
        scrollbar-width: none;
        /* Firefox */
      }
    }

    .modal-enter {
        opacity: 0;
    }
    .modal-enter-active {
        opacity: 1;
        transition: opacity 200ms ease-in-out;
    }
    .modal-panel-enter {
        opacity: 0;
        transform: scale(0.95);
    }
    .modal-panel-enter-active {
        opacity: 1;
        transform: scale(1);
        transition: opacity 200ms, transform 200ms;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }

    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-in-out;
    }
    
    .collapsible-content.open {
      max-height: 1000px; /* A large enough value to not clip content */
    }

  </style>
</head>

<body
  class="bg-slate-50 dark:bg-slate-950 md:flex md:items-center md:justify-center min-h-screen md:p-4 transition-colors duration-300">
  
  <!-- Responsive Phone Mockup -->
  <div
    class="relative w-full max-w-md mx-auto md:w-[375px] md:h-[760px] bg-slate-100 dark:bg-slate-900 md:rounded-[40px] md:shadow-2xl md:p-2 md:border-2 md:border-slate-300 dark:md:border-slate-800 transition-colors duration-300">
    <!-- Phone physical buttons (desktop only) -->
    <div class="hidden md:block absolute -right-1 top-[180px] h-20 w-1.5 bg-slate-300 dark:bg-slate-700 rounded-r-md"></div>
    <div class="hidden md:block absolute -left-1 top-[120px] h-14 w-1.5 bg-slate-300 dark:bg-slate-700 rounded-l-md"></div>
    <div class="hidden md:block absolute -left-1 top-[180px] h-14 w-1.5 bg-slate-300 dark:bg-slate-700 rounded-l-md"></div>

    <div id="phone-content-wrapper"
      class="w-full h-screen md:h-full bg-slate-50 dark:bg-slate-900 md:rounded-[32px] flex flex-col overflow-hidden relative transition-colors duration-300">
      
      <!-- Loader is now inside the phone -->
      <div id="loader" class="flex flex-col items-center justify-center h-full text-slate-700 dark:text-slate-300 text-center p-8">
        <svg class="w-12 h-12 animate-spin text-primary-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
          fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
        </svg>
        <p class="mt-4">正在加载您的考勤数据...</p>
      </div>

      <!-- Main content is hidden by default -->
      <div id="main-container" class="hidden h-full w-full flex-col">
        <!-- Screen Header -->
        <div id="phone-header"
          class="flex-shrink-0 bg-white dark:bg-slate-900 z-10 transition-colors duration-300 shadow-sm dark:shadow-none">
          <div class="pt-2 px-2 hidden md:block">
            <div class="bg-slate-200 dark:bg-slate-950 w-20 h-4 rounded-full mx-auto"></div>
          </div>
          <div class="text-center py-3">
            <h4 id="sheet-title" class="font-bold text-lg text-slate-900 dark:text-white truncate px-4">考勤确认单</h4>
          </div>
        </div>

        <!-- Scrollable Content -->
        <div id="content-container" class="flex-1 overflow-y-auto px-4 space-y-4">
          <div id="banners-container" class="space-y-2 pt-2">
            <div id="auto-confirm-banner"
              class="hidden p-3 rounded-xl bg-rose-50 dark:bg-rose-900/60 text-rose-700 dark:text-rose-300 text-sm font-semibold items-center gap-2 border border-rose-200 dark:border-rose-900">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="flex-shrink-0">
                <path d="m3 11 18-5v12L3 14v-3z"></path>
                <path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"></path>
              </svg>
              <span id="auto-confirm-text"></span>
            </div>
            <div id="reminder-banner"
              class="hidden p-3 rounded-xl bg-amber-50 dark:bg-amber-900/60 text-amber-700 dark:text-amber-300 border border-amber-200 dark:border-amber-900">
              <p class="font-bold text-sm">温馨提示</p>
              <p id="reminder-text" class="text-xs mt-1"></p>
            </div>
          </div>

          <!-- Employee Info (to be injected) -->
          <div id="employee-info"
            class="flex items-center gap-4 z-30 sticky top-0 bg-slate-50 dark:bg-slate-900 py-4 -mx-4 px-4 border-b border-slate-100 dark:border-slate-800 transition-colors duration-300">
          </div>

          <!-- Summary Card (to be injected) -->
          <div id="summary-card"
            class="bg-white dark:bg-slate-800 rounded-xl shadow-md dark:shadow-none border border-slate-200 dark:border-slate-700 transition-colors duration-300">
            <button id="summary-toggle"
              class="sticky top-[80px] z-20 bg-inherit w-full flex justify-between items-center p-4 rounded-t-xl transition-colors duration-300">
              <h5 class="font-bold text-slate-900 dark:text-white">月度汇总</h5>
              <svg id="summary-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="w-5 h-5 text-slate-400 transition-transform duration-300">
                <path d="m18 15-6-6-6 6"></path>
              </svg>
            </button>
            <div id="summary-content" class="collapsible-content open">
                <div class="px-4 pb-4">
                  <div id="summary-grid" class="grid grid-cols-2 gap-x-4 gap-y-3"></div>
                  <div id="remarks-section" class="hidden mt-4 pt-3 border-t border-slate-200 dark:border-slate-700">
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">备注</p>
                    <p id="remarks-value" class="text-sm text-slate-800 dark:text-slate-200 whitespace-pre-wrap"></p>
                  </div>
                </div>
            </div>
          </div>

          <div id="daily-details-card"
            class="bg-white dark:bg-slate-800 rounded-xl shadow-md dark:shadow-none border border-slate-200 dark:border-slate-700 transition-colors duration-300">
            <button id="daily-details-toggle"
              class="sticky top-[80px] z-10 bg-inherit w-full flex justify-between items-center p-4 rounded-t-xl transition-colors duration-300">
              <h5 class="font-bold text-slate-900 dark:text-white">每日考勤详情</h5>
              <svg id="daily-details-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" class="w-5 h-5 text-slate-400 transition-transform duration-300 transform rotate-180">
                <path d="m18 15-6-6-6 6"></path>
              </svg>
            </button>
            <div id="daily-details-content" class="collapsible-content">
                <div class="px-4 pb-4 space-y-2"></div>
            </div>
          </div>

          <!-- Signature display (to be injected) -->
          <div id="signature-container"
            class="hidden bg-white dark:bg-slate-800 p-4 rounded-xl shadow-md dark:shadow-none border border-slate-200 dark:border-slate-700 transition-colors duration-300">
            <h5 class="font-bold text-slate-900 dark:text-white mb-2">我的签名</h5>
            <div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg border border-slate-300 dark:border-slate-600">
              <img id="signature-image" alt="签名" class="mx-auto" style="max-height: 80px;" />
            </div>
          </div>
          <div class="h-4"></div><!-- Bottom padding for last element -->
        </div>

        <!-- Sticky Footer Buttons -->
        <div class="p-4 bg-white dark:bg-slate-900 flex-shrink-0 z-10 border-t border-slate-100 dark:border-slate-800 transition-colors duration-300">
          <div id="action-buttons" class="flex items-center gap-3">
            <!-- Secondary Button (Feedback) -->
            <button id="feedback-button"
              class="hidden flex-1 py-3 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 border border-slate-300 dark:border-slate-600 rounded-xl text-base font-semibold transition-colors duration-150 hover:bg-slate-200 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-400">
              对考勤有疑问
            </button>
            <!-- Primary Button (Signature) -->
            <button id="signature-button"
              class="hidden flex-1 py-3 bg-primary-500 text-white rounded-xl text-base font-semibold items-center justify-center gap-2 transition-colors duration-150 hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-slate-900">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>
                <path d="m15 5 4 4"></path>
              </svg>
              签名确认
            </button>
            <!-- Primary Button (Confirm) -->
            <button id="confirm-button"
              class="hidden flex-1 py-3 bg-primary-500 text-white rounded-xl text-base font-semibold transition-colors duration-150 hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-slate-900">
              确认
            </button>
          </div>
          <div id="completed-state" class="hidden">
            <div
              class="w-full py-3 bg-green-600 text-white rounded-xl text-base font-semibold flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              已确认
            </div>
          </div>
        </div>

        <!-- Inner Modals -->
        <div id="feedback-modal" class="hidden modal-enter absolute inset-0 bg-black/70 dark:bg-black/80 flex items-center justify-center p-8 z-20">
          <div class="bg-white dark:bg-slate-800 p-6 rounded-xl text-center shadow-2xl w-full space-y-4 transition-colors duration-300 modal-panel-enter">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="w-12 h-12 text-primary-500 mx-auto">
              <path d="m3 11 18-5v12L3 14v-3z"></path>
              <path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"></path>
            </svg>
            <div>
              <h5 class="font-bold text-lg text-slate-900 dark:text-white">联系答疑员</h5>
              <p class="text-slate-600 dark:text-slate-300 mt-2 text-sm">
                如对考勤明细有疑问，请通过钉钉联系负责人 <strong id="feedback-contact-person"
                  class="text-slate-900 dark:text-slate-100"></strong> 进行沟通调整。
              </p>
            </div>
            <button id="feedback-close-button"
              class="w-full px-6 py-2 bg-primary-500 text-white rounded-xl text-base font-semibold transition-colors duration-150 hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-500/50">好的</button>
          </div>
        </div>

        <div id="signature-modal" class="hidden modal-enter absolute inset-0 bg-black/70 dark:bg-black/80 flex items-center justify-center p-4 z-40">
          <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-xl p-4 flex flex-col shadow-2xl space-y-3 transition-colors duration-300 modal-panel-enter">
            <h5 class="text-center font-bold text-slate-900 dark:text-white flex-shrink-0">请在此处签名</h5>
            <canvas id="signature-canvas"
              class="w-full aspect-[2/1] bg-white dark:bg-slate-900 rounded-lg border border-slate-300 dark:border-slate-600 cursor-crosshair shadow-inner"></canvas>
            <div class="flex justify-end gap-2">
              <button id="signature-cancel-button"
                class="px-4 py-2 text-sm text-slate-700 dark:text-slate-200 bg-slate-200 dark:bg-slate-600 rounded-lg transition-colors duration-150 hover:bg-slate-300 dark:hover:bg-slate-500">取消</button>
              <button id="signature-clear-button"
                class="px-4 py-2 text-sm text-slate-700 dark:text-slate-200 bg-slate-200 dark:bg-slate-600 rounded-lg transition-colors duration-150 hover:bg-slate-300 dark:hover:bg-slate-500">清除</button>
              <button id="signature-confirm-button"
                class="px-4 py-2 text-sm bg-primary-600 text-white rounded-lg transition-colors duration-150 hover:bg-primary-700">确认签名</button>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const loader = document.getElementById('loader');
      const mainContainer = document.getElementById('main-container');
      let pageData = null; // Will hold the fetched data { record, title, settings, user }

      // --- Theme Handling Logic ---
      function setTheme(theme) {
        const html = document.documentElement;
        if (theme === 'dark') {
          html.classList.add('dark');
        } else {
          html.classList.remove('dark');
        }
        // Immediately apply filter fix to any existing signature image
        const signatureImage = document.getElementById('signature-image');
        if (signatureImage) {
          signatureImage.style.filter = theme === 'dark' ? 'invert(1)' : 'none';
        }
      }

      function getSystemTheme() {
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      // Initial theme setup (runs before init)
      setTheme(getSystemTheme());

      // Listener for system preference changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        setTheme(e.matches ? 'dark' : 'light');
      });
      // --- End Theme Handling Logic ---

      function showError(message) {
        loader.innerHTML = `
          <div class="text-red-500 dark:text-red-400 p-4 bg-red-50 dark:bg-red-900/50 rounded-lg border border-red-200 dark:border-red-900 flex flex-col items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
            <p class="font-medium mt-3">${message}</p>
          </div>
        `;
      }

      async function init() {
        const params = new URLSearchParams(window.location.search);
        const userid = params.get('userid');

        if (!userid) {
          showError('错误：URL中缺少用户ID (userid)。');
          return;
        }

        try {
          // Implementing exponential backoff for the API call
          const MAX_RETRIES = 3;
          let apiResponse = null;

          for (let i = 0; i < MAX_RETRIES; i++) {
            try {
              const response = await fetch(`https://sg.api.eyewind.cn/etl/dingding/attendance/load/${userid}`);
              if (!response.ok) {
                // If response status is not 200-299, throw to trigger retry or final error
                throw new Error(`网络错误: ${response.status} ${response.statusText}`);
              }
              apiResponse = await response.json();
              break; // Success, break the loop
            } catch (error) {
              if (i === MAX_RETRIES - 1) {
                // Last retry failed
                throw error;
              }
              // Wait with exponential backoff before retrying
              const delay = Math.pow(2, i) * 1000;
              await new Promise(resolve => setTimeout(resolve, delay));
              console.warn(`Retry attempt ${i + 1} failed, retrying in ${delay / 1000}s...`);
            }
          }

          const data = apiResponse?.data?.[0] || {};

          if (!data.details) {
            throw new Error("API响应格式不正确或未找到您的考勤数据。");
          }

          pageData = data.details;

          loader.classList.add('hidden');
          mainContainer.classList.remove('hidden');
          mainContainer.classList.add('flex'); // Make it a flex container


          render(pageData, data.records);
          setupEventListeners(pageData, data.records);

          // Trigger view status update after 1 second
          if (!data.is_confirm) {
            setTimeout(() => {
              updateAttendanceStatus(pageData, data.records, data.is_confirm);
            }, 1000);
          }

        } catch (error) {
          console.error("加载数据失败:", error);
          showError(`加载数据失败: ${error.message || '未知错误'}`);
        }
      }

      function render(data, record) {
        const { title, settings, user } = data;

        document.getElementById('sheet-title').textContent = title || '考勤确认单';

        // Banners
        const autoConfirmBanner = document.getElementById('auto-confirm-banner');
        if (settings.autoConfirmEnabled && settings.autoConfirmDate) {
          autoConfirmBanner.classList.remove('hidden');
          autoConfirmBanner.classList.add('flex');
          // Format date/time
          const dateOptions = { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
          const formattedDate = new Date(settings.autoConfirmDate).toLocaleString('zh-CN', dateOptions);
          document.getElementById('auto-confirm-text').textContent = `${formattedDate} 后自动确认`;
        }
        const reminderBanner = document.getElementById('reminder-banner');
        if (settings.showReminder && settings.reminderText) {
          reminderBanner.classList.remove('hidden');
          document.getElementById('reminder-text').textContent = settings.reminderText;
        }

        // Employee Info
        const employeeInfoContainer = document.getElementById('employee-info');
        const name = user.name;
        let avatarHtml = '';
        const initial = name ? name.charAt(0).toUpperCase() : '?'; // 姓氏首字母

        if (user && user.avatar) {
          const blueHex = '3b82f6'; 
          avatarHtml = `<img src="${user.avatar}" alt="${name}" onerror="this.onerror=null;this.src='https://placehold.co/48x48/${blueHex}/ffffff?text=${initial}'" class="w-12 h-12 rounded-full object-cover flex-shrink-0 shadow-lg border-2 border-white dark:border-slate-800" />`;
        } else {
          const color = 'bg-sky-500'; 
          avatarHtml = `<div class="w-12 h-12 rounded-full flex items-center justify-center ${color} text-white font-bold text-xl flex-shrink-0 shadow-lg border-2 border-white dark:border-slate-800">${initial}</div>`;
        }
        employeeInfoContainer.innerHTML = `${avatarHtml}<div class="min-w-0"><p class="font-bold text-xl text-slate-900 dark:text-white truncate">${name}</p><p class="text-sm text-slate-500 dark:text-slate-400">${user.department.trim() || '考勤记录'}</p></div>`;

        // Summary and Daily Details
        const showColumns = settings.showColumns || [];
        const summaryFieldNames = ["正常出勤天数", "是否全勤", "豁免后迟到分钟数", "迟到分钟数", "早退分钟数", "旷工天数", "事假天数", "病假天数"];
        const remarksField = "备注";
        const dailyCols = [];
        const summaryCols = [];

        Object.keys(record?.dailyData || {}).forEach(col => {
          if (!showColumns.includes(col)) return;
          if (!isNaN(parseInt(col, 10)) && String(parseInt(col, 10)) === col && parseInt(col, 10) >= 1 && parseInt(col, 10) <= 31) dailyCols.push(col);
          else if (summaryFieldNames.includes(col)) summaryCols.push(col);
        });
        dailyCols.sort((a, b) => parseInt(a, 10) - parseInt(b, 10));

        const summaryGrid = document.getElementById('summary-grid');
        summaryGrid.innerHTML = '';
        summaryCols.forEach(col => {
          const value = record?.dailyData?.[col] || '-';
          let valueStyle = 'text-slate-700 dark:text-slate-100'; // Default style

          if ((col === "是否全勤" && value === "否") || ((col === "豁免后迟到分钟数" || col === "迟到分钟数") && parseFloat(value) > 0)) {
            valueStyle = 'text-red-500 dark:text-red-400';
          }
          summaryGrid.innerHTML += `<div><p class="text-xs text-slate-500 dark:text-slate-400">${col}</p><p class="font-semibold text-xl ${valueStyle}">${value}</p></div>`;
        });
        
        const remarksSection = document.getElementById('remarks-section');
        const remarksValue = record?.dailyData?.[remarksField];
        if (showColumns.includes(remarksField) && remarksValue) {
          remarksSection.classList.remove('hidden');
          document.getElementById('remarks-value').textContent = remarksValue;
        } else {
          remarksSection.classList.add('hidden');
        }

        const dailyContent = document.querySelector('#daily-details-content div');
        dailyContent.innerHTML = '';
        const dailyDetailsCard = document.getElementById('daily-details-card');
        if (dailyCols.length > 0) {
          dailyCols.forEach(col => {
            const value = record?.dailyData?.[col] || '-';
            const isNormal = value.includes('正常') || value === '-' || value === '√';
            const valueClass = isNormal ? 'text-slate-700 dark:text-slate-200' : 'text-slate-600 dark:text-slate-200 font-bold';
            dailyContent.innerHTML += `<div class="flex justify-between items-center border-b border-slate-100 dark:border-slate-700 py-2 last:border-0"><span class="text-slate-500 dark:text-slate-400">${col}号</span><span class="font-medium ${valueClass}">${value}</span></div>`;
          });
          dailyDetailsCard.classList.remove('hidden');
        } else {
          dailyDetailsCard.classList.add('hidden');
        }

        // Buttons and final state
        const isConfirmed = record?.confirmStatus === 'confirmed' || record?.confirmStatus === 'auto-confirmed' || record?.signatureBase64;
        const actionButtons = document.getElementById('action-buttons');
        const completedState = document.getElementById('completed-state');
        const signatureContainer = document.getElementById('signature-container');

        // Reset button visibility
        document.getElementById('feedback-button').classList.add('hidden');
        document.getElementById('signature-button').classList.add('hidden');
        document.getElementById('confirm-button').classList.add('hidden');

        if (isConfirmed) {
          actionButtons.classList.add('hidden');
          completedState.classList.remove('hidden');
          const completedText = document.querySelector('#completed-state div');
          if (completedText) completedText.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg> ${record.confirmStatus === 'auto-confirmed' ? '已自动确认' : '已确认'}`;

          if (record?.signatureBase64) {
            document.getElementById('signature-image').src = record?.signatureBase64;
            document.getElementById('signature-image').style.filter = document.documentElement.classList.contains('dark') ? 'invert(1)' : 'none';
            signatureContainer.classList.remove('hidden');
          }
        } else {
          actionButtons.classList.remove('hidden');
          completedState.classList.add('hidden');
          
          if (settings.feedbackEnabled) {
            document.getElementById('feedback-button').classList.remove('hidden');
            document.getElementById('feedback-contact-person').textContent = settings.feedbackContactPerson || '负责人';
          }
          
          if (settings.employeeSignature) {
            document.getElementById('signature-button').classList.remove('hidden');
            document.getElementById('signature-button').classList.add('flex');
          } else {
            document.getElementById('confirm-button').classList.remove('hidden');
          }
        }
      }

      let viewUpdateSent = false;
      async function updateAttendanceStatus(data, record, isConfirming = false, signatureBase64 = null) {
        if (!data || (!isConfirming && viewUpdateSent)) return;
        
        const { month, user, title, settings } = data;
        if (!user || !user.userid) return console.warn("无法更新状态：缺少钉钉用户数据 (userid)。");

        const updatedRecord = { ...record };
        if (isConfirming) {
            updatedRecord.confirmStatus = 'confirmed';
            updatedRecord.confirmed_at = new Date().toLocaleString();
            if (signatureBase64) updatedRecord.signatureBase64 = signatureBase64;
        } else {
            updatedRecord.viewStatus = 'viewed';
            updatedRecord.viewed_at = new Date().toLocaleString();
        }

        const updatedDetails = { title, month, settings, user };
        const payload = {
            userid: user.userid,
            unionid: user.unionid,
            name: user.name,
            dept_ids: JSON.stringify(user.dept_id_list),
            attd_month: month,
            is_send: true,
            is_view: true,
            is_confirm: isConfirming,
            details: JSON.stringify(updatedDetails),
            records: JSON.stringify(updatedRecord),
            signatureBase64: updatedRecord.signatureBase64 || null
        };
        
        try {
            const response = await fetch("https://sg.api.eyewind.cn/etl/dingding/attendance/upset", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: [payload] }),
            });
            if (!response.ok) throw new Error(`API 错误 ${response.status}`);
            console.log(`成功更新 ${user.name} 的状态。确认状态: ${isConfirming}`);
            if (!isConfirming) viewUpdateSent = true;
        } catch (error) {
            console.error("更新考勤状态失败:", error);
        }
      }

      function setupEventListeners(data, record) {
        // Collapsibles
        const setupCollapsible = (toggleId, contentId, iconId) => {
            const toggle = document.getElementById(toggleId);
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            toggle.addEventListener('click', () => {
                content.classList.toggle('open');
                icon.classList.toggle('rotate-180');
            });
        };
        setupCollapsible('summary-toggle', 'summary-content', 'summary-icon');
        setupCollapsible('daily-details-toggle', 'daily-details-content', 'daily-details-icon');

        // Modals
        const setupModal = (buttonId, modalId, closeButtonId) => {
            const modal = document.getElementById(modalId);
            const openBtn = document.getElementById(buttonId);
            const closeBtn = document.getElementById(closeButtonId);

            const open = () => {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.add('modal-enter-active');
                    modal.firstElementChild.classList.add('modal-panel-enter-active');
                }, 10);
            };
            const close = () => {
                modal.classList.remove('modal-enter-active');
                modal.firstElementChild.classList.remove('modal-panel-enter-active');
                setTimeout(() => modal.classList.add('hidden'), 200);
            };

            openBtn?.addEventListener('click', open);
            closeBtn?.addEventListener('click', close);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) close();
            });
        };
        setupModal('feedback-button', 'feedback-modal', 'feedback-close-button');
        setupModal('signature-button', 'signature-modal', 'signature-cancel-button');

        // Signature Pad Logic
        const canvas = document.getElementById('signature-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let isSigned = false;

        const getPos = (evt) => {
          const rect = canvas.getBoundingClientRect();
          const touch = evt.touches?.[0];
          return { x: (touch ? touch.clientX : evt.clientX) - rect.left, y: (touch ? touch.clientY : evt.clientY) - rect.top };
        };
        const startDrawing = (e) => {
          isDrawing = true;
          isSigned = true;
          const { x, y } = getPos(e);
          ctx.beginPath();
          ctx.moveTo(x, y);
        };
        const draw = (e) => {
          if (!isDrawing) return;
          e.preventDefault();
          const { x, y } = getPos(e);
          ctx.lineTo(x, y);
          ctx.stroke();
        };
        const stopDrawing = () => { isDrawing = false; ctx.closePath(); };

        ['mousedown', 'touchstart'].forEach(e => canvas.addEventListener(e, startDrawing, { passive: false }));
        ['mousemove', 'touchmove'].forEach(e => canvas.addEventListener(e, draw, { passive: false }));
        ['mouseup', 'mouseleave', 'touchend'].forEach(e => canvas.addEventListener(e, stopDrawing));

        document.getElementById('signature-clear-button').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            isSigned = false;
        });

        document.getElementById('signature-confirm-button').addEventListener('click', () => {
          if (!isSigned) return;

          const signatureDataUrl = canvas.toDataURL('image/png');
          const confirmButton = document.getElementById('signature-confirm-button');
          
          confirmButton.disabled = true;
          confirmButton.textContent = '正在上传...';

          updateAttendanceStatus(data, record, true, signatureDataUrl)
             .then(() => {
                data.record.confirmStatus = 'confirmed';
                data.record.signatureBase64 = signatureDataUrl;
                render(data, data.record); // Re-render to show confirmed state
                document.getElementById('signature-modal').click(); // Close modal
             })
             .finally(() => {
                confirmButton.disabled = false;
                confirmButton.textContent = '确认签名';
             });
        });
      }

      init();
    });
  </script>
</body>

</html>
